<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <?!= include('style'); ?>
  </head>
  <body>
    <div id="toast-container"></div>
    <div class="container">

      <div id="login-container">
         <form id="login-form" onsubmit="event.preventDefault(); handleLogin();">
             <div class="card">
              <h2>Kehadiran Guru, Staff & Admin</h2>
              <p>Silakan login untuk melanjutkan</p>
              <div class="input-group">
                <label for="email">Email</label>
                <input type="email" id="email" placeholder="Masukkan email Anda" autocomplete="username">
              </div>

              <div class="input-group">
                <label for="password">Password</label>
                <div class="password-wrapper">
                  <input type="password" id="password" placeholder="Masukkan password" autocomplete="current-password">
                  <i class="fa-solid fa-eye" id="togglePassword"></i>
                </div>
              </div>
              <button type="submit" id="login-button"><i class="fa-solid fa-right-to-bracket"></i> <span>Login</span></button>
              <p id="login-message" class="message"></p>
            </div>
         </form>
      </div>

      <div id="school-selection-container" style="display:none;">
         <div class="card">
          <h2>Pilih Sekolah</h2>
          <p>Anda terdaftar di beberapa sekolah. Silakan pilih sekolah untuk melanjutkan.</p>
          <div class="input-group">
            <label for="school-select">Sekolah</label>
            <select id="school-select"></select>
          </div>
          <button id="school-select-button" onclick="handleSchoolSelection()"><i class="fa-solid fa-arrow-right"></i> <span>Lanjutkan</span></button>
        </div>
      </div>

      <div id="guru-dashboard-container" style="display:none;">
        <div class="card">
          <h2 id="guru-welcome-message"></h2>

          <div id="announcement-section">
            <div id="announcement-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
              <h3 style="margin: 0;"><i class="fa-solid fa-bullhorn"></i> Pengumuman</h3>
              <button id="refresh-dashboard-button" onclick="forceUpdateSettings(event, this.id)" style="display:none; width: auto; padding: 8px 12px; font-size: 13px; font-weight: 600; background-color: #fff; color: var(--text-secondary-color); border: 1px solid var(--border-color); box-shadow: 0 1px 2px rgba(0,0,0,0.05);">
                <i class="fa-solid fa-rotate" style="margin-right: 6px;"></i>
                <span>Refresh</span>
              </button>
            </div>
            <p id="announcement-text" style="margin-bottom: 0;">Tidak ada pengumuman saat ini.</p>
          </div>

          <div id="geo-status-box" class="card-section processing">
            <div id="geo-status-header">
              <h3><i class="fa-solid fa-location-dot"></i> Status Lokasi</h3>
              <button id="refresh-geo-button" onclick="runDashboardGeoCheck()">
                <i class="fa-solid fa-rotate"></i>
                <span>Refresh</span>
              </button>
            </div>
            <h4 id="geo-status-message">Memuat...</h4>
            <p id="geo-status-details">Mencari pengaturan sekolah...</p>
          </div>

          <div id="summary-section">
              <div class="summary-title">
                  <h3>Ringkasan Bulanan</h3>
                  <input type="month" id="summary-month-input" onchange="handleSummaryMonthChange()">
              </div>
              <div class="summary-grid">
                  <div class="summary-item">
                      <span class="summary-value" id="summary-hari-kerja">...</span>
                      <span class="summary-label">Hari Kerja</span>
                  </div>
                  <div class="summary-item">
                      <span class="summary-value" id="summary-kehadiran">...</span>
                      <span class="summary-label">Hadir</span>
                  </div>
                  <div class="summary-item">
                      <span class="summary-value" id="summary-alpa">...</span>
                      <span class="summary-label">Alpa</span>
                  </div>
                  <div class="summary-item">
                      <span class="summary-value" id="summary-alasan">...</span>
                      <span class="summary-label">Hari Libur Sekolah</span>
                  </div>
                  <div class="summary-item">
                      <span class="summary-value" id="summary-persentase">...</span>
                      <span class="summary-label">Persentase</span>
                  </div>
                  <div class="summary-item">
                      <span class="summary-value" id="summary-ceklok">...</span>
                      <span class="summary-label">Ceklok</span>
                  </div>
              </div>
              <button onclick="showAllTeacherSummary()" id="view-all-summary-button" class="action-button secondary" style="margin-top: 15px;">
                <i class="fa-solid fa-users"></i> <span>Lihat Ringkasan Kehadiran Sekolah</span>
              </button>

              <h4 style="margin-top: 25px; margin-bottom: 15px; border-top: 1px solid var(--border-color); padding-top: 20px; text-align: left;">Kalender Visual</h4>
              
              <p id="calendar-loading-message" class="message" style="text-align: center; display: none;">Memuat kalender...</p>

              <div id="calendar-view-container">
                </div>
              
              <div id="calendar-legend" style="font-size: 12px; display: flex; flex-wrap: wrap; gap: 10px 15px; justify-content: center; margin-top: 15px; padding-top: 15px; border-top: 1px solid var(--border-color);">
                  <div style="display: flex; align-items: center; gap: 5px;"><span class="calendar-legend-box" style="background-color: var(--success-color);"></span> Hadir</div>
                  <div style="display: flex; align-items: center; gap: 5px;"><span class="calendar-legend-box" style="background-color: var(--danger-color);"></span> Alpa</div>
                  <div style="display: flex; align-items: center; gap: 5px;"><span class="calendar-legend-box" style="background-color: var(--warning-color);"></span> Tanpa Jadwal</div>
                  <div style="display: flex; align-items: center; gap: 5px;"><span class="calendar-legend-box" style="background-color: #BFDBFE; border-color: #93C5FD;"></span> Libur Nasional</div>
                  <div style="display: flex; align-items: center; gap: 5px;"><span class="calendar-legend-box" style="background-color: #E5E7EB; border-color: #D1D5DB;"></span> Hari Minggu</div>
              </div>
          </div>
          <hr style="margin: 25px 0;">

          <h3>Unduh Rekap</h3>
          <div class="input-group">
              <label for="guru-rekap-month">Pilih Bulan dan Tahun</label>
              <input type="month" id="guru-rekap-month">
          </div>

          <button onclick="handleGuruDownloadRekap()" id="guru-download-rekap-button" class="action-button">
              <i class="fa-solid fa-file-pdf"></i> <span>Buat & Unduh Rekap Saya</span>
          </button>
          <button onclick="handleGuruDownloadAllRekap()" id="guru-download-all-rekap-button" class="action-button secondary" style="margin-bottom: 0;">
              <i class="fa-solid fa-file-zipper"></i> <span>Unduh Rekap Semua Guru (Satu Sekolah)</span>
          </button>
          <p id="guru-rekap-message" class="message" style="margin-top: 5px; margin-bottom: 0;"></p>
          
          <hr style="margin: 0 0 25px 0;">

          <h3>MENU UTAMA</h3>
          <div class="dashboard-actions" style="margin-top: 10px;">
            <button id="ceklok-button" class="action-button" onclick="showCeklokPage()">
              <i class="fa-solid fa-calendar-check"></i> <span>Isi Ceklok Kehadiran</span>
            </button>

            <button id="lkh-sptjm-button" class="action-button" onclick="showLkhSptjmDashboard()" style="display:none;">
              <i class="fa-solid fa-file-signature"></i> <span>LKH dan SPTJM</span>
            </button>

            <button id="setting-libur-button" class="action-button secondary" onclick="showTeacherHolidaySettings()">
              <i class="fa-solid fa-gear"></i> <span>Setting Hari Libur Guru</span>
            </button>
          </div>

          <hr style="margin: 25px 0;">

          <div id="emis-section">
              <h3>EMIS</h3>
              <div class="dashboard-actions" style="margin-top: 10px;">
                  <button onclick="showEmisImportPage()" class="action-button">
                      <i class="fa-solid fa-file-import"></i> <span>Import</span>
                  </button>
                  <p style="text-align: left; font-size: 14px; margin-top: 5px; margin-bottom: 15px;">Klik untuk mengimpor data kehadiran dari file Excel EMIS.</p>

                  <button onclick="showEmisExportPage()" class="action-button secondary">
                      <i class="fa-solid fa-file-export"></i> <span>Eksport</span>
                  </button>
                  <p style="text-align: left; font-size: 14px; margin-top: 5px;">Klik untuk mengekspor data kehadiran bulanan ke format Excel.</p>
              </div>
          </div>

          <hr style="margin: 25px 0; border: none; border-top: 1px solid #E5E7EB;">

          <button class="logout" onclick="handleLogout()"><i class="fa-solid fa-right-from-bracket"></i> <span>Logout</span></button>
        </div>
      </div>

      <div id="all-teachers-summary-container" style="display:none;">
        <div class="card">
          <button class="back-button" onclick="goBackToDashboard()">&larr; Kembali ke Dasbor</button>
          <h2 style="margin-top: 15px;" id="all-teachers-summary-title">Ringkasan Kehadiran Sekolah</h2>

          <div class="input-group">
              <label for="all-teachers-summary-month-input">Pilih Bulan dan Tahun</label>
              <input type="month" id="all-teachers-summary-month-input" onchange="loadAllTeacherSummaryData()">
          </div>

          <button onclick="handleReloadAllTeacherSummary()" class="action-button secondary" style="width: auto; padding: 10px 18px; margin-bottom: 20px;">
            <i class="fa-solid fa-rotate-right"></i> <span>Muat Ulang Data</span>
          </button>
          <div id="all-teachers-summary-table-container">
            <p>Memuat ringkasan guru...</p>
          </div>

          <div id="summary-legend" style="margin-top: 20px; text-align: left; font-size: 14px;">
            </div>

        </div>
      </div>

      <div id="staff-dashboard-container" style="display:none;">
        <div class="card">
          <h2 id="staff-welcome-message"></h2>
          <div id="staff-announcement-section">
            <div id="staff-announcement-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
              <h3 style="margin: 0;"><i class="fa-solid fa-bullhorn"></i> Pengumuman</h3>
              <button id="refresh-staff-dashboard-button" onclick="forceUpdateSettings(event, this.id)" style="display:none; width: auto; padding: 8px 12px; font-size: 13px; font-weight: 600; background-color: #fff; color: var(--text-secondary-color); border: 1px solid var(--border-color); box-shadow: 0 1px 2px rgba(0,0,0,0.05);">
                <i class="fa-solid fa-rotate" style="margin-right: 6px;"></i>
                <span>Refresh</span>
              </button>
            </div>
            <p id="staff-announcement-text" style="margin-bottom: 0;">Tidak ada pengumuman saat ini.</p>
          </div>

          <div id="staff-summary-section">
              <div class="summary-title">
                  <h3>Ringkasan Bulanan Sekolah</h3>
                  <input type="month" id="staff-summary-month-input" onchange="loadStaffSummary()">
              </div>
              <div id="staff-summary-table-container">
                <p>Memuat ringkasan guru...</p>
              </div>
          </div>
          <hr style="margin: 25px 0;">

          <h3>Unduh Rekap</h3>
          <div class="input-group">
            <label for="staff-rekap-month">Pilih Bulan dan Tahun</label>
            <input type="month" id="staff-rekap-month">
          </div>
          <button onclick="handleStaffDownloadAllRekap()" id="staff-download-all-rekap-button" class="action-button">
              <i class="fa-solid fa-file-zipper"></i> <span>Unduh Rekap Semua Guru</span>
          </button>
          <p id="staff-rekap-all-message" class="message" style="margin-top: 5px;"></p>
          <hr style="margin: 25px 0;">

          <h3>CEKLOK</h3>
          <div class="input-group">
            <label for="staff-teacher-select-ceklok">Pilih Guru untuk Mengisi Ceklok</label>
            <select id="staff-teacher-select-ceklok">
              <option value="">-- Memuat Guru --</option>
            </select>
          </div>
          <div class="dashboard-actions" style="margin-top: 10px;">
            <button class="action-button" onclick="showCeklokPageForStaff()">
              <i class="fa-solid fa-calendar-check"></i> <span>Isi Ceklok Kehadiran</span>
            </button>

            <button id="view-requests-button" class="action-button warning" onclick="showChangeRequestPage()">
              <i class="fa-solid fa-file-circle-question"></i> <span>Pengajuan Ubah Data</span>
            </button>
            </div>
          <p id="staff-ceklok-message" class="message" style="margin-top: 5px;"></p>
          <hr style="margin: 25px 0;">

          <div id="staff-emis-section">
            <h3>EMIS</h3>
            <div class="input-group">
              <label for="staff-teacher-select-emis">Pilih Guru untuk Proses EMIS</label>
              <select id="staff-teacher-select-emis">
                <option value="">-- Memuat Guru --</option>
              </select>
            </div>
            <div class="dashboard-actions" style="margin-top: 10px;">
              <button onclick="showEmisImportPageForStaff()" class="action-button">
                <i class="fa-solid fa-file-import"></i> <span>Import</span>
              </button>
              <button onclick="showEmisExportPageForStaff()" class="action-button secondary">
                <i class="fa-solid fa-file-export"></i> <span>Eksport</span>
              </button>
            </div>
            <p id="staff-emis-message" class="message" style="margin-top: 5px;"></p>
          </div>
          <hr style="margin: 25px 0; border: none; border-top: 1px solid #E5E7EB;">
          <button class="logout" onclick="handleLogout()"><i class="fa-solid fa-right-from-bracket"></i> <span>Logout</span></button>
        </div>
      </div>

      <div id="ceklok-container" style="display:none;">
          <div class="card">
            <button class="back-button" onclick="goBackToDashboard()">&larr; Kembali ke Dasbor</button>
            <h2 style="margin-top: 15px;" id="ceklok-title">Formulir Kehadiran</h2>
            <h3 id="ceklok-teacher-name" style="margin-top: -10px; margin-bottom: 15px; font-weight: 500; color: var(--text-secondary-color);"></h3>
            <div id="global-lock-message" class="message" style="color: #b91c1c; margin-bottom: 15px;"></div>
            <div class="month-navigator">
              <button onclick="changeMonth(-1)">&#9664; Bulan Lalu</button>
              <h3 id="month-display"></h3>
              <button onclick="changeMonth(1)">Bulan Depan &#9654;</button>
            </div>
            <div id="attendance-table-container"></div>

            <p id="geo-lock-message" class="message" style="display:none; color: var(--danger-color); background-color: #FEF2F2; border-radius: 8px; padding: 10px 15px; margin-top: 15px;"></p>
            <button id="retry-geo-button" onclick="checkGeolocation()" class="action-button secondary" style="display:none; width: auto; padding: 10px 18px; margin-top: 10px;">
                <i class="fa-solid fa-location-crosshairs"></i> <span>Verifikasi Ulang Lokasi</span>
            </button>
            <button id="save-button" onclick="handleSave()" disabled><i class="fa-solid fa-floppy-disk"></i> <span>Simpan Semua Perubahan</span></button>
            <button id="request-change-button" onclick="handleRequestChange()" style="display: none;"><i class="fa-solid fa-paper-plane"></i> <span>Ajukan Perubahan</span></button>
            <div id="rejection-details-wrapper"></div>
            <p id="save-message" class="message"></p>
          </div>
      </div>

      <div id="teacher-holiday-settings-container" style="display:none;">
          <div class="card">
              <button class="back-button" onclick="goBackToDashboard()">&larr; Kembali ke Dasbor</button>
              <h2 style="margin-top: 15px;" id="teacher-holiday-title">Pengaturan Hari Libur Mengajar</h2>
              <p>Pilih hari di mana Anda tidak ada jadwal mengajar. Hari yang dipilih akan otomatis ditandai sebagai "Hari Libur Sekolah" pada halaman absensi.</p>
              <div id="holiday-switches-container">
              </div>
              <button id="save-teacher-holidays-button" onclick="handleSaveTeacherHolidays()"><i class="fa-solid fa-floppy-disk"></i> <span>Simpan Pengaturan</span></button>
              <p id="teacher-holidays-message" class="message"></p>
          </div>
      </div>

      <div id="emis-import-container" style="display:none;">
        <div class="card">
          <button class="back-button" onclick="goBackToDashboard()">&larr; Kembali ke Dasbor</button>
          <h2 style="margin-top: 15px;" id="emis-import-title">Import Data Kehadiran EMIS</h2>
          <h3 id="emis-import-teacher-name" style="margin-top: -10px; margin-bottom: 15px; font-weight: 500; color: var(--text-secondary-color);"></h3>
          <p>Pilih file Excel (.xlsx, .xls) yang berisi data kehadiran. Pastikan file adalah hasil download dari <strong>Aplikasi EMIS</strong>.</p>
          <div class="input-group">
            <label for="emis-file-input">Pilih File Excel</label>
            <input type="file" id="emis-file-input" accept=".xlsx, .xls" style="padding: 10px; height: auto;">
          </div>
          <button id="import-emis-button" onclick="handleEmisImport()"><i class="fa-solid fa-upload"></i> <span>Proses Import</span></button>
          <p id="emis-import-message" class="message"></p>
        </div>
      </div>

      <div id="emis-export-container" style="display:none;">
        <div class="card">
          <button class="back-button" onclick="goBackToDashboard()">&larr; Kembali ke Dasbor</button>
          <h2 style="margin-top: 15px;" id="emis-export-title">Eksport Data Kehadiran</h2>
          <h3 id="emis-export-teacher-name" style="margin-top: -10px; margin-bottom: 15px; font-weight: 500; color: var(--text-secondary-color);"></h3>
          <p>Fitur ini akan membuat file Excel (.xlsx) berisi data kehadiran Anda untuk bulan yang dipilih, lengkap dengan LOCK ID yang berurutan. Akan diupload ke <strong>Aplikasi EMIS</strong>.</p>
          <div class="input-group">
            <label for="emis-export-month">Pilih Bulan dan Tahun</label>
            <input type="month" id="emis-export-month">
          </div>
          <div class="input-group">
            <label for="lock-id-input">Masukkan LOCK ID Awal</label>
            <input type="number" id="lock-id-input" placeholder="Contoh: 303290459">
          </div>
          <button id="export-emis-button" onclick="handleEmisExport()"><i class="fa-solid fa-download"></i> <span>Download Template</span></button>
          <p id="emis-export-message" class="message"></p>
        </div>
      </div>

      <div id="admin-container" style="display:none;">
          <div class="card">
              <h2 id="admin-welcome-message"></h2>
              <div class="nav-tabs">
                  <div class="nav-tab active" onclick="openTab(event, 'kelola-akun')">Kelola Akun</div>
                  <div class="nav-tab" onclick="openTab(event, 'pengaturan')">Pengaturan</div>
              </div>

              <div id="kelola-akun" class="tab-content active">
                  <h3>Daftar Akun</h3>
                  <button onclick="openUserForm()"><i class="fa-solid fa-plus"></i> <span>Tambah Akun Baru</span></button>
                  <div id="user-table-container" style="margin-top: 15px;"></div>
              </div>

              <div id="pengaturan" class="tab-content">
                  <h3>Pengumuman untuk Guru & Staff</h3>
                  <div class="input-group">
                    <label for="announcement-input">Tulis pengumuman di sini. Akan tampil di dasbor semua guru dan staff.</label>
                    <textarea id="announcement-input" rows="4"></textarea>
                    <button onclick="saveAnnouncementsSettings()" style="width: auto; margin-top: 10px;"><i class="fa-solid fa-floppy-disk"></i> <span>Simpan Pengumuman</span></button>
                    <p id="announcements-message" class="message"></p>
                  </div>
                  <hr style="margin: 25px 0;">

                  <h3>Kunci Absensi</h3>
                  <div class="input-group">
                      <label for="locked-months">Kunci Bulan Berjalan (opsional, format: YYYY-MM)</label>
                      <input type="text" id="locked-months" placeholder="Contoh: 2024-10 (jika ingin mengunci Oktober)">
                      <p style="font-size: 12px; margin-top: 5px; color: var(--text-secondary-color);">Hanya masukkan bulan berjalan jika ingin mengunci pengisian absensi di bulan tersebut.</p>
                      <button onclick="saveLockedMonthsSettings()" style="width: auto; margin-top: 10px;"><i class="fa-solid fa-floppy-disk"></i> <span>Simpan Bulan Terkunci</span></button>
                      <p id="locked-months-message" class="message"></p>
                  </div>

                  <div class="input-group">
                      <label for="opened-months">Buka Kunci Bulan Lalu (format: YYYY-MM, pisahkan koma)</label>
                      <input type="text" id="opened-months" placeholder="Contoh: 2024-09,2024-08">
                       <p style="font-size: 12px; margin-top: 5px; color: var(--text-secondary-color);">Masukkan bulan-bulan lalu yang ingin dibuka kembali agar bisa diedit oleh semua guru.</p>
                      <button onclick="saveOpenedMonthsSettings()" style="width: auto; margin-top: 10px;"><i class="fa-solid fa-floppy-disk"></i> <span>Simpan Bulan Dibuka</span></button>
                      <p id="opened-months-message" class="message"></p>
                  </div>

                  <hr style="margin: 25px 0;">
                  <h3>Pengajuan Ubah Data</h3>
                  <div class="input-group">
                      <label for="request-day-limit">Batas Tanggal Pengajuan Perubahan (Setelah Bulan Terkunci)</label>
                      <input type="number" id="request-day-limit" placeholder="Contoh: 10" min="0" max="31">
                      <p style="font-size: 12px; margin-top: 5px; color: var(--text-secondary-color);">Guru dapat mengajukan perubahan data untuk bulan lalu hingga tanggal ini di bulan berjalan.</p>
                      <button onclick="saveRequestDayLimitSettings()" style="width: auto; margin-top: 10px;"><i class="fa-solid fa-floppy-disk"></i> <span>Simpan Batas Tanggal</span></button>
                      <p id="request-day-limit-message" class="message"></p>
                  </div>

                  <hr style="margin: 25px 0;">
                  <h3>Batas Waktu Pengisian Ceklok</h3>
                  
                  <div class="input-group">
                      <label for="last-month-ceklok-day-limit">Batas Tanggal Pengisian Bulan Lalu (Grace Period)</label>
                      <input type="number" id="last-month-ceklok-day-limit" placeholder="Contoh: 5" min="0" max="31">
                      <p style="font-size: 12px; margin-top: 5px; color: var(--text-secondary-color);">Guru dapat mengisi ceklok untuk bulan lalu hingga tanggal ini di bulan berjalan (Default: 5).</p>
                      <button onclick="saveLastMonthCeklokLimit()" style="width: auto; margin-top: 10px;"><i class="fa-solid fa-floppy-disk"></i> <span>Simpan Batas Hari</span></button>
                      <p id="last-month-ceklok-message" class="message"></p>
                  </div>

                  <hr style="margin: 25px 0;">
                  <h3>Batas Waktu Pengisian LKH</h3>
                  
                  <div class="input-group">
                      <label for="lkh-last-day-limit">Batas Tanggal Pengisian LKH Bulan Lalu (Grace Period)</label>
                      <input type="number" id="lkh-last-day-limit" placeholder="Contoh: 5" min="0" max="31">
                      <p style="font-size: 12px; margin-top: 5px; color: var(--text-secondary-color);">
                        Guru dapat mengisi LKH bulan lalu hingga tanggal ini di bulan berjalan (Default: 5).
                        <br><strong>Isi 0</strong> jika LKH bulan lalu harus dikunci langsung mulai tanggal 1.
                        <br>Pengaturan ini <strong>TIDAK</strong> mempengaruhi LKH bulan berjalan (bulan berjalan selalu bisa diisi).
                      </p>
                      <button onclick="saveLkhLastDayLimit()" style="width: auto; margin-top: 10px;"><i class="fa-solid fa-floppy-disk"></i> <span>Simpan Batas Hari LKH</span></button>
                      <p id="lkh-last-day-message" class="message"></p>
                  </div>

                  <hr style="margin: 25px 0;">
                  <h3>Hari Libur Nasional</h3>
                  <div id="holidays-container"></div>
                  <button onclick="addHolidayRow()" style="width: auto;"><i class="fa-solid fa-plus"></i> <span>Tambah Hari Libur</span></button>
                  <button onclick="saveHolidaysSettings()" style="width: auto; margin-top: 20px;"><i class="fa-solid fa-floppy-disk"></i> <span>Simpan Semua Hari Libur</span></button>
                  <p id="holidays-message" class="message"></p>

                  <hr style="margin: 25px 0;">
                  <h3>Pengaturan Jam Reguler</h3>
                  <p style="font-size: 14px; margin-top: -10px; color: var(--text-secondary-color);">
                    Atur jam masuk dan pulang reguler untuk 6 hari kerja. Ini akan menjadi acuan untuk perhitungan "Telat/Cepat" dan "Pulang Cepat" pada rekap detail harian.
                  </p>
                  <div id="jam-reguler-container">
                    </div>
                  <button onclick="handleSaveJamReguler()" id="save-jam-reguler-button" style="width: auto; margin-top: 20px;">
                    <i class="fa-solid fa-floppy-disk"></i> <span>Simpan Jam Reguler</span>
                  </button>
                  <p id="jam-reguler-message" class="message"></p>

                  <hr style="margin: 25px 0;">
                  <h3>Unduh Rekap Kehadiran</h3>
                  <div class="input-group">
                      <label for="rekap-school">Pilih Sekolah</label>
                      <select id="rekap-school">
                          <option value="">-- Memuat Daftar Sekolah --</option>
                      </select>
                  </div>
                  <div class="input-group">
                      <label for="rekap-month">Pilih Bulan dan Tahun</label>
                      <input type="month" id="rekap-month">
                  </div>
                  <button onclick="handleDownloadRekap()" id="download-rekap-button" style="width: auto; margin-top: 10px;">
                      <i class="fa-solid fa-file-pdf"></i> <span>Buat Rekap & Unduh</span>
                  </button>
                  <p id="rekap-message" class="message"></p>
                  </div>

              <button class="logout" onclick="handleLogout()"><i class="fa-solid fa-right-from-bracket"></i> <span>Logout</span></button>
          </div>
      </div>

      <?!= include('sptjm_view'); ?>
      <?!= include('lkh_sptjm'); ?>
      <?!= include('sptjm_settings'); ?>
      <?!= include('lkh'); ?>
      <?!= include('lkh_view'); ?>
      <?!= include('lkh_weekly'); ?>

      <div id="change-request-container" style="display:none;">
        <div class="card">
          <button class="back-button" onclick="goBackToDashboard()">&larr; Kembali ke Dasbor</button>
          <h2 style="margin-top: 15px;">Daftar Pengajuan Perubahan Ceklok</h2>
          <p>Tinjau pengajuan perubahan data dari guru untuk bulan lalu yang terkunci.</p>

          <div id="request-list-container">
            </div>
          <p id="request-list-message" class="message" style="margin-top: 15px;"></p>

        </div>
      </div>
      <footer class="main-footer">
        <a href="https://wa.me/qr/FMVS3NLDIRUAA1" target="_blank" rel="noopener noreferrer">
          <p>&copy; <span id="currentYear"></span> Created by Syamsul Bahri</p>
        </a>
      </footer>
      </div>

    <div id="user-form-modal" class="modal">
      <div class="modal-content">
        <span class="close-btn" onclick="closeUserForm()">&times;</span>
        <h3 id="form-title">Tambah Akun Baru</h3>
        <input type="hidden" id="original-email">
        <div class="input-group"> <label for="user-email">Email</label> <input type="email" id="user-email"> </div>
        <div class="input-group"> <label for="user-password">Password</label> <input type="text" id="user-password"> </div>
        <div class="input-group"> <label for="user-name">Nama Lengkap</label> <input type="text" id="user-name"> </div>
        <div class="input-group"> <label for="user-school">Sekolah (pisahkan dengan koma jika lebih dari satu)</label> <input type="text" id="user-school"> </div>
        <div class="input-group"> <label for="user-role">Peran</label> <select id="user-role"><option value="guru">Guru</option><option value="staff">Staff</option><option value="admin">Admin</option></select> </div>
        <button onclick="handleUserSave()"><i class="fa-solid fa-floppy-disk"></i> <span>Simpan</span></button>
        <p id="user-form-message" class="message"></p>
      </div>
    </div>

    <div id="school-switcher-modal" class="modal">
      <div class="modal-content">
        <span class="close-btn" onclick="closeSchoolSwitcherModal()">&times;</span>
        <h3 style="margin-top:0;">Pilih Sekolah</h3>
        <div id="school-list-container">
        </div>
      </div>
    </div>

    <div id="rejection-modal" class="modal">
      <div class="modal-content">
        <span class="close-btn" onclick="closeRejectionModal()">&times;</span>
        <h3 style="margin-top:0;">Alasan Penolakan</h3>
        <p>Silakan tulis alasan mengapa pengajuan ini ditolak.</p>
        <input type="hidden" id="rejection-request-ids">
        <div class="input-group">
          <label for="rejection-reason-input">Alasan</label>
          <textarea id="rejection-reason-input" rows="4" placeholder="Contoh: Jam pulang tidak sesuai dengan jadwal."></textarea>
        </div>
        <button onclick="handleSendRejection()" class="action-button reject-btn"><i class="fa-solid fa-paper-plane"></i> <span>Kirim Penolakan</span></button>
      </div>
    </div>

    <div id="cancel-request-modal" class="modal confirmation-modal">
      <div class="modal-content">
        <span class="close-btn" onclick="closeCancelRequestModal()">&times;</span>
        <h3>Konfirmasi Pembatalan</h3>
        <p>Apakah Anda yakin ingin membatalkan semua pengajuan perubahan yang sedang ditinjau untuk bulan ini?</p>
        <div class="modal-actions">
           <button class="cancel-btn" onclick="closeCancelRequestModal()">Tutup</button>
           <button class="confirm-btn danger" onclick="confirmCancelRequest()">Ya, Batalkan Ajuan</button>
        </div>
      </div>
    </div>

    <div id="approve-request-modal" class="modal confirmation-modal">
      <div class="modal-content">
        <span class="close-btn" onclick="closeApproveRequestModal()">&times;</span>
        <h3>Konfirmasi Persetujuan</h3>
        <p>Apakah Anda yakin ingin menyetujui <strong id="approve-count">0</strong> perubahan ini? Tindakan ini akan langsung mengubah data absensi guru.</p>
        <input type="hidden" id="approve-request-ids">
        <div class="modal-actions">
           <button class="cancel-btn" onclick="closeApproveRequestModal()">Tutup</button>
           <button class="confirm-btn" onclick="confirmApproveRequest()">Ya, Setujui</button>
        </div>
      </div>
    </div>

    <div id="clear-lkh-modal" class="modal confirmation-modal">
      <div class="modal-content">
        <span class="close-btn" onclick="closeClearLkhModal()">&times;</span>
        <h3>Konfirmasi Pembersihan</h3>
        <p>Apakah Anda yakin ingin membersihkan semua isian LKH di halaman ini? Tindakan ini tidak dapat dibatalkan.</p>
        <div class="modal-actions">
            <button class="cancel-btn" onclick="closeClearLkhModal()">Batal</button>
            <button class="confirm-btn danger" onclick="confirmClearLkhData()">Ya, Bersihkan Data</button>
        </div>
      </div>
    </div>

    <script>
      // ===================================================================
      // VARIABEL GLOBAL & FUNGSI UTILITAS
      // ===================================================================
      let currentUser = null;
      let selectedSchool = null;
      let currentDate = new Date();

      // --- AWAL MODIFIKASI: appSettings ---
      let appSettings = {
        // lockedMonths: [], // Tidak perlu lagi di sisi client
        openedMonths: [], // Tambahkan ini
        holidays: {},
        // announcements: "", // --> KITA PINDAHKAN KE CACHE
        teacherHolidays: [],
        isMonthLocked: true, // Tambahkan boolean ini
        isRequestableMonth: false,
        // --- AWAL PERUBAHAN ---
        requestDayLimit: 10, // <-- TAMBAHKAN BARIS INI (Default value)
        // --- AKHIR PERUBAHAN ---
        pendingChanges: {},
        rejectionInfo: null,
        rejectedChanges: [],
        hasGeoBypass: false, // <-- TAMBAHKAN INI
        lastMonthCeklokDayLimit: 5,
        lkhLastDayLimit: 5 // <-- BARIS BARU
      };
      // --- AKHIR MODIFIKASI ---

      let selectedTeacherForStaff = null;
      let schoolTeachers = [];
      let latestRequestToken = 0;
      const SPREADSHEET_ID = "1EIQY1DeGcwhEaYojbGMah-S5HbtsrON5YRy37bl_vLg";

      // Variabel global untuk melacak toast "processing"
      let processingToastId = null;

      // --- TAMBAHKAN VARIABEL BARU INI ---
      let dashboardTimestamp = '0'; // Melacak "versi" data yang sedang tampil
      // --- AKHIR TAMBAHAN ---

      // ===================================================================
      // 1. TAMBAHKAN VARIABEL GLOBAL BARU INI
      // ===================================================================
      let currentSchoolSettings = {};
      let isUserInLocation = false;
      let settingsPollInterval = null;

      let currentSummary = null;

      // --- AWAL TAMBAHAN BARU (CACHE PENGUMUMAN) ---
      let cachedAnnouncements = null; // Cache untuk teks pengumuman
      let currentAnnouncementTimestamp = '0'; // Timestamp pengumuman yang sedang tampil
      // --- AKHIR TAMBAHAN BARU ---

      // --- TAMBAHAN BARU: Fungsi untuk membuat toast swipeable ---
      function makeToastDismissable(toast) {
        let isDragging = false, startX = 0;
        let toastWidth = 0;
        let animationFrameId = null;

        // Helper untuk menghapus toast
        const removeToast = (direction = 'right') => {
          if (toast.autoDismissTimer) clearTimeout(toast.autoDismissTimer); // Batalkan timer otomatis
          toast.style.transition = 'transform 0.3s ease-out, opacity 0.3s ease-out';
          toast.style.opacity = '0';
          toast.style.transform = `translateX(${direction === 'left' ? '-100%' : '100%'})`;
          
          // --- AWAL PERUBAHAN ---
          // Cek apakah toast yang dihapus ini adalah toast processing yang aktif
          // Jika ya, bersihkan ID globalnya agar toast sukses/gagal berikutnya
          // tahu bahwa ia harus membuat elemen baru.
          if (toast.id && toast.id === processingToastId) {
            processingToastId = null;
          }
          // --- AKHIR PERUBAHAN ---

          // Hapus elemen dari DOM setelah animasi selesai
          setTimeout(() => toast.remove(), 300);
        };

        const onDragStart = (e) => {
          isDragging = true;
          // Dapatkan posisi awal sentuhan atau klik mouse
          startX = e.type === 'touchstart' ? e.touches[0].clientX : e.clientX;
          toastWidth = toast.offsetWidth;
          toast.style.transition = 'none'; // Matikan transisi agar bisa di-drag
          toast.classList.add('is-grabbing');
          
          // Batalkan timer otomatis saat mulai menggeser
          if (toast.autoDismissTimer) clearTimeout(toast.autoDismissTimer);
          if (animationFrameId) cancelAnimationFrame(animationFrameId);
        };

        const onDragMove = (e) => {
          if (!isDragging) return;
          // Mencegah scroll di ponsel saat menggeser toast
          e.preventDefault();
          
          const currentX = e.type === 'touchmove' ? e.touches[0].clientX : e.clientX;
          const deltaX = currentX - startX;
          
          // Gunakan requestAnimationFrame agar animasi geser lebih mulus
          animationFrameId = requestAnimationFrame(() => {
            toast.style.transform = `translateX(${deltaX}px)`;
          });
        };

        const onDragEnd = (e) => {
          if (!isDragging) return;
          isDragging = false;
          toast.classList.remove('is-grabbing');
          if (animationFrameId) cancelAnimationFrame(animationFrameId);
          
          // Dapatkan posisi akhir geseran
          const currentX = e.type === 'touchend' ? e.changedTouches[0].clientX : e.clientX;
          const deltaX = (currentX || startX) - startX;
          const swipeThreshold = toastWidth * 0.4; // Minimal geser 40%

          // Jika digeser cukup jauh, hapus toast
          if (Math.abs(deltaX) > swipeThreshold) {
            removeToast(deltaX > 0 ? 'right' : 'left');
          } 
          // Jika tidak, kembalikan ke posisi semula
          else {
            toast.style.transition = 'transform 0.3s ease';
            toast.style.transform = 'translateX(0px)';
            
            // Set ulang timer otomatis (HANYA jika bukan toast "processing")
            if (!toast.classList.contains('processing')) {
              toast.autoDismissTimer = setTimeout(() => {
                toast.classList.add('toast-fade-out');
                setTimeout(() => toast.remove(), 400); // Set ulang timer ke 4 detik
              }, 4000);
            }
          }
          
          // Hapus listener global agar tidak menumpuk
          document.removeEventListener('mousemove', onDragMove);
          document.removeEventListener('mouseup', onDragEnd);
          document.removeEventListener('touchmove', onDragMove);
          document.removeEventListener('touchend', onDragEnd);
        };

        // Pasang listener awal (mousedown untuk desktop)
        toast.addEventListener('mousedown', (e) => {
          onDragStart(e);
          // Pasang listener global HANYA saat mouse ditekan
          document.addEventListener('mousemove', onDragMove);
          document.addEventListener('mouseup', onDragEnd);
        });
        
        // Pasang listener awal (touchstart untuk mobile)
        toast.addEventListener('touchstart', (e) => {
          onDragStart(e);
          // Pasang listener global HANYA saat disentuh
          document.addEventListener('touchmove', onDragMove, { passive: false });
          document.addEventListener('touchend', onDragEnd);
        }, { passive: true });
      }
      // --- AKHIR FUNGSI BARU ---

      // --- FUNGSI displayMessage SEKARANG DIPERBARUI ---
      function displayMessage(elementId, text, options = {}) {
        // elementId sekarang diabaikan, kita gunakan global toast container
        const { isSuccess = false, isProcessing = false } = options;
        const toastContainer = document.getElementById('toast-container');
        if (!toastContainer) return; // Keluar jika container tidak ada
        
        // === AWAL PERBAIKAN ===
        // 1. Cek jika 'text' kosong DAN ini BUKAN pesan 'processing'
        if (!text && !isProcessing) {
          // Jika ada toast "processing" yang aktif, hapus itu.
          if (processingToastId) {
            const processingToast = document.getElementById(processingToastId);
            if (processingToast) {
              // Hapus dengan animasi fade out (animasi ini sudah ada di CSS Anda)
              processingToast.classList.add('toast-fade-out');
              // Hapus dari DOM setelah animasi
              setTimeout(() => processingToast.remove(), 400); 
            }
            processingToastId = null; // Kosongkan ID pelacak
          }
          return; // Hentikan fungsi di sini. Tidak perlu membuat toast baru.
        }
        // === AKHIR PERBAIKAN ===
        
        // 1. Tentukan status (class) dan ikon
        let statusClass = '';
        let iconHtml = '';
        
        if (isProcessing) {
          statusClass = 'processing';
          iconHtml = '<div class="toast-loader"></div>'; // Spinner
        } else if (isSuccess) {
          statusClass = 'success';
          iconHtml = '<i class="fa-solid fa-circle-check"></i>';
        } else {
          // Default adalah error (merah)
          statusClass = 'error';
          iconHtml = '<i class="fa-solid fa-circle-exclamation"></i>';
        }

        // 2. Jika ini pesan "processing" BARU
        if (isProcessing) {
          // Hapus dulu toast processing lama jika ada
          if (processingToastId) {
            const oldToast = document.getElementById(processingToastId);
            if (oldToast) {
              // Langsung ganti teksnya jika sudah ada
              oldToast.querySelector('span').textContent = text;
              return; // Tidak perlu buat toast baru
            }
          }
          
          // Buat toast processing baru
          const toast = document.createElement('div');
          processingToastId = 'toast-' + new Date().getTime(); // Buat ID unik
          toast.id = processingToastId;
          toast.className = `toast-message ${statusClass}`;
          toast.innerHTML = `${iconHtml} <span>${text}</span>`;
          toastContainer.appendChild(toast);
          
          makeToastDismissable(toast); // Buat toast "processing" bisa di-swipe
        } 
        // 3. Jika ini pesan "success" atau "error"
        else {
          // Cek apakah ada toast processing yang aktif
          if (processingToastId) {
            // Jika ada, GANTI toast processing itu
            const processingToast = document.getElementById(processingToastId);
            if (processingToast) {
              processingToast.className = `toast-message ${statusClass}`;
              processingToast.innerHTML = `${iconHtml} <span>${text}</span>`;
              processingToast.id = '';
              
              // Set timeout untuk menghilangkannya
              const newTimer = setTimeout(() => {
                processingToast.classList.add('toast-fade-out');
                setTimeout(() => processingToast.remove(), 400); // 0.4s (sesuai transisi CSS)
              }, 4000); // 4 detik
              processingToast.autoDismissTimer = newTimer; // Simpan timer di elemen
              
              processingToastId = null; // Kosongkan pelacak
              
              makeToastDismissable(processingToast); // Buat toast yang baru diganti ini bisa di-swipe
            }
          } else {
            // Jika tidak ada toast processing, buat toast baru
            const toast = document.createElement('div');
            toast.className = `toast-message ${statusClass}`;
            toast.innerHTML = `${iconHtml} <span>${text}</span>`;
            toastContainer.appendChild(toast);
            
            // Set timeout untuk menghilangkannya
            const newTimer = setTimeout(() => {
              toast.classList.add('toast-fade-out');
              setTimeout(() => toast.remove(), 400);
            }, 4000); // 4 detik
            toast.autoDismissTimer = newTimer; // Simpan timer di elemen

            makeToastDismissable(toast); // Buat toast baru ini bisa di-swipe
          }
        }
      }

      // --- TAMBAHAN BARU: Helper JS untuk format tanggal ---
      function jsFormatDate(dateObj) {
          const year = dateObj.getFullYear();
          const month = String(dateObj.getMonth() + 1).padStart(2, '0');
          const day = String(dateObj.getDate()).padStart(2, '0');
          return `${year}-${month}-${day}`;
      }

      // ===================================================================
      // FUNGSI HELPER BARU UNTUK NAVIGASI & POPSTATE
      // ===================================================================

      /**
       * (BARU) Menyembunyikan semua kontainer halaman utama.
       */
      function hideAllContainers_() {
        document.getElementById("login-container").style.display = "none";
        document.getElementById("school-selection-container").style.display = "none";
        document.getElementById("guru-dashboard-container").style.display = "none";
        document.getElementById("staff-dashboard-container").style.display = "none";
        document.getElementById("ceklok-container").style.display = "none";
        document.getElementById("admin-container").style.display = "none";
        document.getElementById("teacher-holiday-settings-container").style.display = "none";
        document.getElementById("emis-import-container").style.display = "none";
        document.getElementById("emis-export-container").style.display = "none";
        document.getElementById("lkh-sptjm-dashboard-container").style.display = "none";
        document.getElementById("sptjm-settings-container").style.display = "none";
        document.getElementById("sptjm-view-container").style.display = "none";
        document.getElementById("lkh-container").style.display = "none";
        document.getElementById("lkh-view-container").style.display = "none";
        document.getElementById("lkh-weekly-container").style.display = "none";
        document.getElementById("all-teachers-summary-container").style.display = "none";
        document.getElementById("change-request-container").style.display = "none";
      }

      /**
       * (BARU) Menampilkan dashboard yang sesuai berdasarkan peran pengguna.
       * @param {boolean} isLogin - Jika true, gunakan replaceState.
       */
      function showDashboardBasedOnRole_(isLogin = false) {
        if (!currentUser) return;
        
        hideAllContainers_();

        // Tampilkan container yang benar
        if (currentUser.role === 'admin') {
          document.getElementById("admin-container").style.display = "block";
          // Panggil fungsi pemuatan data untuk dashboard
          loadUsers();
          loadAdminSettings();
          loadSchoolDropdown();
        } else if (currentUser.role === 'staff') {
          document.getElementById("staff-dashboard-container").style.display = "block";
          // Panggil fungsi pemuatan data untuk dashboard
          showStaffDashboard(currentUser, isLogin); // Panggil fungsi asli untuk data
        } else {
          document.getElementById("guru-dashboard-container").style.display = "block";
          // Panggil fungsi pemuatan data untuk dashboard
          showGuruDashboard(currentUser, isLogin); // Panggil fungsi asli untuk data
        }

        // Hanya 'replaceState' saat login. 'pushState' tidak diperlukan
        // karena ini adalah halaman root state.
        if (isLogin) {
          history.replaceState({ page: 'dashboard' }, 'Dashboard', '#dashboard');
        }
      }

      /**
       * (BARU) Dipanggil oleh 'popstate' untuk merender halaman dari history.
       * @param {string} pageName - Nama state halaman (cth: 'ceklok', 'lkh-sptjm').
       */
      function showPageFromState_(pageName) {
        // Panggil fungsi 'show' yang sesuai, tetapi *tanpa*
        // mem-push state baru ke history (argumen 'push' = false).
        switch(pageName) {
          case 'dashboard':
            showDashboardBasedOnRole_(false);
            break;
          case 'school-select':
            showSchoolSelection(currentUser.schools, false);
            break;
          case 'ceklok':
            showCeklokPage(false);
            break;
          case 'teacher-holiday':
            showTeacherHolidaySettings(false);
            break;
          case 'emis-import':
            showEmisImportPage(false);
            break;
          case 'emis-export':
            showEmisExportPage(false);
            break;
          case 'all-summary':
            showAllTeacherSummary(false);
            break;
          case 'lkh-sptjm':
            showLkhSptjmDashboard(false);
            break;
          case 'sptjm-settings':
            showSptjmSettingsPage(false);
            break;
          case 'sptjm-view':
            showSptjmViewPage(false);
            break;
          case 'lkh-weekly':
            showLkhWeeklyPage(false);
            break;
          case 'lkh-page':
            showLkhPage(false);
            break;
          case 'lkh-view':
            showLkhViewPage(false);
            break;
          case 'ceklok-staff':
            showCeklokPageForStaff(true, false); // forceReload=true, push=false
            break;
          case 'emis-import-staff':
            showEmisImportPageForStaff(false);
            break;
          case 'emis-export-staff':
            showEmisExportPageForStaff(false);
            break;
          case 'change-request':
            showChangeRequestPage(false);
            break;
          default:
            // Fallback jika state tidak dikenal, kembali ke dashboard
            showDashboardBasedOnRole_(false);
        }
      }

      function showSptjmSettingsPage(push = true) {
          hideAllContainers_(); // (PERUBAHAN)
          document.getElementById('sptjm-settings-container').style.display = 'block';

          // --- TAMBAHKAN BARIS INI ---
          if (push) {
            history.pushState({ page: 'sptjm-settings' }, 'Pengaturan SPTJM', '#sptjm-settings');
          }

          const saveButton = document.getElementById('save-sptjm-settings-button');
          saveButton.disabled = true; // Nonaktifkan tombol saat halaman dibuka

          // --- AWAL PERUBAHAN ---
          // 1. Tampilkan pesan memuat
          displayMessage('sptjm-settings-message', 'Memuat pengaturan...', { isProcessing: true });

          // 2. Dapatkan semua input di dalam container
          const container = document.getElementById('sptjm-settings-container');
          // (Memilih input berdasarkan tipe agar lebih spesifik)
          const inputs = container.querySelectorAll('input[type="text"], input[type="date"]');

          // 3. Nonaktifkan semua input
          inputs.forEach(input => input.disabled = true);
          // --- AKHIR PERUBAHAN ---

          google.script.run
            .withSuccessHandler(settings => {
              if (settings) {
                document.getElementById('sptjm-nip').value = settings.nip || '';
                document.getElementById('sptjm-jabatan').value = settings.jabatan || '';
                // document.getElementById('sptjm-bulan').value = settings.bulan || '';
                document.getElementById('sptjm-tempat').value = settings.tempat || '';
                document.getElementById('sptjm-tanggal').value = settings.tanggal || '';
                document.getElementById('sptjm-nama-kepala').value = settings.namaKepala || '';
                document.getElementById('sptjm-nip-kepala').value = settings.nipKepala || '';
              }
              saveButton.disabled = false; // Aktifkan tombol setelah data dimuat
              
              // --- AWAL PERUBAHAN ---
              // 4. Aktifkan kembali semua input
              inputs.forEach(input => input.disabled = false);
              // 5. Tampilkan pesan sukses
              displayMessage('sptjm-settings-message', 'Pengaturan cetak berhasil dimuat.', { isSuccess: true });
              // --- AKHIR PERUBAHAN ---
            })
            .withFailureHandler(error => {
                displayMessage('sptjm-settings-message', error.message);
                console.error('Error saat memuat pengaturan:', error);
                // Tombol tetap nonaktif jika gagal

                // --- AWAL PERUBAHAN ---
                // 6. Aktifkan kembali input jika gagal agar tidak terkunci
                inputs.forEach(input => input.disabled = false);
                // --- AKHIR PERUBAHAN ---
            })
            .getSptjmSettings(currentUser.email);
      }

      function handleSaveSptjmSettings() {
        const settings = {
          // Properti yang sudah dihapus tidak lagi dibaca
          nip: document.getElementById('sptjm-nip').value,
          jabatan: document.getElementById('sptjm-jabatan').value,
          // bulan: document.getElementById('sptjm-bulan').value,
          tempat: document.getElementById('sptjm-tempat').value,
          tanggal: document.getElementById('sptjm-tanggal').value,
          namaKepala: document.getElementById('sptjm-nama-kepala').value,
          nipKepala: document.getElementById('sptjm-nip-kepala').value
        };

        displayMessage('sptjm-settings-message', 'Menyimpan...', { isProcessing: true });

        google.script.run.withSuccessHandler(response => {
          if (response.status === 'success') {
            displayMessage('sptjm-settings-message', response.message, { isSuccess: true });
            setTimeout(showLkhSptjmDashboard, 2000); // Kembali ke dasbor LKH setelah 2 detik
          } else {
            displayMessage('sptjm-settings-message', response.message);
          }
        }).saveSptjmSettings(currentUser.email, settings);
      }

      // --- FUNGSI BARU UNTUK FORMAT DAFTAR ---
      /**
       * (BARU) Mengubah array string menjadi daftar yang diformat dengan "dan".
       * Contoh: ["A"] -> "<strong>A</strong>"
       * Contoh: ["A", "B"] -> "<strong>A</strong> dan <strong>B</strong>"
       * Contoh: ["A", "B", "C"] -> "<strong>A</strong>, <strong>B</strong>, dan <strong>C</strong>"
       */
      function formatMissingList(missingArray) {
        if (!missingArray || missingArray.length === 0) {
          return "";
        }

        // 1. Tambahkan tag <strong> ke setiap item
        const boldedItems = missingArray.map(item => `<strong>${item}</strong>`);
        
        // 2. Terapkan logika "dan"
        if (boldedItems.length === 1) {
          return boldedItems[0];
        }
        if (boldedItems.length === 2) {
          return boldedItems.join(' dan ');
        }
        // Jika lebih dari 2
        const lastItem = boldedItems[boldedItems.length - 1];
        const otherItems = boldedItems.slice(0, -1).join(', ');
        return `${otherItems}, dan ${lastItem}`;
      }

      /**
       * (FUNGSI LAMA - TIDAK BERUBAH)
       * Mengecek kelengkapan pengaturan khusus untuk LKH.
       */
      function areLkhSettingsComplete(settings) {
        if (!settings) return { complete: false, missing: ['Jabatan Guru', 'Nama Kepala Madrasah', 'Tempat TTD'] };
        
        const missing = [];
        const fieldNames = {
          'jabatan': 'Jabatan Guru',
          'namaKepala': 'Nama Kepala Madrasah',
          'tempat': 'Tempat TTD LKH/SPTJM'
          // 'tanggal' sengaja tidak divalidasi untuk LKH
        };

        for (const field in fieldNames) {
          if (!settings[field] || String(settings[field]).trim() === '') {
            missing.push(fieldNames[field]);
          }
        }
        
        return {
          complete: missing.length === 0,
          missing: missing
        };
      }

      /**
       * (FUNGSI LAMA - TIDAK BERUBAH)
       * Mengecek kelengkapan pengaturan khusus untuk SPTJM.
       */
      function areSptjmSettingsComplete(settings) {
        if (!settings) return { complete: false, missing: ['Jabatan Guru', 'Nama Kepala Madrasah', 'Tempat TTD', 'Tanggal TTD'] };
        
        const missing = [];
        const fieldNames = {
          'jabatan': 'Jabatan Guru',
          'namaKepala': 'Nama Kepala Madrasah',
          'tempat': 'Tempat TTD LKH/SPTJM',
          'tanggal': 'Tanggal TTD SPTJM' // <-- Tanggal wajib untuk SPTJM
        };

        for (const field in fieldNames) {
          if (!settings[field] || String(settings[field]).trim() === '') {
            missing.push(fieldNames[field]);
          }
        }
        
        return {
          complete: missing.length === 0,
          missing: missing
        };
      }

      function showSptjmViewPage(push = true) {
          hideAllContainers_(); // (PERUBAHAN)
          document.getElementById('sptjm-view-container').style.display = 'block';

          if (push) {
            history.pushState({ page: 'sptjm-view' }, 'Generate SPTJM', '#sptjm-view');
          }
          
          const downloadButton = document.getElementById('download-sptjm-pdf-button');
          const messageElement = document.getElementById('sptjm-download-message');
          downloadButton.disabled = true;

          const sptjmMonthInput = document.getElementById('sptjm-view-month-input');
          
          if (!sptjmMonthInput.value) {
              const today = new Date();
              const targetDate = new Date(); 
              
              if (today.getDate() < 6) {
                  targetDate.setMonth(targetDate.getMonth() - 1);
              }
              
              const year = targetDate.getFullYear();
              const month = String(targetDate.getMonth() + 1).padStart(2, '0');
              sptjmMonthInput.value = `${year}-${month}`;
          }
          
          const selectedMonth = sptjmMonthInput.value;
          const [year, month] = selectedMonth.split('-').map(Number);

          const fieldsToLoad = [
              'sptjm-view-name', 'sptjm-view-nip', 'sptjm-view-jabatan', 'sptjm-view-satker',
              'sptjm-view-month', 'sptjm-view-headmaster-name', 'sptjm-view-headmaster-nip',
              'sptjm-view-signature-name', 'sptjm-view-signature-nip', 'sptjm-view-place-date'
          ];
          fieldsToLoad.forEach(id => {
            const el = document.getElementById(id);
            if(el) el.innerText = "Memuat...";
          });

          displayMessage('sptjm-download-message', 'Memuat data pratinjau...', { isProcessing: true });

          google.script.run
              .withSuccessHandler(data => {
                  if (data.error) {
                      displayMessage('sptjm-download-message', data.error);
                      return; 
                  }
                  const settings = data.settings || {};
                  const user = data.user || {};

                  document.getElementById('sptjm-view-name').innerText = user.name || '-';
                  document.getElementById('sptjm-view-nip').innerText = settings.nip || '-';
                  document.getElementById('sptjm-view-jabatan').innerText = settings.jabatan || 'Guru';
                  document.getElementById('sptjm-view-satker').innerText = user.school || '-';
                  document.getElementById('sptjm-view-month').innerText = settings.bulan || '[Bulan]';

                  const signatureDate = settings.tanggal ? new Date(settings.tanggal).toLocaleDateString('id-ID', { day: '2-digit', month: 'long', year: 'numeric', timeZone: 'Asia/Makassar' }) : '[Tanggal]';
                  document.getElementById('sptjm-view-place-date').innerText = `${settings.tempat || '[Tempat]'}, ${signatureDate}`;

                  document.getElementById('sptjm-view-signature-name').innerText = user.name || '-';
                  document.getElementById('sptjm-view-signature-nip').innerText = settings.nip || '-';
                  document.getElementById('sptjm-view-headmaster-name').innerText = settings.namaKepala || '[Nama Kepala Madrasah]';
                  document.getElementById('sptjm-view-headmaster-nip').innerText = settings.nipKepala || '-';

                  // --- AWAL PERUBAHAN LOGIKA VALIDASI ---
                  const validation = areSptjmSettingsComplete(settings); // Memanggil validasi SPTJM

                  if (validation.complete) {
                      downloadButton.disabled = false;
                      messageElement.innerHTML = ''; // Hapus pesan <p> lama
                      displayMessage('sptjm-download-message', 'Pratinjau siap. Klik untuk mengunduh.', { isSuccess: true });
                  } else {
                      downloadButton.disabled = true;
                      // --- PERUBAHAN DI SINI: Panggil formatMissingList ---
                      const missingList = formatMissingList(validation.missing);
                      
                      messageElement.innerHTML = `Tombol Unduh PDF akan aktif setelah Pengaturan Cetak dilengkapi.
                        <br>
                        <div class="missing-items-list">
                          Data yang perlu dilengkapi: ${missingList}.
                          <br>
                          <a href="#" onclick="event.preventDefault(); showSptjmSettingsPage(true);">Lengkapi Sekarang</a>
                        </div>`;
                      
                      // Hapus toast loading
                      displayMessage('sptjm-download-message', 'Pratinjau dimuat, pengaturan belum lengkap.', { isSuccess: true });
                  }
                  // --- AKHIR PERUBAHAN LOGIKA VALIDASI ---
              })
              .withFailureHandler(err => {
                  displayMessage('sptjm-download-message', `Error: ${err.message}`);
              })
              .getSptjmDataForUser(currentUser.email, selectedSchool, year, month);
      }

      function handleDownloadSptjmPdf() {
          const button = document.getElementById('download-sptjm-pdf-button');
          button.disabled = true;
          button.querySelector('span').textContent = 'Membuat PDF...';
          displayMessage('sptjm-download-message', 'Sedang memproses & membuat PDF, mohon tunggu...', { isProcessing: true });

          // --- AWAL PERUBAHAN: Ambil bulan dari input ---
          const monthInput = document.getElementById('sptjm-view-month-input').value;
          if (!monthInput) {
              displayMessage('sptjm-download-message', 'Error: Bulan dan Tahun belum dipilih.');
              button.disabled = false;
              button.querySelector('span').textContent = 'Unduh PDF';
              return;
          }
          // --- AKHIR PERUBAHAN ---

          google.script.run
              .withSuccessHandler(response => {
                  if (response.success) {
                      const link = document.createElement('a');
                      link.href = `data:application/pdf;base64,${response.pdfData}`;
                      link.download = response.fileName;
                      document.body.appendChild(link);
                      link.click();
                      document.body.removeChild(link);
                      displayMessage('sptjm-download-message', 'PDF berhasil dibuat dan sedang diunduh!', { isSuccess: true });
                  } else {
                      displayMessage('sptjm-download-message', 'Error: ' + response.error);
                  }
                  button.disabled = false;
                  button.querySelector('span').textContent = 'Unduh PDF';
              })
              .withFailureHandler(error => {
                  displayMessage('sptjm-download-message', 'Error: ' + error.message);
                  button.disabled = false;
                  button.querySelector('span').textContent = 'Unduh PDF';
              })
              // 1. Ganti panggilan fungsi di bawah ini
              // .generateSptjmPdf(data); // <-- BARIS LAMA
              .generateSptjmPdf(currentUser.email, selectedSchool, monthInput);
      }

      function showLkhWeeklyPage(push = true) {
        hideAllContainers_(); // (PERUBAHAN)
        document.getElementById("lkh-weekly-container").style.display = "block";

        // --- TAMBAHKAN BARIS INI ---
        if (push) {
          history.pushState({ page: 'lkh-weekly' }, 'LKH Mingguan', '#lkh-weekly');
        }

        generateLkhWeeklyForm();
      }

      function generateLkhWeeklyForm() {
          const container = document.getElementById('lkh-weekly-table-container');
          const saveButton = document.getElementById('save-lkh-weekly-button');
          container.innerHTML = `
            <div class="loader-container">
              <div class="loader">
                <div class="ball"></div><div class="ball"></div><div class="ball"></div>
              </div>
              <p>Memuat formulir LKH mingguan...</p>
            </div>`;
          saveButton.disabled = true;

          google.script.run
            .withSuccessHandler(response => {
              if (response.success) {
                renderLkhWeeklyTable(response.existingData);
                saveButton.disabled = false;
              } else {
                container.innerHTML = `<p style="color: var(--danger-color);">Gagal memuat data: ${response.error}</p>`;
              }
            })
            .withFailureHandler(err => {
              container.innerHTML = `<p style="color: var(--danger-color);">Gagal memuat: ${err.message}</p>`;
            })
            .getLKHWeeklyData(currentUser.email);
      }

      function renderLkhWeeklyTable(existingData) {
        const container = document.getElementById('lkh-weekly-table-container');
        const days = ['Senin', 'Selasa', 'Rabu', 'Kamis', 'Jumat', 'Sabtu'];
        // Menambahkan header kolom "AKSI"
        let tableHTML = '<table><thead><tr><th>HARI</th><th>URAIAN KEGIATAN</th><th>HASIL / OUTPUT</th><th>VOL</th><th>AKSI</th></tr></thead><tbody>';

        days.forEach(day => {
            const data = existingData[day] || {};
            tableHTML += `
              <tr data-day="${day}">
                <td>${day}</td>
                <td><textarea rows="3" id="uraian-${day}">${data.uraian || ''}</textarea></td>
                <td><textarea rows="3" id="hasil-${day}">${data.hasil || ''}</textarea></td>
                <td><textarea id="vol-${day}">${data.vol || ''}</textarea></td>
                <td><button class="clear-btn" onclick="handleClearLkhRow(event)">Hapus</button></td>
              </tr>
            `;
        });

        tableHTML += '</tbody></table>';
        container.innerHTML = tableHTML;
      }

      function handleSaveLKHWeekly() {
        const button = document.getElementById('save-lkh-weekly-button');
        button.disabled = true;
        button.querySelector('span').textContent = "Menyimpan...";
        displayMessage('lkh-weekly-message', 'Menyimpan data LKH mingguan...', { isProcessing: true });

        const lkhWeeklyData = {};
        const rows = document.querySelectorAll('#lkh-weekly-table-container tbody tr');

        rows.forEach(row => {
          const day = row.dataset.day;
          if (day) {
            const uraian = document.getElementById(`uraian-${day}`).value;
            const hasil = document.getElementById(`hasil-${day}`).value;
            const vol = document.getElementById(`vol-${day}`).value;
            lkhWeeklyData[day] = { uraian, hasil, vol };
          }
        });

        google.script.run
          .withSuccessHandler(response => {
            if(response.status === 'success') {
              displayMessage('lkh-weekly-message', response.message, { isSuccess: true });
            } else {
              displayMessage('lkh-weekly-message', response.message);
            }
            button.disabled = false;
            button.querySelector('span').textContent = "Simpan LKH Mingguan";
          })
          .withFailureHandler(error => {
            displayMessage('lkh-weekly-message', 'Error: ' + error.message);
            button.disabled = false;
            button.querySelector('span').textContent = "Simpan LKH Mingguan";
          })
          .saveLKHWeeklyData(currentUser.email, selectedSchool, lkhWeeklyData);
      }

      // ===================================================================
      // INISIALISASI & OTENTIKASI (FUNGSI DIMODIFIKASI)
      // ===================================================================
      document.addEventListener('DOMContentLoaded', () => {
        // --- AWAL PERUBAHAN: Set Tahun Otomatis ---
        document.getElementById('currentYear').textContent = new Date().getFullYear();
        // --- AKHIR PERUBAHAN ---

        // --- AWAL PERUBAHAN: Logika Tombol Kembali (Pushstate) ---
        window.addEventListener('popstate', function(event) {
          const state = event.state;

          if (state && state.page) {
            // Jika ada state yang valid, tampilkan halaman itu
            // (tanpa mem-push state baru)
            showPageFromState_(state.page);
          } else {
            // State adalah 'null'. Ini terjadi jika:
            // 1. Pengguna berada di #dashboard dan menekan "kembali" (sesuai permintaan, app akan "tertutup"/kembali ke halaman sebelum login).
            // 2. Pengguna baru membuka aplikasi.
            
            // Jika pengguna masih login tapi state null (misal, refresh di #ceklok lalu tekan kembali),
            // kita paksa kembali ke dashboard agar tidak keluar.
            const isDashboard = document.getElementById('guru-dashboard-container').style.display === 'block' ||
                              document.getElementById('staff-dashboard-container').style.display === 'block' ||
                              document.getElementById('admin-container').style.display === 'block';

            if (currentUser && !isDashboard) {
              // Jika kita login, tapi *tidak* di dashboard, dan state null -> paksa ke dashboard
              showDashboardBasedOnRole_(false); // Tampilkan dashboard tanpa push state
            } else if (!currentUser) {
              // Jika state null dan tidak login -> tampilkan login
              hideAllContainers_();
              document.getElementById('login-container').style.display = 'block';
            }
            // Jika state null DAN kita DI dashboard -> biarkan browser kembali (menutup app).
          }
        });
        // --- AKHIR PERUBAHAN ---

        const token = localStorage.getItem('ceklokAuthToken');
        if (token) {
          // --- PERUBAHAN DIMULAI (LOGIKA BARU) ---
          // 1. Langsung coba tampilkan dasbor dari localStorage
          try {
            currentUser = JSON.parse(localStorage.getItem('ceklokUser'));
            selectedSchool = localStorage.getItem('ceklokSelectedSchool');

            if (currentUser && selectedSchool) {
              // PENTING: Tampilkan dashboard menggunakan 'replaceState'
              // (isLogin = true) agar halaman sebelumnya (refresh) tidak masuk history.
              // Kita juga harus menangani hash URL saat refresh.
              const hash = window.location.hash.substring(1); // cth: 'ceklok'
              
              if (hash && hash !== 'dashboard') {
                // Jika refresh di sub-page, set state dashboard dulu,
                // lalu navigasi ke sub-page
                history.replaceState({ page: 'dashboard' }, 'Dashboard', '#dashboard');
                showPageFromState_(hash); // Tampilkan sub-halaman
              } else {
                // Jika refresh di dashboard atau halaman tidak dikenal,
                // tampilkan dashboard utama.
                showDashboardBasedOnRole_(true); // isLogin=true -> replaceState
              }
              
            } else {
                // Jika data di localStorage tidak lengkap, tampilkan login
                hideAllContainers_();
                document.getElementById("login-container").style.display = 'block';
            }
          } catch (e) {
              // Jika ada error saat parsing, fallback ke halaman login
              hideAllContainers_();
              document.getElementById("login-container").style.display = 'block';
          }
          // --- AKHIR PERUBAHAN (LOGIKA BARU) ---

          // 2. Lakukan verifikasi token di latar belakang
          google.script.run
            .withSuccessHandler(response => {
              if (response.status !== "success") {
                // Jika token tidak valid, logout pengguna
                handleLogout();
                displayMessage('login-message', "Sesi Anda telah berakhir. Silakan login kembali.");
              }
              // Jika sukses, tidak perlu melakukan apa-apa karena dasbor sudah ditampilkan
            })
            .withFailureHandler(error => {
              // Jika verifikasi gagal, logout pengguna
              handleLogout();
              displayMessage('login-message', "Gagal memverifikasi sesi. Silakan login kembali.");
            })
            .verifyToken(token);

        } else {
            // Jika tidak ada token, pastikan halaman login ditampilkan
            hideAllContainers_();
            document.getElementById("login-container").style.display = 'block';
            // Pastikan tidak ada hash aneh di URL
            history.replaceState(null, 'Login', window.location.pathname);
        }

        const emailInput = document.getElementById('email');
        const passwordInput = document.getElementById('password'); // Variabel sudah ada
        const loginOnEnter = (event) => {
          if (event.key === 'Enter') {
            event.preventDefault();
            handleLogin();
          }
        };
        emailInput.addEventListener('keyup', loginOnEnter);
        passwordInput.addEventListener('keyup', loginOnEnter);

        // ==== PERUBAHAN DIMULAI DI SINI (JavaScript untuk ikon mata) ====
        const toggleIcon = document.getElementById('togglePassword');

        // Cek jika passwordInput (dari atas) dan toggleIcon ada
        if (passwordInput && toggleIcon) {
          toggleIcon.addEventListener('click', function () {
            // Cek tipe input saat ini
            const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
            passwordInput.setAttribute('type', type);

            // Ganti ikon
            this.classList.toggle('fa-eye');
            this.classList.toggle('fa-eye-slash');
          });
        }
        // ==== PERUBAHAN SELESAI ====
      });

      function handleLogin() {
        const email = document.getElementById("email").value;
        const password = document.getElementById("password").value;
        const button = document.getElementById("login-button");
        if (!email || !password) {
          displayMessage('login-message', "Email dan password wajib diisi.");
          return;
        }
        button.disabled = true;
        button.querySelector('span').textContent = "Mencoba Login...";
        // Menampilkan loading saat login
        displayMessage('login-message', 'Mencoba login...', { isProcessing: true });

        google.script.run
          .withSuccessHandler(response => {
            button.disabled = false;
            button.querySelector('span').textContent = "Login";
            if (response.status === "success") {
              // --- PERUBAHAN DIMULAI ---
              localStorage.setItem('ceklokAuthToken', response.token);
              localStorage.setItem('ceklokUser', JSON.stringify(response.user));
              // --- PERUBAHAN SELESAI ---

              currentUser = response.user;
              displayMessage('login-message', ''); // Hapus pesan loading

              if (currentUser.role === 'admin') {
                // (PERUBAHAN) Panggil helper, tandai sebagai login
                showDashboardBasedOnRole_(true); // isLogin = true
              } else if (currentUser.schools && currentUser.schools.length > 1) {
                showSchoolSelection(currentUser.schools, true); // (PERUBAHAN) push = true
              } else if (currentUser.schools && currentUser.schools.length === 1) {
                selectedSchool = currentUser.schools[0];
                // --- PERUBAHAN DIMULAI ---
                localStorage.setItem('ceklokSelectedSchool', selectedSchool);
                // --- PERUBAHAN SELESAI ---
                
                // (PERUBAHAN) Panggil helper, tandai sebagai login
                showDashboardBasedOnRole_(true); // isLogin = true

              } else {
                displayMessage('login-message', 'Akun Anda tidak terdaftar di sekolah manapun.');
              }
            } else {
              displayMessage('login-message', response.message);
            }
          })
          .withFailureHandler(error => {
            displayMessage('login-message', "Error: " + error.message);
            button.disabled = false;
            button.querySelector('span').textContent = "Login";
          })
          .userLogin(email, password);
      }

      function showSchoolSelection(schools, push = true) {
        hideAllContainers_(); // (PERUBAHAN) Gunakan helper
        const select = document.getElementById('school-select');
        select.innerHTML = '';
        schools.forEach(school => {
            const option = document.createElement('option');
            option.value = school;
            option.textContent = school;
            select.appendChild(option);
        });
        document.getElementById('school-selection-container').style.display = 'block';

        // --- TAMBAKAN BARIS INI ---
        if (push) {
          history.pushState({ page: 'school-select' }, 'Pilih Sekolah', '#school-select');
        }
        // --- AKHIR TAMBAHAN ---
      }

      function handleSchoolSelection() {
        selectedSchool = document.getElementById('school-select').value;
        if (selectedSchool) {
          // --- PERUBAHAN DIMULAI ---
          localStorage.setItem('ceklokSelectedSchool', selectedSchool);
          // --- PERUBAHAN SELESAI ---
          
          // (PERUBAHAN) Panggil helper, tandai sebagai login (gantikan state)
          showDashboardBasedOnRole_(true); // isLogin = true
        }
      }

      function handleLogout() {
        const token = localStorage.getItem('ceklokAuthToken');
        if(token) {
          google.script.run.userLogout(token);
        }
        localStorage.removeItem('ceklokUser');
        localStorage.removeItem('ceklokSelectedSchool');
        localStorage.removeItem('ceklokAuthToken');

        currentUser = null;
        selectedSchool = null;
        currentDate = new Date();
        selectedTeacherForStaff = null;
        schoolTeachers = [];

        appSettings = {
          openedMonths: [], holidays: {}, teacherHolidays: [],
          isRequestableMonth: false, pendingChanges: {}, rejectionInfo: null, rejectedChanges: [],
          hasGeoBypass: false
        };

        // === AWAL PERUBAHAN (Sesuai Permintaan) ===
        // Hentikan polling saat logout
        if (settingsPollInterval) {
          clearInterval(settingsPollInterval);
          settingsPollInterval = null;
        }
        
        // --- TAMBAHAN BARU: Reset Cache Pengumuman ---
        cachedAnnouncements = null;
        currentAnnouncementTimestamp = '0';
        // --- AKHIR TAMBAHAN ---
        // === AKHIR PERUBAHAN ===
        
        // --- TAMBAHAN BARU ---
        currentSchoolSettings = {};
        isUserInLocation = false;
        // --- AKHIR TAMBAHAN ---

        // (PERUBAHAN) Sembunyikan semua kontainer
        hideAllContainers_();

        const loginContainer = document.getElementById("login-container");
        loginContainer.innerHTML = `
           <form id="login-form" onsubmit="event.preventDefault(); handleLogin();">
               <div class="card">
                <h2>Ceklok Guru, Staff & Admin</h2>
                <p>Silakan login untuk melanjutkan</p>
                <div class="input-group">
                  <label for="email">Email</label>
                  <input type="email" id="email" placeholder="Masukkan email Anda" autocomplete="username">
                </div>
                <div class="input-group">
                  <label for="password">Password</label>
                  <div class="password-wrapper">
                    <input type="password" id="password" placeholder="Masukkan password" autocomplete="current-password">
                    <i class="fa-solid fa-eye" id="togglePassword"></i>
                  </div>
                </div>
                <button type="submit" id="login-button"><i class="fa-solid fa-right-to-bracket"></i> <span>Login</span></button>
                <p id="login-message" class="message"></p>
              </div>
           </form>
        `;

        const emailInput = document.getElementById('email');
        const passwordInput = document.getElementById('password');
        const toggleIcon = document.getElementById('togglePassword');

        const loginOnEnter = (event) => {
          if (event.key === 'Enter') {
            event.preventDefault();
            handleLogin();
          }
        };
        emailInput.addEventListener('keyup', loginOnEnter);
        passwordInput.addEventListener('keyup', loginOnEnter);

        if (passwordInput && toggleIcon) {
          toggleIcon.addEventListener('click', function () {
            const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
            passwordInput.setAttribute('type', type);
            this.classList.toggle('fa-eye');
            this.classList.toggle('fa-eye-slash');
          });
        }

        loginContainer.style.display = "block";
        
        // (PERUBAHAN) Hapus state history saat logout
        history.replaceState(null, 'Login', window.location.pathname);

        displayMessage('login-message', "Anda berhasil logout.", { isSuccess: true });
      }

      function goBackToDashboard() {
        // (PERUBAHAN) Cukup panggil history.back()
        // Ini akan memicu 'popstate' listener
        history.back();
      }

      // ===================================================================
      // LOGIKA UNTUK GURU (FUNGSI DIMODIFIKASI)
      // ===================================================================
      function showGuruDashboard(userData, isLogin = false) {
          if (userData) currentUser = userData;
          
          hideAllContainers_(); // (PERUBAHAN)
          document.getElementById("guru-dashboard-container").style.display = "block";

          // --- (PERUBAHAN) Pindahkan logic history ke AKHIR ---

          const welcomeH2 = document.getElementById('guru-welcome-message');
          let welcomeHTML = `Halo, <strong>${currentUser.name}</strong>`;

          if (currentUser.schools && currentUser.schools.length > 1) {
            welcomeHTML += `<br><small id="school-switcher-link" onclick="openSchoolSwitcherModal()">${selectedSchool}</small>`;
          } else {
            welcomeHTML += `<br><small>${selectedSchool}</small>`;
          }
          welcomeH2.innerHTML = welcomeHTML;

          const lkhButton = document.getElementById('lkh-sptjm-button');
          if (currentUser.hasLKHFeature) {
            lkhButton.style.display = 'flex';
          } else {
            lkhButton.style.display = 'none';
          }

          // --- AWAL PERUBAHAN LOGIKA CACHING ---
          
          // Cek jika cache KOSONG (null)
          if (cachedAnnouncements === null) {
            // Ini adalah load pertama kali (setelah login)
            console.log("Cache pengumuman kosong, mengambil data baru...");
            renderAnnouncements("Memuat pengumuman...", true); // Tampilkan loading

            // Panggil getAttendancePageData untuk mendapatkan *semua* data awal
            google.script.run
              .withSuccessHandler(response => {
                if (response && response.error) {
                  renderAnnouncements("Gagal memuat pengaturan.");
                  document.getElementById('geo-status-box').style.display = 'none';
                  return;
                }
                
                // Simpan semua pengaturan
                appSettings = response;
                currentSchoolSettings = response.schoolSettings || {};
                
                // === SIMPAN KE CACHE ===
                cachedAnnouncements = response.announcements;
                currentAnnouncementTimestamp = response.announcementTimestamp || '0';
                // === AKHIR SIMPAN KE CACHE ===
                
                runDashboardGeoCheck(); 
                startSettingsPolling(); // Mulai polling SETELAH semua data awal dimuat
                loadAndRenderSummary();
              })
              .withFailureHandler(error => {
                  renderAnnouncements(`Gagal memuat pengaturan: ${error.message}`);
                  document.getElementById('geo-status-box').style.display = 'none';
              })
              .getAttendancePageData(currentUser.email, selectedSchool, currentDate.getFullYear(), currentDate.getMonth() + 1, 0); 
          
          } else {
            // Ini adalah *kembali* ke dasbor (cache SUDAH ADA)
            console.log("Menggunakan cache pengumuman.");
            
            // (Logika Geo dan Polling sudah berjalan dari load pertama,
            // jadi kita hanya perlu me-refresh UI Geo)
            runDashboardGeoCheck();
            loadAndRenderSummary();
          }
          // --- AKHIR PERUBAHAN LOGIKA CACHING ---

          // --- (PERUBAHAN) Logika History ---
          if (isLogin) {
            history.replaceState({ page: 'dashboard' }, 'Dashboard', '#dashboard');
          }
      }

      function openSchoolSwitcherModal() {
        const modal = document.getElementById('school-switcher-modal');
        const container = document.getElementById('school-list-container');
        container.innerHTML = '';

        currentUser.schools.forEach(school => {
          const schoolButton = document.createElement('button');
          schoolButton.textContent = school;
          schoolButton.onclick = () => handleSchoolSwitch(school);
          if (school === selectedSchool) {
            schoolButton.disabled = true;
          }
          container.appendChild(schoolButton);
        });
        modal.style.display = 'block';
      }

      function closeSchoolSwitcherModal() {
        document.getElementById('school-switcher-modal').style.display = 'none';
      }

      function handleSchoolSwitch(newSchool) {
        closeSchoolSwitcherModal();
        if (newSchool && newSchool !== selectedSchool) {
          selectedSchool = newSchool;
          // --- PERUBAHAN DIMULAI ---
          localStorage.setItem('ceklokSelectedSchool', selectedSchool);
          // --- PERUBAHAN SELESAI ---

          // === AWAL PERUBAHAN (Sesuai Permintaan) ===
          // Hentikan polling lama. Polling baru akan
          // dimulai otomatis oleh showGuruDashboard.
          if (settingsPollInterval) {
            clearInterval(settingsPollInterval);
            settingsPollInterval = null;
          }
          // === AKHIR PERUBAHAN ===

          if (currentUser.role === 'guru') {
            showGuruDashboard();
          } else if (currentUser.role === 'staff') {
            showStaffDashboard();
          }
        }
      }

      function showLkhSptjmDashboard(push = true) {
        hideAllContainers_(); // (PERUBAHAN)
        document.getElementById("lkh-sptjm-dashboard-container").style.display = "block";

        // --- TAMBAHKAN BARIS INI ---
        if (push) {
          history.pushState({ page: 'lkh-sptjm' }, 'LKH & SPTJM', '#lkh-sptjm');
        }
      }

      function showCeklokPage(push = true) {
          hideAllContainers_(); // (PERUBAHAN)
          document.getElementById("ceklok-container").style.display = "block";
          document.getElementById('ceklok-teacher-name').innerText = '';
          document.getElementById('ceklok-title').innerText = `Formulir Kehadiran - ${selectedSchool}`;

          // --- TAMBAHKAN BARIS INI ---
          if (push) {
            history.pushState({ page: 'ceklok' }, 'Ceklok', '#ceklok');
          }
          
          // === LOGIKA BARU: Cek status global ===
          const isGeoEnabled = currentSchoolSettings.geoEnabled === true;
          const geoMessage = document.getElementById('geo-lock-message');
          
          // Cek apakah yang sedang dilihat adalah bulan berjalan (berdasarkan currentDate)
          const today = new Date();
          const isCurrentMonthView = currentDate.getFullYear() === today.getFullYear() &&
                                    currentDate.getMonth() === today.getMonth();

          if (isGeoEnabled && !isUserInLocation && isCurrentMonthView) {
              
              // Jika geo aktif DAN status global "di luar lokasi" DAN ini bulan berjalan
              geoMessage.innerText = "Anda berada di luar jangkauan lokasi. Input Ceklok hari ini dikunci.";
              geoMessage.style.display = 'block';
              geoMessage.style.color = 'var(--danger-color)';
              geoMessage.style.backgroundColor = '#FEF2F2';
          } else {
              // Jika geo nonaktif ATAU pengguna di dalam lokasi ATAU ini bulan lalu/depan
              geoMessage.style.display = 'none';
          }
          // ====================================

          // Panggil loadMonthData dengan 'currentDate' global
          loadMonthData(currentDate);
      }

      function showTeacherHolidaySettings(push = true) {
          hideAllContainers_(); // (PERUBAHAN)
          document.getElementById("teacher-holiday-settings-container").style.display = "block";

          // --- TAMBAHKAN BARIS INI ---
          if (push) {
            history.pushState({ page: 'teacher-holiday' }, 'Pengaturan Libur', '#teacher-holiday');
          }

          document.getElementById('teacher-holiday-title').innerText = `Pengaturan Hari Libur - ${selectedSchool}`;
          renderTeacherHolidaySwitches();
          loadTeacherHolidays();
      }

      function showEmisImportPage(push = true) {
        hideAllContainers_(); // (PERUBAHAN)
        document.getElementById("emis-import-container").style.display = "block";

        // --- TAMBAHKAN BARIS INI ---
        if (push) {
          history.pushState({ page: 'emis-import' }, 'Import EMIS', '#emis-import');
        }
        // --- AKHIR TAMBAHAN ---

        document.getElementById('emis-import-teacher-name').innerText = '';
        document.getElementById('emis-import-title').innerText = `Import Data Kehadiran EMIS - ${selectedSchool}`;
      }

      function showEmisExportPage(push = true) {
        hideAllContainers_(); // (PERUBAHAN)
        document.getElementById("emis-export-container").style.display = "block";

        // --- TAMBAHKAN BARIS INI ---
        if (push) {
          history.pushState({ page: 'emis-export' }, 'Eksport EMIS', '#emis-export');
        }
        // --- AKHIR TAMBAHAN ---

        document.getElementById('emis-export-teacher-name').innerText = '';
        document.getElementById('emis-export-title').innerText = `Eksport Data Kehadiran - ${selectedSchool}`;
      }

      // Modifikasi renderAnnouncements untuk menangani isProcessing
      function renderAnnouncements(text, isProcessing = false) {
        const p = document.getElementById('announcement-text');
        const defaultText = "Tidak ada pengumuman saat ini.";

        if (isProcessing) {
            p.innerHTML = `<div class="message-with-loader" style="justify-content: left;"><div class="message-loader"></div><span>${text}</span></div>`;
        } else {
            p.innerText = (text && text.trim() !== "") ? text : defaultText;
        }
      }

      function changeMonth(direction) {
        currentDate.setMonth(currentDate.getMonth() + direction);
        loadMonthData(currentDate);
      }

      function loadMonthData(date){
          const year = date.getFullYear();
          const month = date.getMonth() + 1;
          // Tentukan user target (guru atau staff yang melihat guru lain)
          const userEmail = (currentUser.role === 'staff' && selectedTeacherForStaff) ? selectedTeacherForStaff.email : currentUser.email;
          const schoolForCall = (currentUser.role === 'staff' && selectedTeacherForStaff) ? selectedTeacherForStaff.school : selectedSchool;
          const viewerEmail = currentUser.email; // <-- 1. TAMBAHKAN INI (Email yang sedang login)

          // Dapatkan referensi tombol
          const saveButton = document.getElementById('save-button');
          const requestButton = document.getElementById('request-change-button');

          // Token untuk mencegah race condition jika user klik bulan bolak-balik
          latestRequestToken++;
          const currentToken = latestRequestToken;

          // Update tampilan nama bulan & tahun
          document.getElementById('month-display').innerText = date.toLocaleString('id-ID', { month: 'long', year: 'numeric' });
          // Tampilkan indikator loading
          document.getElementById('attendance-table-container').innerHTML = `
            <div class="loader-container">
              <div class="loader">
                <div class="ball"></div><div class="ball"></div><div class="ball"></div>
              </div>
              <p>Memuat data absensi...</p>
            </div>`;
          // Nonaktifkan tombol saat loading
          saveButton.disabled = true;
          requestButton.disabled = true;

          // Panggil fungsi server untuk mendapatkan data
          google.script.run
            .withSuccessHandler(response => {
              // Handle jika ada error dari server
              if (response && response.error) {
                 document.getElementById('attendance-table-container').innerHTML = `<p style="color: var(--danger-color);">${response.error}</p>`;
                 saveButton.disabled = true;
                 requestButton.disabled = true;
                 return;
              }

              // Abaikan response jika token tidak sesuai (user sudah pindah bulan lain)
              if (!response || response.token !== latestRequestToken) {
                return;
              }

              // Simpan data & pengaturan yang diterima dari server ke variabel global `appSettings`
              if (response && response.token === latestRequestToken) {
                  // Simpan state baru dari server
                  appSettings.attendance = response.attendance || {};
                  appSettings.holidays = response.holidays || {};
                  appSettings.teacherHolidays = response.teacherHolidays || [];
                  appSettings.announcements = response.announcements || "";
                  appSettings.isMonthLocked = response.isMonthLocked; // Status kunci bulan (baru)
                  appSettings.isRequestableMonth = response.isRequestableMonth; // Status bisa ajuan
                  appSettings.pendingChanges = response.pendingChanges || {}; // Data ajuan pending
                  appSettings.rejectionInfo = response.rejectionInfo; // Info penolakan
                  appSettings.rejectedChanges = response.rejectedChanges || []; // Detail ajuan ditolak
                  appSettings.hasGeoBypass = response.hasGeoBypass; // <-- 2. SIMPAN STATUS BYPASS
                  appSettings.lastMonthCeklokDayLimit = response.lastMonthCeklokDayLimit;
                  appSettings.lkhLastDayLimit = response.lkhLastDayLimit; // <-- BARIS BARU
                  currentSchoolSettings = response.schoolSettings || {}; // Pengaturan sekolah (termasuk Geo)
              }

              // Panggil fungsi untuk membuat tabel HTML berdasarkan data yang baru diterima
              generateMonthTable(year, month, appSettings.attendance);
            })
            .withFailureHandler(error => {
                // Handle jika terjadi error saat memanggil fungsi server
                document.getElementById('attendance-table-container').innerHTML = `<p style="color: var(--danger-color);">Gagal memuat data absensi: ${error.message}</p>`;
                 saveButton.disabled = true;
                 requestButton.disabled = true;
            })
            // Panggil fungsi di Kode.gs untuk mendapatkan semua data sekaligus
            .getAttendancePageData(userEmail, schoolForCall, year, month, currentToken, viewerEmail); // <-- 3. TAMBAHKAN viewerEmail
      }

      function handleTimeInput(event) {
        const input = event.target;
        let value = input.value;
        let originalValue = value;
        let lastChar = value.slice(-1);

        // Hanya izinkan angka, titik, atau titik dua
        value = value.replace(/[^0-9.:]/g, '');

        // Jika pengguna mengetik titik atau titik dua, langsung format
        if ((lastChar === '.' || lastChar === ':') && value.length <= 3 && !value.includes(':')) {
          let digitsOnly = value.replace(/\D/g, '');
          if (digitsOnly.length > 0 && digitsOnly.length <= 2) {
            value = digitsOnly.padStart(2, '0') + ':';
          }
        } else {
          let digits = value.replace(/\D/g, '');

          // Validasi Jam
          if (digits.length >= 2) {
            if (parseInt(digits.substring(0, 2)) > 23) {
              digits = digits.substring(0, 1);
            }
          }
          // Validasi Menit
          if (digits.length >= 3) {
            if (parseInt(digits.substring(2, 3)) > 5) {
              digits = digits.substring(0, 2);
            }
          }

          if (digits.length > 4) {
            digits = digits.substring(0, 4);
          }

          // Format otomatis
          if (digits.length > 2) {
            value = digits.substring(0, 2) + ':' + digits.substring(2);
          } else {
            value = digits;
          }
        }

        input.value = value;
      }

      /**
       * ===================================================================
       * FUNGSI generateMonthTable DIMODIFIKASI (Versi 3 - PERBAIKAN BUG #1)
       * ===================================================================
       * - Memperbaiki Bug Kritis Geo-Lock:
       * Logika 'isRowDisabled' kini diperketat agar sesuai dengan aturan server.
       * - JIKA Geo-Lock aktif DAN ini bulan berjalan DAN pengguna TIDAK punya bypass (akun Guru):
       * - Baris HARI INI akan bisa diedit (jika di dalam lokasi).
       * - SEMUA baris LAIN (kemarin, lusa, dst.) akan dinonaktifkan (disabled).
       * - JIKA pengguna PUNYA bypass (akun Staff):
       * - Logika penguncian HARI LAIN akan dilewati, sehingga Staff tetap bisa mengedit hari kemarin.
       */
      function generateMonthTable(year, month, attendanceData) {
          const container = document.getElementById('attendance-table-container');
          const geoMessage = document.getElementById('geo-lock-message');
          const isGeoEnabled = currentSchoolSettings.geoEnabled === true;
          const today = new Date();
          const currentYear = today.getFullYear();
          const currentMonth = today.getMonth() + 1;
          const isCurrentMonthView = (year === currentYear && month === currentMonth);
          const isPastMonthView = year < currentYear || (year === currentYear && month < currentMonth);

          // Cek bypass global. 'appSettings.hasGeoBypass' dikirim dari server
          const hasBypass = appSettings.hasGeoBypass === true;

          // Logika pesan Geo-lock (Tidak Berubah)
          if (isGeoEnabled && !isUserInLocation && isCurrentMonthView) {
              if (hasBypass) {
                  geoMessage.innerText = "Anda berada di luar jangkauan lokasi. Fitur bypass Staff aktif, Ceklok hari ini dibuka.";
                  geoMessage.style.display = 'block';
                  geoMessage.style.color = '#059669';
                  geoMessage.style.backgroundColor = '#ECFDF5';
              } else {
                  geoMessage.innerText = "Anda berada di luar jangkauan lokasi. Input Ceklok hari ini dikunci.";
                  geoMessage.style.display = 'block';
                  geoMessage.style.color = 'var(--danger-color)';
                  geoMessage.style.backgroundColor = '#FEF2F2';
              }
          } else {
              geoMessage.style.display = 'none';
          }

          // Opsi alasan cuti/izin (Tidak Berubah)
          const reasonOptions = `
              <option value="">-- Pilih Alasan --</option>
              <option value="Hari Libur Sekolah">Hari Libur Sekolah</option>
              <option value="Cuti Tahunan">Cuti Tahunan</option>
              <option value="Cuti Bersalin (Anak Pertama s.d Ketiga)">Cuti Bersalin (Anak Pertama s.d Ketiga)</option>
              <option value="Cuti Bersalin (Anak Keempat dst) Bulan Pertama">Cuti Bersalin (Anak Keempat dst) Bulan Pertama</option>
              <option value="Cuti Bersalin (Anak Keempat dst) Bulan Kedua">Cuti Bersalin (Anak Keempat dst) Bulan Kedua</option>
              <option value="Cuti Bersalin (Anak Keempat dst) Bulan Ketiga">Cuti Bersalin (Anak Keempat dst) Bulan Ketiga</option>
              <option value="Cuti Besar Bulan Pertama">Cuti Besar Bulan Pertama</option>
              <option value="Cuti Besar Bulan Kedua">Cuti Besar Bulan Kedua</option>
              <option value="Cuti Besar Bulan Ketiga">Cuti Besar Bulan Ketiga</option>
              <option value="Izin Tugas belajar">Izin Tugas belajar</option>
              <option value="Izin Alasan Penting (1 s.d 2 Hari)">Izin Alasan Penting (1 s.d 2 Hari)</option>
              <option value="Izin Alasan Penting (Lebih dari 2 Hari)">Izin Alasan Penting (Lebih dari 2 Hari)</option>
              <option value="Izin Sakit (1 hari Sampai Dengan 14 Hari)">Izin Sakit (1 hari Sampai Dengan 14 Hari)</option>
              <option value="Izin Sakit (Lebih dari 14 Hari Sampai Dengan 12 Bulan)">Izin Sakit (Lebih dari 14 Hari Sampai Dengan 12 Bulan)</option>
              <option value="Izin Sakit (Lebih dari 18 Bulan)">Izin Sakit (Lebih dari 18 Bulan)</option>
              <option value="Dinas Luar">Dinas Luar</option>
          `;

          // Variabel & Pengecekan Kondisi Bulan (Tidak Berubah)
          const daysInMonth = new Date(year, month, 0).getDate();
          const todayStr = jsFormatDate(new Date()); // Format "YYYY-MM-DD"

          const isLocked = appSettings.isMonthLocked;
          const isReqMonth = appSettings.isRequestableMonth;
          const pendingData = appSettings.pendingChanges;
          const isRequestPending = Object.keys(pendingData).length > 0;

          // Logika Pesan Penguncian Global (Tidak Berubah)
          let lockMessage = "";
          if (isGeoEnabled && isCurrentMonthView && !isUserInLocation) {
              lockMessage = '';
          } else if (isReqMonth) {
            if (isRequestPending) { lockMessage = 'Pengajuan Anda sedang ditinjau oleh Staff.'; }
            else if (appSettings.rejectionInfo) { lockMessage = 'Beberapa pengajuan Anda ditolak. Lihat detail di bawah.'; }
            else { lockMessage = 'Bulan ini terkunci. Klik "Ubah" pada baris untuk mengajukan perubahan.'; }
          } else if (isPastMonthView) {
              if (isLocked) {
                  lockMessage = 'Absensi untuk bulan ini telah dikunci oleh Admin.';
              } else {
                  lockMessage = 'Bulan ini telah dibuka oleh Admin untuk pengeditan.';
              }
          } else if (isLocked) {
            lockMessage = 'Absensi untuk bulan ini telah dikunci oleh Admin.';
          }
          document.getElementById('global-lock-message').innerText = lockMessage;
          const lockMessageElement = document.getElementById('global-lock-message');
          lockMessageElement.classList.remove('info-message', 'warning-message', 'danger-message'); 
          if (isPastMonthView && !isLocked && !isReqMonth) {
              lockMessageElement.classList.add('info-message');
          } else if (isReqMonth && !isRequestPending && !appSettings.rejectionInfo){
              lockMessageElement.classList.add('warning-message');
          } else if (lockMessage.trim() !== '') { 
              lockMessageElement.classList.add('danger-message');
          }

          // Logika Tampilan Tombol Simpan/Ajukan (Tidak Berubah)
          const saveButton = document.getElementById('save-button');
          const requestButton = document.getElementById('request-change-button');

          if (isReqMonth) {
              saveButton.style.display = 'none';
              requestButton.style.display = 'inline-flex';
              requestButton.disabled = false;
              if (isRequestPending) {
                requestButton.innerHTML = '<i class="fa-solid fa-ban"></i> <span>Batalkan Ajuan</span>';
                requestButton.className = 'action-button cancel-request';
                requestButton.onclick = handleCancelRequest;
              } else {
                requestButton.innerHTML = '<i class="fa-solid fa-paper-plane"></i> <span>Ajukan Perubahan</span>';
                requestButton.className = 'action-button';
                requestButton.onclick = handleRequestChange;
              }
          }
          else {
              saveButton.style.display = 'inline-flex';
              requestButton.style.display = 'none';
              saveButton.disabled = isLocked || (isGeoEnabled && isCurrentMonthView && !isUserInLocation && !hasBypass);
          }

          // Logika Menampilkan Detail Penolakan (Tidak Berubah)
          const messageElement = document.getElementById('save-message');
          const rejectionWrapper = document.getElementById('rejection-details-wrapper');
          messageElement.innerHTML = '';
          rejectionWrapper.innerHTML = '';
          const rejectedItems = appSettings.rejectedChanges || [];

          if (isReqMonth && rejectedItems.length > 0) {
              const formatData = (data) => {
                if (data.reason) return `<strong>Alasan:</strong> ${data.reason}`;
                if (!data.checkIn && !data.checkOut) return `<em>(Kosong)</em>`;
                return `<strong>M:</strong> ${data.checkIn || '-'} | <strong>P:</strong> ${data.checkOut || '-'}`;
              };
              let rejectionHtml = `
                <div class="rejection-details-container">
                  <h4 class="rejection-title">Detail Pengajuan Ditolak</h4>
                  <p class="rejection-subtitle">Data berikut telah ditolak oleh Staff. Anda dapat mengubah dan mengajukannya kembali.</p>
                  <div class="table-scroll-wrapper">
                    <table class="rejection-table">
                      <thead>
                        <tr>
                          <th>Tgl</th>
                          <th>Data Lama</th>
                          <th>Ajuan Ditolak</th>
                          <th>Alasan Penolakan</th>
                        </tr>
                      </thead>
                      <tbody>
              `;
              const formatDateTgl = (dateStr) => {
                  try { return dateStr.split('-')[2]; } catch(e) { return '?'; }
              };
              rejectedItems.forEach(item => {
                 rejectionHtml += `
                    <tr>
                      <td>${formatDateTgl(item.date)}</td>
                      <td>${formatData(item.oldData)}</td>
                      <td>${formatData(item.newData)}</td>
                      <td>${item.reason || '-'}</td>
                    </tr>
                 `;
              });
              rejectionHtml += `</tbody></table></div></div>`;
              rejectionWrapper.innerHTML = rejectionHtml;
          }

          // Mulai Membuat HTML Tabel Utama untuk Ceklok (Tidak Berubah)
          let tableHTML = '<div class="table-scroll-wrapper"><table><thead><tr><th>Tanggal</th><th>Jam Masuk</th><th>Jam Pulang</th><th>Keterangan</th><th>Aksi</th></tr></thead><tbody>';

          // Loop untuk Setiap Hari dalam Bulan
          for (let day = 1; day <= daysInMonth; day++) {
            const dateStr = `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
            const dateObj = new Date(year, month - 1, day);
            const dayOfWeek = dateObj.getDay();
            const dayName = dateObj.toLocaleString('id-ID', { weekday: 'short' });
            const isSunday = dayOfWeek === 0;
            const isHoliday = !!appSettings.holidays[dateStr];

            let rowClassList = [];
            let aksiButton = '';

            // Tentukan Kelas CSS Dasar (Tidak Berubah)
            if (isReqMonth && pendingData[dateStr]) {
              rowClassList.push('pending-row');
            } else if (isSunday) {
              rowClassList.push('sunday-row');
            } else if (isHoliday) {
              rowClassList.push('holiday-row');
            }

            // Tambahkan Kelas CSS Highlight untuk Hari Ini (Tidak Berubah)
            if (dateStr === todayStr && isGeoEnabled && !isReqMonth) {
                if (hasBypass) {
                  rowClassList.push('today-row-allowed');
                } else {
                  rowClassList.push(isUserInLocation ? 'today-row-allowed' : 'today-row-denied');
                }
            }

            // ==========================================================
            // === AWAL PERBAIKAN LOGIKA (BUG #1) ===
            // ==========================================================
            
            // Tentukan apakah input di baris ini harus dinonaktifkan
            let isRowDisabled = 
                // 1. Kunci jika bulan ini dikunci (misal: bulan lalu/depan) DAN bukan bulan pengajuan
                (isLocked && !isReqMonth) || 
                
                // 2. Kunci jika ini adalah bulan pengajuan (logika UI-nya beda, pakai tombol 'Ubah')
                isReqMonth || 
                
                // 3. Kunci HARI INI jika Geo aktif, di luar lokasi, dan tidak punya bypass
                (isGeoEnabled && dateStr === todayStr && !isUserInLocation && !hasBypass) ||
                
                // 4. (INI ADALAH PERBAIKANNYA)
                //    Kunci HARI LAIN (BUKAN HARI INI) jika Geo aktif, ini bulan berjalan, dan tidak punya bypass
                (isGeoEnabled && isCurrentMonthView && !hasBypass && dateStr !== todayStr);
            
            // ==========================================================
            // === AKHIR PERBAIKAN LOGIKA (BUG #1) ===
            // ==========================================================


            // Tentukan Tombol Aksi berdasarkan Kondisi (Tidak Berubah)
            if (isSunday || isHoliday) {
                // Tidak ada tombol
            }
            else if (isReqMonth) {
                if (isRequestPending) {
                    aksiButton = `<button class="action-btn warning edit-btn" disabled>Menunggu</button>`;
                } else {
                    aksiButton = `<button class="action-btn warning edit-btn" onclick="handleEnableEdit(event)">Ubah</button>`;
                }
            }
            else {
                 aksiButton = `<button class="clear-btn" onclick="handleClearRow(event)" ${isRowDisabled ? 'disabled' : ''}>Hapus</button>`;
            }

            // Gabungkan semua kelas CSS (Tidak Berubah)
            const rowClass = rowClassList.join(' ');

            // Buat HTML untuk Baris (tr) (Tidak Berubah)
            if (isHoliday) {
              tableHTML += `<tr id="row-${dateStr}" class="${rowClass}"><td>${day} <small>(${dayName})</small></td><td colspan="3">${appSettings.holidays[dateStr]}</td><td>${aksiButton}</td></tr>`;
            } else if (isSunday) {
              tableHTML += `<tr id="row-${dateStr}" class="${rowClass}"><td>${day} <small>(${dayName})</small></td><td colspan="3">Hari Libur</td><td>${aksiButton}</td></tr>`;
            } else {
              // Input akan otomatis 'disabled' berdasarkan 'isRowDisabled' yang baru
              tableHTML += `<tr id="row-${dateStr}" class="${rowClass}"><td>${day} <small>(${dayName})</small></td><td><input type="text" class="time-entry" id="in-${dateStr}" placeholder="HH:MM" maxlength="5" inputmode="numeric" oninput="handleTimeInput(event)" ${isRowDisabled ? 'disabled' : ''}></td><td><input type="text" class="time-entry" id="out-${dateStr}" placeholder="HH:MM" maxlength="5" inputmode="numeric" oninput="handleTimeInput(event)" ${isRowDisabled ? 'disabled' : ''}></td><td><select id="reason-${dateStr}" ${isRowDisabled ? 'disabled' : ''} onchange="handleReasonChange(event)">${reasonOptions}</select></td><td>${aksiButton}</td></tr>`;
            }
          } // Akhir loop hari

          tableHTML += '</tbody></table></div>';
          container.innerHTML = tableHTML;

          // Isi data absensi (Tidak Berubah)
          populateAttendanceData(attendanceData);

          // Scroll otomatis ke baris hari ini (Tidak Berubah)
          const todayRowElement = document.getElementById(`row-${todayStr}`);
          if (todayRowElement) {
              const isCurrentDisplayMonth = (year === currentYear && month === currentMonth);
              if (isGeoEnabled && isCurrentDisplayMonth && !isReqMonth) {
                  todayRowElement.scrollIntoView({
                      behavior: 'smooth',
                      block: 'center'
                  });
              }
          }
      }

      function populateAttendanceData(data) {
        // --- AWAL PERBAIKAN ---
        const pendingData = appSettings.pendingChanges;
        const isReqMonth = appSettings.isRequestableMonth;

        // 1. Buat Set (daftar unik) dari SEMUA tanggal,
        //    baik dari data asli (data) maupun dari data pending (pendingData)
        const allDates = new Set([...Object.keys(data), ...Object.keys(pendingData)]);

        // 2. Loop menggunakan 'allDates' yang sudah lengkap, bukan hanya 'data'
        for (const date of allDates) {
        // --- AKHIR PERBAIKAN ---

          const checkInInput = document.getElementById(`in-${date}`);
          const checkOutInput = document.getElementById(`out-${date}`);
          const reasonSelect = document.getElementById(`reason-${date}`);

          if(!checkInInput && !checkOutInput && !reasonSelect) continue; // Skip jika baris tidak ada (misal, hari libur)

          // Ambil data dari kedua sumber
          const originalEntry = data[date]; // Ini mungkin undefined (jika Alpa)
          const pendingEntry = pendingData[date]; // Ini mungkin undefined (jika tidak ada ajuan)

          if (isReqMonth && pendingEntry) {
            // Jika ada data PENDING, tampilkan data pending
            if (checkInInput) checkInInput.value = pendingEntry.newCheckIn;
            
            if (checkOutInput) checkOutInput.value = pendingEntry.newCheckOut; 

            if (reasonSelect) {
                reasonSelect.value = pendingEntry.newReason || "";
            }
            // Pastikan input dinonaktifkan karena statusnya 'pending'
            if (checkInInput) checkInInput.disabled = true;
            if (checkOutInput) checkOutInput.disabled = true;
            if (reasonSelect) reasonSelect.disabled = true;

          } else if (originalEntry) { 
            // Jika tidak ada data pending, TAPI ada data asli, tampilkan data asli
            if (checkInInput) checkInInput.value = originalEntry.checkIn;
            if (checkOutInput) checkOutInput.value = originalEntry.checkOut;

            if (reasonSelect) {
              reasonSelect.value = originalEntry.reason || "";
              // Logika lama untuk menonaktifkan input time jika ada alasan (di bulan normal)
              if (originalEntry.reason && !isReqMonth) {
                 if (checkInInput) checkInInput.disabled = true;
                 if (checkOutInput) checkOutInput.disabled = true;
              }
            }
          }
          // Jika tidak ada 'pendingEntry' atau 'originalEntry' (kasus Alpa di bulan normal),
          // maka input akan otomatis kosong, dan itu sudah benar.
        }
      }
      // --- AKHIR FUNGSI YANG DIMODIFIKASI BESAR-BESARAN ---


      function handleReasonChange(event) {
        const selectElement = event.target;
        const hasReason = selectElement.value !== "";
        const row = selectElement.closest('tr');
        const timeInputs = row.querySelectorAll('.time-entry');
        timeInputs.forEach(input => {
          input.disabled = hasReason;
          if (hasReason) input.value = '';
        });
      }

      function handleClearRow(event) {
        event.preventDefault();
        const row = event.target.closest('tr');
        const timeInputs = row.querySelectorAll('.time-entry');
        const reasonSelect = row.querySelector('select');
        timeInputs.forEach(input => {
          input.value = '';
          input.disabled = false;
        });
        if (reasonSelect) reasonSelect.value = '';
      }

      function handleSave() {
          const button = document.getElementById('save-button');
          
          // --- AWAL TAMBAHAN: Dapatkan Referensi Kontrol ---
          const requestButton = document.getElementById('request-change-button');
          const monthNavButtons = document.querySelectorAll('.month-navigator button');
          const tableControls = document.querySelectorAll('#attendance-table-container input, #attendance-table-container select, #attendance-table-container button');
          // --- AKHIR TAMBAHAN ---

          document.querySelectorAll('#attendance-table-container tr.invalid-row').forEach(row => {
              row.classList.remove('invalid-row');
          });

          const schoolForSave = (currentUser.role === 'staff' && selectedTeacherForStaff) ? selectedTeacherForStaff.school : selectedSchool;
          const targetUser = (currentUser.role === 'staff' && selectedTeacherForStaff) ? selectedTeacherForStaff : currentUser;
          const payload = { email: targetUser.email, name: targetUser.name, school: schoolForSave, attendance: {} };

          // --- AWAL PERUBAHAN BYPASS ---
          // Tentukan email yang akan digunakan untuk cek bypass di server
          // Kirim email yang login jika itu staff atau admin
          const staffEmailBypass = (currentUser.role === 'staff' || currentUser.role === 'admin') ? currentUser.email : null;
          // --- AKHIR PERUBAHAN BYPASS ---

          const rows = document.querySelectorAll('#attendance-table-container tbody tr');
          let validationError = false;
          let firstErrorRow = null;
          const timeRegex = /^(?:2[0-3]|[01]?[0-9]):[0-5][0-9]$/;

          rows.forEach(row => {
              const date = row.id.replace('row-', '');
              if (!date || !row.querySelector('.time-entry')) return;

              const checkInInput = row.querySelector(`#in-${date}`);
              const checkOutInput = row.querySelector(`#out-${date}`);
              const reasonSelect = row.querySelector('select');

              if (!reasonSelect) return; 

              const checkIn = checkInInput.value;
              const checkOut = checkOutInput.value;
              const reason = reasonSelect.value;

              if (checkInInput.disabled && reason.trim() === "") return;

              const hasCheckIn = checkIn.trim() !== "";
              const hasCheckOut = checkOut.trim() !== "";
              const hasReason = reason.trim() !== "";

              if (!hasReason) {
                if ((hasCheckIn && !timeRegex.test(checkIn)) || (hasCheckOut && !timeRegex.test(checkOut)) || (hasCheckIn && !hasCheckOut) || (!hasCheckIn && hasCheckOut)) {
                  validationError = true;
                  row.classList.add('invalid-row');
                  if (!firstErrorRow) firstErrorRow = row;
                }
              }

              payload.attendance[date] = {
                  checkIn: hasReason ? "" : (checkIn || ""),
                  checkOut: hasReason ? "" : (checkOut || ""),
                  reason: reason || ""
              };
          });

          if (validationError) {
              displayMessage('save-message', "Gagal: Mohon lengkapi pasangan jam atau perbaiki format waktu (HH:MM) pada baris merah.");
              if (firstErrorRow) {
                  firstErrorRow.scrollIntoView({ behavior: 'smooth', block: 'center' });
              }
              return;
          }

          // --- AWAL PERUBAHAN: Nonaktifkan Semua Kontrol ---
          button.disabled = true;
          button.querySelector('span').textContent = "Menyimpan...";
          if (requestButton) requestButton.disabled = true;
          monthNavButtons.forEach(btn => btn.disabled = true);
          tableControls.forEach(ctrl => ctrl.disabled = true);
          // --- AKHIR PERUBAHAN ---

          displayMessage('save-message', 'Menyimpan data...', { isProcessing: true });

          google.script.run
              .withSuccessHandler(r => {
                  displayMessage('save-message', r.message, { isSuccess: true });
                  
                  // --- PERBAIKAN: Reset teks tombol ---
                  button.querySelector('span').textContent = "Simpan Semua Perubahan";
                  // --- AKHIR PERBAIKAN ---

                  loadMonthData(currentDate); 
                  
                  monthNavButtons.forEach(btn => btn.disabled = false);

                  if (currentUser.role === 'guru') loadAndRenderSummary();
                  else if (currentUser.role === 'staff') loadStaffSummary();
              })
              .withFailureHandler(e => {
                  displayMessage('save-message', "Error: " + e.message);
                  
                  // --- PERBAIKAN: Reset teks tombol ---
                  button.querySelector('span').textContent = "Simpan Semua Perubahan";
                  // --- AKHIR PERBAIKAN ---
                  
                  loadMonthData(currentDate);
                  
                  monthNavButtons.forEach(btn => btn.disabled = false);
              })
              .saveMonthlyAttendance(payload, staffEmailBypass); // <-- Parameter kedua untuk bypass
      }

      // --- AWAL FUNGSI BARU UNTUK FITUR PENGAJUAN ---

      /**
       * (GURU) Dipanggil saat tombol 'Ubah' diklik di bulan pengajuan.
       */
      function handleEnableEdit(event) {
        event.preventDefault();
        const row = event.target.closest('tr');

        // Aktifkan semua input di baris ini
        row.querySelectorAll('input.time-entry, select').forEach(el => {
          el.disabled = false;
        });

        // Jika ada alasan yang dipilih, input jam tetap nonaktif (panggil handleReasonChange)
        const reasonSelect = row.querySelector('select');
        if (reasonSelect) {
          handleReasonChange({ target: reasonSelect });
        }

        // Nonaktifkan tombol 'Ubah' itu sendiri
        event.target.disabled = true;
        event.target.textContent = 'Diubah';
      }

      /**
       * (GURU) Dipanggil saat tombol 'Ajukan Perubahan' diklik.
       */
      function handleRequestChange() {
        const year = currentDate.getFullYear();
        const month = currentDate.getMonth() + 1;
        const userEmail = (currentUser.role === 'staff' && selectedTeacherForStaff) ? selectedTeacherForStaff.email : currentUser.email;
        const schoolForCall = (currentUser.role === 'staff' && selectedTeacherForStaff) ? selectedTeacherForStaff.school : selectedSchool;
        const button = document.getElementById('request-change-button');

        const changes = [];
        const rows = document.querySelectorAll('#attendance-table-container tbody tr');
        const timeRegex = /^(?:2[0-3]|[01]?[0-9]):[0-5][0-9]$/;
        let validationError = false;
        let firstErrorRow = null;

        rows.forEach(row => {
          const editBtn = row.querySelector('.edit-btn');
          // Cari baris yang tombol 'Ubah'-nya sudah diklik (dan disabled)
          if (editBtn && editBtn.disabled && editBtn.textContent === 'Diubah') {
            const date = row.id.replace('row-', '');
            if (!date) return;

            const checkInInput = row.querySelector(`#in-${date}`);
            const checkOutInput = row.querySelector(`#out-${date}`);
            const reasonSelect = row.querySelector(`#reason-${date}`);

            const newCheckIn = checkInInput.value;
            const newCheckOut = checkOutInput.value;
            const newReason = reasonSelect.value;
            const oldData = appSettings.attendance[date] || { checkIn: "", checkOut: "", reason: "" };

            // Validasi (sama seperti handleSave)
            const hasCheckIn = newCheckIn.trim() !== "";
            const hasCheckOut = newCheckOut.trim() !== "";
            const hasReason = newReason.trim() !== "";

            if (!hasReason) {
              if ((hasCheckIn && !timeRegex.test(newCheckIn)) || (hasCheckOut && !timeRegex.test(newCheckOut)) || (hasCheckIn && !hasCheckOut) || (!hasCheckIn && hasCheckOut)) {
                validationError = true;
                row.classList.add('invalid-row');
                if (!firstErrorRow) firstErrorRow = row;
              }
            }

            // Cek apakah ada perubahan
            if (oldData.checkIn !== newCheckIn || oldData.checkOut !== newCheckOut || oldData.reason !== newReason) {
              changes.push({
                date: date,
                oldData: oldData,
                newData: { checkIn: newCheckIn, checkOut: newCheckOut, reason: newReason }
              });
            }
          }
        });

        if (validationError) {
            displayMessage('save-message', "Gagal: Mohon perbaiki format waktu (HH:MM) pada baris merah.");
            if (firstErrorRow) firstErrorRow.scrollIntoView({ behavior: 'smooth', block: 'center' });
            return;
        }

        if (changes.length === 0) {
          displayMessage('save-message', 'Tidak ada perubahan data. Klik "Ubah" pada baris dan ubah datanya terlebih dahulu.');
          return;
        }

        button.disabled = true;
        displayMessage('save-message', 'Mengirim pengajuan...', { isProcessing: true });

        google.script.run
          .withSuccessHandler(response => {
            if (response.status === 'success') {
              displayMessage('save-message', 'Pengajuan berhasil terkirim!', { isSuccess: true });
              loadMonthData(currentDate); // Muat ulang data untuk menampilkan status 'pending'
            } else {
              displayMessage('save-message', `Gagal: ${response.message}`);
              button.disabled = false;
            }
          })
          .withFailureHandler(error => {
            displayMessage('save-message', `Error: ${error.message}`);
            button.disabled = false;
          })
          .submitChangeRequest(userEmail, schoolForCall, year, month, changes);
      }

      // --- PERBAIKAN DI SINI ---
      /**
       * (GURU) Dipanggil saat tombol 'Batalkan Ajuan' diklik.
       * Membuka modal konfirmasi.
       */
      function handleCancelRequest(event) {
        if (event) event.preventDefault(); // Mencegah aksi default tombol jika ada
        openCancelRequestModal();
      }

      // Fungsi untuk membuka modal pembatalan
      function openCancelRequestModal() {
        document.getElementById('cancel-request-modal').style.display = 'block';
      }

      // Fungsi untuk menutup modal pembatalan
      function closeCancelRequestModal() {
        document.getElementById('cancel-request-modal').style.display = 'none';
      }

      // Fungsi yang dipanggil saat tombol 'Ya, Batalkan Ajuan' di modal diklik
      function confirmCancelRequest() {
        closeCancelRequestModal(); // Tutup modal

        const year = currentDate.getFullYear();
        const month = currentDate.getMonth() + 1;
        const userEmail = (currentUser.role === 'staff' && selectedTeacherForStaff) ? selectedTeacherForStaff.email : currentUser.email;
        const schoolForCall = (currentUser.role === 'staff' && selectedTeacherForStaff) ? selectedTeacherForStaff.school : selectedSchool;
        const button = document.getElementById('request-change-button');

        if (button) button.disabled = true; // Nonaktifkan tombol utama
        displayMessage('save-message', 'Membatalkan pengajuan...', { isProcessing: true });

        google.script.run
          .withSuccessHandler(response => {
            if (response.status === 'success') {
              displayMessage('save-message', 'Pengajuan berhasil dibatalkan.', { isSuccess: true });
              loadMonthData(currentDate); // Muat ulang data
            } else {
              displayMessage('save-message', `Gagal: ${response.message}`);
              if (button) button.disabled = false; // Aktifkan lagi jika gagal
            }
          })
          .withFailureHandler(error => {
            displayMessage('save-message', `Error: ${error.message}`);
            if (button) button.disabled = false; // Aktifkan lagi jika error
          })
          .cancelChangeRequest(userEmail, schoolForCall, year, month);
      }
      // --- AKHIR PERBAIKAN ---

      function showChangeRequestPage(push = true) {
        hideAllContainers_(); // (PERUBAHAN)
        document.getElementById("change-request-container").style.display = "block";

        // --- TAMBAHKAN BARIS INI ---
        if (push) {
          history.pushState({ page: 'change-request' }, 'Pengajuan Perubahan', '#change-request');
        }
        // --- AKHIR TAMBAHAN ---

        const container = document.getElementById('request-list-container');
        container.innerHTML = `
          <div class="loader-container">
            <div class="loader">
              <div class="ball"></div><div class="ball"></div><div class="ball"></div>
            </div>
            <p>Memuat daftar pengajuan...</p>
          </div>`;

        displayMessage('request-list-message', ''); // Hapus pesan lama

        google.script.run
          .withSuccessHandler(response => {
            if (response.success) {
              renderChangeRequestList(response.requests);
            } else {
              container.innerHTML = `<p style="color: var(--danger-color);">${response.error}</p>`;
            }
          })
          .withFailureHandler(error => {
            container.innerHTML = `<p style="color: var(--danger-color);">Gagal memuat: ${error.message}</p>`;
          })
          .getPendingRequests(currentUser.email, selectedSchool);
      }

      /**
       * (STAFF) Merender daftar pengajuan di halaman staff.
       * --- FUNGSI INI DIMODIFIKASI UNTUK FITUR GRANULAR ---
       */
      function renderChangeRequestList(requests) {
        const container = document.getElementById('request-list-container');
        if (!requests || requests.length === 0) {
          container.innerHTML = '<p style="text-align: center;">Tidak ada pengajuan perubahan data saat ini.</p>';
          return;
        }

        let html = '';
        requests.forEach(guruRequest => {
          // Buat ID unik untuk grup ini
          const groupId = `request-group-${guruRequest.email}-${guruRequest.year}-${guruRequest.month}`;

          html += `
            <div class="request-group" id="${groupId}">
              <div class="request-group-header">
                
                <div class="select-all-container">
                  <input type="checkbox" id="select-all-${groupId}" onchange="toggleSelectAll(this, '${groupId}')" title="Pilih Semua">
                  <label for="select-all-${groupId}">Pilih Semua</label>
                </div>
                <h3>${guruRequest.name}</h3>
                <p>${guruRequest.school} - ${guruRequest.monthName}</p>
              </div>
              <div class="request-table-container">
                <table class="request-table">
                  <thead>
                    <tr>
                      <th style="width: 50px; text-align: center;"><i class="fa-solid fa-check"></i></th>
                      <th>Tanggal</th>
                      <th>Data Lama</th>
                      <th>Data Pengajuan (Baru)</th>
                    </tr>
                  </thead>
                  <tbody>
          `;

          guruRequest.changes.forEach(change => {
            html += `
              <tr data-request-id="${change.requestId}"> <td style="text-align: center; vertical-align: middle;">
                  <input type="checkbox" class="request-checkbox" data-request-id="${change.requestId}">
                </td>
                <td>${change.date}</td>
                <td>
                  <span class="data-label">Masuk:</span> <span class="data-old">${change.oldData.checkIn || '-'}</span><br>
                  <span class="data-label">Pulang:</span> <span class="data-old">${change.oldData.checkOut || '-'}</span><br>
                  <span class="data-label">Alasan:</span> <span class="data-old">${change.oldData.reason || '-'}</span>
                </td>
                <td>
                  <span class="data-label">Masuk:</span> <span class="data-new">${change.newData.checkIn || '-'}</span><br>
                  <span class="data-label">Pulang:</span> <span class="data-new">${change.newData.checkOut || '-'}</span><br>
                  <span class="data-label">Alasan:</span> <span class="data-new">${change.newData.reason || '-'}</span>
                </td>
              </tr>
            `;
          });

          html += `
                  </tbody>
                </table>
              </div>
              <div class="request-group-actions">
                 <button class="action-button" onclick="handleApproveRequest('${groupId}', event)">
                  <i class="fa-solid fa-check"></i> <span>Setujui Pilihan</span>
                </button>
                <button class="action-button reject-btn" onclick="openRejectionModal('${groupId}')">
                  <i class="fa-solid fa-times"></i> <span>Tolak Pilihan</span>
                </button>
              </div>
            </div>
          `;
        });

        container.innerHTML = html;
      }

      // --- TAMBAHAN FUNGSI BARU ---
      /**
       * (STAFF) Helper untuk mencentang/membatalkan semua checkbox dalam satu grup.
       */
      function toggleSelectAll(selectAllCheckbox, groupId) {
          const groupElement = document.getElementById(groupId);
          if (!groupElement) return;

          const checkboxes = groupElement.querySelectorAll('.request-table tbody input[type="checkbox"]');
          checkboxes.forEach(cb => {
              cb.checked = selectAllCheckbox.checked;
          });
      }

      // --- TAMBAHAN FUNGSI BARU ---
      /**
       * (STAFF) Helper untuk mengambil semua ID yang dicentang dalam satu grup.
       */
      function getSelectedRequestIds(groupId) {
          const groupElement = document.getElementById(groupId);
          if (!groupElement) return [];

          const selectedCheckboxes = groupElement.querySelectorAll('.request-table tbody input[type="checkbox"]:checked');
          
          const ids = [];
          selectedCheckboxes.forEach(cb => {
              ids.push(cb.dataset.requestId);
          });
          return ids;
      }

      /**
       * (STAFF) Dipanggil saat staff menekan 'Setujui'.
       * Membuka modal konfirmasi.
       * --- FUNGSI INI DIMODIFIKASI ---
       */
      function handleApproveRequest(groupId, event) {
        if (event) event.preventDefault();
        
        // Dapatkan hanya ID yang dipilih
        const selectedIds = getSelectedRequestIds(groupId);
        
        if (selectedIds.length === 0) {
            displayMessage('request-list-message', 'Silakan pilih minimal satu baris pengajuan untuk disetujui.');
            return;
        }

        // Panggil modal yang sudah ada dengan ID yang dipilih
        openApproveRequestModal(selectedIds);
      }

      // Fungsi untuk membuka modal persetujuan
      function openApproveRequestModal(requestIds) {
        document.getElementById('approve-count').textContent = requestIds.length;
        document.getElementById('approve-request-ids').value = JSON.stringify(requestIds);
        document.getElementById('approve-request-modal').style.display = 'block';
      }

      // Fungsi untuk menutup modal persetujuan
      function closeApproveRequestModal() {
        document.getElementById('approve-request-modal').style.display = 'none';
      }

      // Fungsi yang dipanggil saat tombol 'Ya, Setujui' di modal diklik
      function confirmApproveRequest() {
        const requestIds = JSON.parse(document.getElementById('approve-request-ids').value);
        closeApproveRequestModal(); // Tutup modal

        displayMessage('request-list-message', 'Menyetujui pengajuan...', { isProcessing: true });

        // Nonaktifkan tombol sementara di list (opsional)
        const actionButtons = document.querySelectorAll('.request-group-actions button');
        actionButtons.forEach(btn => btn.disabled = true);

        google.script.run
          .withSuccessHandler(response => {
            if (response.status === 'success') {
              displayMessage('request-list-message', 'Pengajuan berhasil disetujui!', { isSuccess: true });
              showChangeRequestPage(); // Muat ulang daftar
            } else {
              displayMessage('request-list-message', `Gagal: ${response.message}`);
              actionButtons.forEach(btn => btn.disabled = false); // Aktifkan lagi jika gagal
            }
          })
          .withFailureHandler(error => {
            displayMessage('request-list-message', `Error: ${error.message}`);
            actionButtons.forEach(btn => btn.disabled = false); // Aktifkan lagi jika error
          })
          .processChangeRequest(currentUser.email, requestIds, 'approve', null);
      }
      // --- AKHIR PERBAIKAN ---

      /**
       * (STAFF) Membuka modal untuk alasan penolakan.
       * --- FUNGSI INI DIMODIFIKASI ---
       */
      function openRejectionModal(groupId) {
        // Dapatkan hanya ID yang dipilih
        const selectedIds = getSelectedRequestIds(groupId);

        if (selectedIds.length === 0) {
            displayMessage('request-list-message', 'Silakan pilih minimal satu baris pengajuan untuk ditolak.');
            return;
        }

        document.getElementById('rejection-request-ids').value = JSON.stringify(selectedIds);
        document.getElementById('rejection-reason-input').value = '';
        document.getElementById('rejection-modal').style.display = 'block';
      }

      /**
       * (STAFF) Menutup modal alasan penolakan.
       */
      function closeRejectionModal() {
        document.getElementById('rejection-modal').style.display = 'none';
      }

      /**
       * (STAFF) Dipanggil saat staff mengirim alasan penolakan.
       */
      function handleSendRejection() {
        const requestIds = JSON.parse(document.getElementById('rejection-request-ids').value);
        const reason = document.getElementById('rejection-reason-input').value.trim();

        if (!reason) {
          alert('Alasan penolakan wajib diisi.');
          return;
        }

        closeRejectionModal();
        displayMessage('request-list-message', 'Memproses penolakan...', { isProcessing: true });

        // Nonaktifkan tombol sementara (opsional)
        const actionButtons = document.querySelectorAll('.request-group-actions button');
        actionButtons.forEach(btn => btn.disabled = true);


        google.script.run
          .withSuccessHandler(response => {
            if (response.status === 'success') {
              displayMessage('request-list-message', 'Pengajuan berhasil ditolak.', { isSuccess: true });
              showChangeRequestPage(); // Muat ulang daftar
            } else {
              displayMessage('request-list-message', `Gagal: ${response.message}`);
               actionButtons.forEach(btn => btn.disabled = false); // Aktifkan lagi
            }
          })
          .withFailureHandler(error => {
            displayMessage('request-list-message', `Error: ${error.message}`);
             actionButtons.forEach(btn => btn.disabled = false); // Aktifkan lagi
          })
          .processChangeRequest(currentUser.email, requestIds, 'reject', reason);
      }

      function loadAndRenderSummary() {
          const summaryMonthInput = document.getElementById('summary-month-input');

          if (!summaryMonthInput.value) {
              const today = new Date();
              const year = today.getFullYear();
              const month = today.getMonth() + 1;
              summaryMonthInput.value = `${year}-${String(month).padStart(2, '0')}`;
          }

          const [targetYear, targetMonth] = summaryMonthInput.value.split('-').map(Number);

          const summaryValues = document.querySelectorAll('.summary-value');
          // Tampilkan loading di ringkasan
          summaryValues.forEach(el => {
              el.innerHTML = '...';
              el.classList.add('loading-dots');
          });
          
          // --- PERBAIKAN: Logika Loading Kalender ---
          const calendarContainer = document.getElementById('calendar-view-container');
          const calendarLoadingP = document.getElementById('calendar-loading-message');
          
          calendarLoadingP.innerText = 'Memuat kalender...';
          calendarLoadingP.style.display = 'block'; // Tampilkan pesan loading
          calendarLoadingP.style.color = 'var(--text-secondary-color)'; // Warna standar
          calendarContainer.innerHTML = ''; // Kosongkan grid kalender lama
          // --- AKHIR PERBAIKAN ---

          google.script.run
              .withSuccessHandler(response => {
                  if (response.success) {
                      // --- AWAL PERUBAHAN ---
                      currentSummary = response.summary; // Simpan summary ke global
                      renderSummary(currentSummary);
                      // --- AKHIR PERUBAHAN ---
                      
                      // --- PERBAIKAN: Sukses, sembunyikan pesan loading ---
                      calendarLoadingP.style.display = 'none'; // Sembunyikan pesan
                      
                      renderCalendarView(
                          targetYear, 
                          targetMonth, 
                          response.attendanceData, // <-- Data baru dari backend
                          appSettings.holidays, 
                          appSettings.teacherHolidays
                      );
                      // --- AKHIR PERBAIKAN ---
                      
                      // --- AWAL PERUBAHAN ---
                      // Panggil fungsi pengumuman/pengingat dinamis
                      // Kirim appSettings global dan summary yang baru didapat
                      renderDynamicAnnouncements(appSettings, currentSummary);
                      // --- AKHIR PERUBAHAN ---
                      
                  } else {
                      console.error("Gagal memuat ringkasan:", response.error);
                      summaryValues.forEach(el => el.innerText = '-');
                      
                      // --- PERBAIKAN: Gagal, tampilkan pesan error ---
                      calendarLoadingP.innerText = 'Gagal memuat kalender.';
                      calendarLoadingP.style.display = 'block';
                      calendarLoadingP.style.color = 'var(--danger-color)'; // Warna error
                      calendarContainer.innerHTML = ''; // Pastikan grid kosong
                      // --- AKHIR PERBAIKAN ---
                  }
              })
              .withFailureHandler(error => {
                  console.error("Error server saat memuat ringkasan:", error.message);
                  summaryValues.forEach(el => {
                      el.classList.remove('loading-dots');
                      el.innerText = '-';
                  });
                  
                  // --- PERBAIKAN: Gagal, tampilkan pesan error ---
                  calendarLoadingP.innerText = 'Gagal memuat kalender: ' + error.message;
                  calendarLoadingP.style.display = 'block';
                  calendarLoadingP.style.color = 'var(--danger-color)'; // Warna error
                  calendarContainer.innerHTML = ''; // Pastikan grid kosong
                  // --- AKHIR PERBAIKAN ---
              })
              .getAttendanceSummary(currentUser.email, selectedSchool, targetYear, targetMonth);
      }

      function handleSummaryMonthChange() {
        loadAndRenderSummary();
      }

      function renderSummary(summary) {
          // --- AWAL PERUBAHAN ---
          // Hentikan animasi loading
          document.querySelectorAll('.summary-value').forEach(el => {
              el.classList.remove('loading-dots');
          });
          // --- AKHIR PERUBAHAN ---
          const kehadiranEl = document.getElementById('summary-kehadiran');
          const alpaEl = document.getElementById('summary-alpa');
          const alpaBox = alpaEl.parentElement;
          const persentaseEl = document.getElementById('summary-persentase');
          const ceklokEl = document.getElementById('summary-ceklok');
          const alasanEl = document.getElementById('summary-alasan');

          document.getElementById('summary-hari-kerja').innerText = summary.hariKerja;
          kehadiranEl.innerText = summary.kehadiran;
          alpaEl.innerText = summary.alpa;
          alasanEl.innerText = summary.alasan;
          persentaseEl.innerText = summary.persentase + '%';
          ceklokEl.innerText = summary.ceklok;

          const percentage = parseInt(summary.persentase);

          if (percentage === 100) {
              kehadiranEl.style.color = 'var(--success-color)';
              alasanEl.style.color = 'var(--success-color)';
          } else if (parseInt(summary.kehadiran) > 0) {
              kehadiranEl.style.color = 'var(--warning-color)';
              alasanEl.style.color = 'var(--primary-color)';
          } else {
              kehadiranEl.style.color = 'var(--danger-color)';
              alasanEl.style.color = 'var(--primary-color)';
          }

          // Logika untuk warna angka Alpa
          if (parseInt(summary.alpa) > 0) {
              alpaEl.style.color = 'var(--danger-color)';
          } else {
              alpaEl.style.color = 'var(--success-color)';
          }

          // Logika untuk menambahkan atau menghapus efek glow
          if (summary.alpaUpToToday > 0) {
              alpaBox.classList.add('alpa-warning');
          } else {
              alpaBox.classList.remove('alpa-warning');
          }

          let persentaseColor;
          if (percentage === 100) {
              persentaseColor = 'var(--success-color)';
          } else if (percentage >= 76) {
              persentaseColor = 'var(--warning-color)';
          } else {
              persentaseColor = 'var(--danger-color)';
          }
          persentaseEl.style.color = persentaseColor;
          ceklokEl.style.color = persentaseColor;

          // --- HAPUS BARIS DI BAWAH INI ---
          // renderCeklokReminder(summary); 
          // --- AKHIR PENGHAPUSAN ---
      }

      // --- TAMBAHAN BARU: Fungsi untuk Render Kalender ---
      function renderCalendarView(year, month, attendanceData, nationalHolidays, teacherHolidays) {
          const container = document.getElementById('calendar-view-container');
          attendanceData = attendanceData || {};
          nationalHolidays = nationalHolidays || {};
          teacherHolidays = teacherHolidays || [];
          
          const daysInMonth = new Date(year, month, 0).getDate();
          const firstDayOfWeek = new Date(year, month - 1, 1).getDay(); // 0=Minggu, 1=Senin
          
          const today = new Date();
          today.setHours(0, 0, 0, 0); // Set ke awal hari untuk perbandingan
          const todayStr = jsFormatDate(today); // Format "YYYY-MM-DD"

          let html = '<div class="calendar-grid">';
          
          // 1. Buat Header Nama Hari (Minggu, Senin, ...)
          const dayNames = ['Min', 'Sen', 'Sel', 'Rab', 'Kam', 'Jum', 'Sab'];
          dayNames.forEach(name => {
              html += `<div class="calendar-day-name">${name}</div>`;
          });
          
          // 2. Buat Sel Kosong sebelum hari pertama
          for (let i = 0; i < firstDayOfWeek; i++) {
              html += '<div class="calendar-day day-not-in-month"></div>';
          }
          
          // 3. Buat Sel untuk setiap hari di bulan
          for (let day = 1; day <= daysInMonth; day++) {
              const dateObj = new Date(year, month - 1, day); // Tanggal lokal
              const dateStr = jsFormatDate(dateObj); // "YYYY-MM-DD"
              const dayOfWeek = dateObj.getDay(); // 0=Minggu
              
              let dayClass = 'day-future'; // Default untuk hari biasa
              
              // --- AWAL PERUBAHAN: Memprioritaskan Hari Libur Nasional ---
              const isSunday = (dayOfWeek === 0);
              const isNationalHoliday = !!nationalHolidays[dateStr];
              const holidayDescription = nationalHolidays[dateStr]; // Ambil deskripsinya
              const isTeacherHoliday = (dayOfWeek > 0 && teacherHolidays[dayOfWeek - 1]); 
              
              let onClickHandler = ''; // Variabel untuk menyimpan event click

              // PERUBAHAN LOGIKA: Cek Libur Nasional (biru) DULU
              if (isNationalHoliday) {
                  dayClass = 'day-libur-nasional'; // <-- Class baru (biru)
                  if (holidayDescription) {
                      // Escape tanda kutip dalam deskripsi agar tidak merusak HTML
                      const escapedDescription = holidayDescription.replace(/'/g, "\\'").replace(/"/g, "&quot;");
                      onClickHandler = `onclick="showHolidayDetail(this, '${escapedDescription}')" style="cursor: pointer;"`;
                  }
              } 
              // Baru cek Minggu atau Libur Guru (abu-abu)
              else if (isSunday || isTeacherHoliday) {
                  dayClass = 'day-libur'; // <-- Class lama (abu-abu)
              }
              // --- AKHIR PERUBAHAN ---

              else {
                  // Jika bukan hari libur, cek data absensi
                  const entry = attendanceData[dateStr];
                  if (entry) {
                      if (entry.reason) {
                          dayClass = 'day-izin';
                      } else if (entry.checkIn && entry.checkOut) {
                          dayClass = 'day-hadir';
                      } else {
                          // Ada data tapi tidak lengkap (misal, hanya checkIn)
                          dayClass = 'day-alpa'; 
                      }
                  } else {
                      // Tidak ada data absensi
                      // Hanya tandai alpa jika tanggalnya sudah lewat
                      if (dateObj < today) {
                           dayClass = 'day-alpa';
                      } else {
                           // Biarkan 'day-future' (untuk hari ini atau masa depan)
                      }
                  }
              }
              
              // Tambahkan border khusus untuk hari ini
              let contentStyle = '';
              if (dateStr === todayStr) {
                  // Tambahkan style inline untuk menandai hari ini
                  contentStyle = 'border: 3px solid var(--primary-color); border-radius: 8px; box-shadow: 0 0 8px rgba(59, 130, 246, 0.5);';
              }

              html += `
                  <div class="calendar-day ${dayClass}" ${onClickHandler}> <div class="calendar-day-content" style="${contentStyle}">
                          ${day}
                      </div>
                  </div>
              `;
          }
          
          html += '</div>'; // Tutup .calendar-grid
          container.innerHTML = html;
      }
      // --- AKHIR TAMBAHAN BARU ---

      // --- TAMBAHAN BARU: Fungsi untuk Menampilkan Detail Hari Libur ---
      function showHolidayDetail(element, description) {
          // Hapus tooltip lama jika ada
          const oldTooltip = document.getElementById('calendar-tooltip');
          if (oldTooltip) {
              oldTooltip.remove();
          }

          // 1. Buat elemen tooltip
          const tooltip = document.createElement('div');
          tooltip.id = 'calendar-tooltip';
          tooltip.textContent = description;

          // 2. Tambahkan ke body
          document.body.appendChild(tooltip);

          // 3. Posisikan tooltip
          const rect = element.getBoundingClientRect(); // Posisi kotak tanggal
          const tooltipRect = tooltip.getBoundingClientRect(); // Ukuran tooltip

          // Coba posisikan di atas kotak tanggal
          let top = rect.top + window.scrollY - tooltipRect.height - 10; // 10px spacing
          let left = rect.left + window.scrollX + (rect.width / 2) - (tooltipRect.width / 2);

          // Cek jika mentok di atas (terlalu dekat ke top 0)
          if (top < window.scrollY + 10) { // Beri jarak 10px dari atas
              top = rect.bottom + window.scrollY + 10; // Pindahkan ke bawah
          }
          
          // Cek jika mentok di kiri
          if (left < window.scrollX + 10) {
              left = window.scrollX + 10;
          }
          
          // Cek jika mentok di kanan
          const screenWidth = document.documentElement.clientWidth;
          if (left + tooltipRect.width > window.scrollX + screenWidth - 10) {
              left = window.scrollX + screenWidth - tooltipRect.width - 10;
          }

          tooltip.style.top = `${top}px`;
          tooltip.style.left = `${left}px`;

          // 4. Buat agar bisa ditutup (jika diklik tooltipnya)
          tooltip.onclick = () => tooltip.remove();

          // 5. Hapus otomatis setelah beberapa detik
          setTimeout(() => {
              if (document.getElementById('calendar-tooltip')) {
                  tooltip.remove();
              }
          }, 4000); // 4 detik
      }
      // --- AKHIR TAMBAHAN BARU ---

      function renderTeacherHolidaySwitches() {
          const container = document.getElementById('holiday-switches-container');
          const days = ['Senin', 'Selasa', 'Rabu', 'Kamis', 'Jumat', 'Sabtu'];
          let html = '';
          days.forEach((day, index) => {
              html += `
                  <div class="switch-row">
                      <span>${day}</span>
                      <label class="switch">
                          <input type="checkbox" id="day-switch-${index}">
                          <span class="slider round"></span>
                      </label>
                  </div>
              `;
          });
          container.innerHTML = html;
      }

      function loadTeacherHolidays() {
        const button = document.getElementById('save-teacher-holidays-button');
        button.disabled = true;
        button.querySelector('span').textContent = 'Memuat...';
        displayMessage('teacher-holidays-message', 'Memuat pengaturan...', { isProcessing: true });

        // --- AWAL PERUBAHAN ---
        // 1. Pilih semua saklar/checkbox
        const switches = document.querySelectorAll('#holiday-switches-container input[type="checkbox"]');
        // 2. Nonaktifkan semua saklar saat memuat
        switches.forEach(sw => sw.disabled = true);
        // --- AKHIR PERUBAHAN ---

        google.script.run
            .withSuccessHandler(settings => {
                if (settings && settings.length === 6) {
                    settings.forEach((isHoliday, index) => {
                        const checkbox = document.getElementById(`day-switch-${index}`);
                        if (checkbox) checkbox.checked = isHoliday;
                    });
                }
                button.disabled = false;
                button.querySelector('span').textContent = 'Simpan Pengaturan';
                
                // --- AWAL PERUBAHAN ---
                // 3. Tampilkan pesan sukses
                displayMessage('teacher-holidays-message', 'Pengaturan hari libur berhasil dimuat.', { isSuccess: true });
                // 4. Aktifkan kembali semua saklar
                switches.forEach(sw => sw.disabled = false);
                // --- AKHIR PERUBAHAN ---
            })
            .withFailureHandler(err => {
                displayMessage('teacher-holidays-message', 'Gagal memuat pengaturan: ' + err.message);
                button.disabled = false;
                button.querySelector('span').textContent = 'Simpan Pengaturan';
                
                // --- AWAL PERUBAHAN ---
                // 5. Aktifkan juga saklar jika gagal, agar tidak terkunci
                switches.forEach(sw => sw.disabled = false);
                // --- AKHIR PERUBAHAN ---
            })
            .getTeacherHolidays(currentUser.email);
      }

      function handleSaveTeacherHolidays() {
          const button = document.getElementById('save-teacher-holidays-button');
          const settings = [];
          for (let i = 0; i < 6; i++) {
              settings.push(document.getElementById(`day-switch-${i}`).checked);
          }
          button.disabled = true;
          button.querySelector('span').textContent = 'Menyimpan...';
          displayMessage('teacher-holidays-message', 'Menyimpan...', { isProcessing: true });

          google.script.run
              .withSuccessHandler(response => {
                  displayMessage('teacher-holidays-message', response.message, { isSuccess: true });
                  button.disabled = false;
                  button.querySelector('span').textContent = 'Simpan Pengaturan';
              })
              .withFailureHandler(err => {
                  displayMessage('teacher-holidays-message', 'Gagal menyimpan: ' + err.message);
                  button.disabled = false;
                  button.querySelector('span').textContent = 'Simpan Pengaturan';
              })
              .saveTeacherHolidays(currentUser.email, settings);
      }

      function handleEmisImport() {
          const fileInput = document.getElementById('emis-file-input');
          const file = fileInput.files[0];
          if (!file) {
              displayMessage('emis-import-message', 'Silakan pilih file terlebih dahulu.');
              return;
          }
          const button = document.getElementById('import-emis-button');
          button.disabled = true;
          button.querySelector('span').textContent = 'Mengimpor...';
          displayMessage('emis-import-message', 'Sedang mengunggah dan memproses file...', { isProcessing: true });

          const schoolForImport = (currentUser.role === 'staff' && selectedTeacherForStaff) ? selectedTeacherForStaff.school : selectedSchool;
          const targetEmail = (currentUser.role === 'staff' && selectedTeacherForStaff) ? selectedTeacherForStaff.email : currentUser.email;

          const reader = new FileReader();
          reader.onload = (e) => {
              const data = e.target.result.split(',');
              const fileData = {
                  fileName: file.name,
                  mimeType: file.type,
                  data: data[1]
              };

              google.script.run
                  .withSuccessHandler(response => {
                      button.disabled = false;
                      button.querySelector('span').textContent = 'Proses Import';
                      if (response.status === 'success') {
                          const successMsg = `Berhasil mengimpor ${response.count} data untuk bulan ${response.monthName}. Anda akan dialihkan...`;
                          displayMessage('emis-import-message', successMsg, { isSuccess: true });

                          setTimeout(() => {
                              currentDate = new Date(response.year, response.month - 1, 1);
                              fileInput.value = "";
                              if (currentUser.role === 'staff') {
                                showCeklokPageForStaff(true);
                              } else {
                                showCeklokPage();
                              }
                          }, 4000);
                      } else {
                          displayMessage('emis-import-message', response.message);
                      }
                  })
                  .withFailureHandler(error => {
                      displayMessage('emis-import-message', 'Error: ' + error.message);
                      button.disabled = false;
                      button.querySelector('span').textContent = 'Proses Import';
                  })
                  .importFromEmis(targetEmail, schoolForImport, fileData);
          };
          reader.readAsDataURL(file);
      }

      function handleEmisExport() {
        const monthInput = document.getElementById('emis-export-month').value;
        const lockIdInput = document.getElementById('lock-id-input').value;
        const button = document.getElementById('export-emis-button');
        const schoolForExport = (currentUser.role === 'staff' && selectedTeacherForStaff) ? selectedTeacherForStaff.school : selectedSchool;
        const targetEmail = (currentUser.role === 'staff' && selectedTeacherForStaff) ? selectedTeacherForStaff.email : currentUser.email;

        if (!monthInput) {
          displayMessage('emis-export-message', 'Silakan pilih bulan dan tahun terlebih dahulu.');
          return;
        }
        if (!lockIdInput) {
          displayMessage('emis-export-message', 'Silakan masukkan LOCK ID Awal.');
          return;
        }

        button.disabled = true;
        button.querySelector('span').textContent = 'Membuat File...';
        displayMessage('emis-export-message', 'Sedang memproses & membuat file Excel, mohon tunggu...', { isProcessing: true });

        google.script.run
          .withSuccessHandler(response => {
            if (response.status === "success") {
              const link = document.createElement('a');
              link.href = `data:application/vnd.openxmlformats-officedocument.spreadsheetml.sheet;base64,${response.fileData}`;
              link.download = response.fileName;
              document.body.appendChild(link);
              link.click();
              document.body.removeChild(link);
              displayMessage('emis-export-message', 'File Excel berhasil dibuat dan sedang diunduh!', { isSuccess: true });
            } else {
              displayMessage('emis-export-message', 'Error: ' + response.message);
            }
            button.disabled = false;
            button.querySelector('span').textContent = 'Download Template';
          })
          .withFailureHandler(error => {
            displayMessage('emis-export-message', 'Error: ' + error.message);
            button.disabled = false;
            button.querySelector('span').textContent = 'Download Template';
          })
          .exportToExcel(targetEmail, schoolForExport, monthInput, lockIdInput);
      }

      function showAllTeacherSummary(push = true) {
        hideAllContainers_(); // (PERUBAHAN)
        document.getElementById("all-teachers-summary-container").style.display = "block";

        // --- TAMBAHKAN BARIS INI ---
        if (push) {
          history.pushState({ page: 'all-summary' }, 'Ringkasan Sekolah', '#all-summary');
        }
        // --- AKHIR TAMBAHAN ---

        document.getElementById("all-teachers-summary-title").innerText = `Ringkasan Kehadiran - ${selectedSchool}`;
        loadAllTeacherSummaryData();
      }

      function loadAllTeacherSummaryData() {
          const monthInput = document.getElementById('all-teachers-summary-month-input');
          if (!monthInput.value) {
            const now = new Date();
            monthInput.value = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
          }
          const [year, month] = monthInput.value.split('-').map(Number);
          const container = document.getElementById('all-teachers-summary-table-container');
          // --- PERUBAHAN DIMULAI ---
          container.innerHTML = `
            <div class="loader-container">
              <div class="loader">
                <div class="ball"></div>
                <div class="ball"></div>
                <div class="ball"></div>
              </div>
              <p>Memuat ringkasan, mohon tunggu...</p>
            </div>`;
          // --- PERUBAHAN SELESAI ---

          google.script.run
            .withSuccessHandler(summaries => {
              renderAllTeacherSummaryTable(summaries);
            })
            .withFailureHandler(err => {
              container.innerHTML = `<p style="color: var(--danger-color);">Gagal memuat: ${err.message}</p>`;
            })
            .getSchoolAttendanceSummary(currentUser.email, selectedSchool, year, month);
      }

      function renderAllTeacherSummaryTable(summaries) {
        const container = document.getElementById('all-teachers-summary-table-container');
        const legendContainer = document.getElementById('summary-legend');

        let tableHTML = '<div class="table-scroll-wrapper"><table id="all-teachers-summary-table"><thead><tr><th>Nama Guru</th><th>Persentase</th><th>Hari Kerja</th><th>Hadir</th><th>Alpa</th><th>Alasan</th><th>Ceklok</th></tr></thead><tbody>';

        if (summaries && summaries.length > 0) {
          summaries.forEach(item => {
            // --- AWAL PERUBAHAN ---
            let rowClass = '';
            if (item.summary.persentase === 100) {
              rowClass = 'summary-row-complete';
            } else {
              rowClass = 'summary-row-incomplete';
            }

            tableHTML += `
              <tr class="${rowClass}">
                <td>${item.name}</td>
                <td>${item.summary.persentase}%</td>
                <td>${item.summary.hariKerja}</td>
                <td>${item.summary.kehadiran}</td>
                <td>${item.summary.alpa}</td>
                <td>${item.summary.alasan}</td>
                <td>${item.summary.ceklok}</td>
              </tr>
            `;
            // --- AKHIR PERUBAHAN ---
          });

          // --- AWAL PERUBAHAN UNTUK LEGENDA ---
          legendContainer.innerHTML = `
            <div class="legend-item">
              <div class="legend-color-box green"></div>
              <span>Lengkap (100%)</span>
            </div>
            <div class="legend-item">
              <div class="legend-color-box red"></div>
              <span>Belum Lengkap</span>
            </div>
          `;
          // --- AKHIR PERUBAHAN UNTUK LEGENDA ---

        } else {
          tableHTML += '<tr><td colspan="7">Tidak ada data guru untuk ditampilkan.</td></tr>';
          legendContainer.innerHTML = ''; // Kosongkan legenda jika tidak ada data
        }

        tableHTML += '</tbody></table></div>';
        container.innerHTML = tableHTML;
      }

      // ===================================================================
      // LOGIKA UNTUK STAFF (FUNGSI DIMODIFIKASI)
      // ===================================================================
      function showStaffDashboard(userData, isLogin = false) {
          if (userData) currentUser = userData;
          hideAllContainers_(); // (PERUBAHAN)
          document.getElementById("staff-dashboard-container").style.display = "block";

          // MODIFIKASI DIMULAI DI SINI
          const welcomeH2 = document.getElementById('staff-welcome-message');
          let welcomeHTML = `Halo Staff, <strong>${currentUser.name}</strong>`;

          if (currentUser.schools && currentUser.schools.length > 1) {
            welcomeHTML += `<br><small id="school-switcher-link" onclick="openSchoolSwitcherModal()">${selectedSchool}</small>`;
          } else {
            welcomeHTML += `<br><small>${selectedSchool}</small>`;
          }
          welcomeH2.innerHTML = welcomeHTML;
          // MODIFIKASI SELESAI

          loadSchoolTeachers();
          loadStaffSummary();

          // Tampilkan loading untuk pengumuman staff
          const p = document.getElementById('staff-announcement-text');
          
          // --- AWAL PERUBAHAN LOGIKA CACHING v2 (STAFF) ---
          const staffAnnounceP = document.getElementById('staff-announcement-text');
          
          if (cachedAnnouncements === null) {
            // Load pertama kali
            console.log("Cache pengumuman staff kosong, mengambil data baru...");
            staffAnnounceP.innerHTML = `<div class="message-with-loader" style="justify-content: left;"><div class="message-loader"></div><span>Memuat pengumuman...</span></div>`;

            google.script.run
              .withSuccessHandler(response => {
                // Simpan data
                cachedAnnouncements = response.announcements;
                currentAnnouncementTimestamp = response.announcementTimestamp || '0';
                
                // Render
                staffAnnounceP.innerText = (cachedAnnouncements && cachedAnnouncements.trim() !== "") ? cachedAnnouncements : "Tidak ada pengumuman saat ini.";
                
                // Mulai polling untuk Staff juga
                startSettingsPolling(); 
              })
              .getAppSettingsForUser(currentUser.email, selectedSchool, currentDate.getFullYear(), currentDate.getMonth() + 1);
          
          } else {
            // Kembali ke dasbor (cache sudah ada)
            console.log("Menggunakan cache pengumuman staff.");
            staffAnnounceP.innerText = (cachedAnnouncements && cachedAnnouncements.trim() !== "") ? cachedAnnouncements : "Tidak ada pengumuman saat ini.";
            // Polling seharusnya sudah berjalan, tidak perlu start lagi.
          }
          // --- AKHIR PERUBAHAN LOGIKA CACHING v2 (STAFF) ---

          // --- (PERUBAHAN) Logika History ---
          if (isLogin) {
            history.replaceState({ page: 'dashboard' }, 'Dashboard', '#dashboard');
          }
      }

      function loadSchoolTeachers() {
        const selectCeklok = document.getElementById('staff-teacher-select-ceklok');
        const selectEmis = document.getElementById('staff-teacher-select-emis');
        selectCeklok.innerHTML = '<option value="">-- Memuat Guru --</option>';
        selectEmis.innerHTML = '<option value="">-- Memuat Guru --</option>';

        google.script.run
          .withSuccessHandler(teachers => {
            schoolTeachers = teachers;
            selectCeklok.innerHTML = '<option value="">-- Pilih Guru --</option>';
            selectEmis.innerHTML = '<option value="">-- Pilih Guru --</option>';
            teachers.forEach(teacher => {
              const option = document.createElement('option');
              option.value = teacher.email;
              option.textContent = teacher.name;
              selectCeklok.appendChild(option.cloneNode(true));
              selectEmis.appendChild(option);
            });
          })
          // MODIFIKASI DI SINI: tambahkan 'selectedSchool'
          .getSchoolTeachers(currentUser.email, selectedSchool);
      }

      function loadStaffSummary() {
          const monthInput = document.getElementById('staff-summary-month-input');
          if (!monthInput.value) {
            const now = new Date();
            monthInput.value = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
          }
          const [year, month] = monthInput.value.split('-').map(Number);
          const container = document.getElementById('staff-summary-table-container');
          // --- PERUBAHAN DIMULAI ---
          container.innerHTML = `
            <div class="loader-container">
              <div class="loader">
                <div class="ball"></div>
                <div class="ball"></div>
                <div class="ball"></div>
              </div>
              <p>Memuat ringkasan, mohon tunggu...</p>
            </div>`;
          // --- PERUBAHAN SELESAI ---

          google.script.run
            .withSuccessHandler(summaries => {
              renderStaffSummaryTable(summaries);
            })
            .withFailureHandler(err => {
              container.innerHTML = `<p style="color: var(--danger-color);">Gagal memuat: ${err.message}</p>`;
            })
            // MODIFIKASI DI SINI: tambahkan 'selectedSchool'
            .getSchoolAttendanceSummary(currentUser.email, selectedSchool, year, month);
      }

      function renderStaffSummaryTable(summaries) {
        const container = document.getElementById('staff-summary-table-container');
        let tableHTML = '<div class="table-scroll-wrapper"><table id="staff-summary-table"><thead><tr><th>Nama Guru</th><th>Persentase</th><th>Hari Kerja</th><th>Hadir</th><th>Alpa</th><th>Alasan</th><th>Ceklok</th></tr></thead><tbody>';
        if (summaries && summaries.length > 0) {
          summaries.forEach(item => {
            tableHTML += `
              <tr>
                <td>${item.name}</td>
                <td>${item.summary.persentase}%</td>
                <td>${item.summary.hariKerja}</td>
                <td>${item.summary.kehadiran}</td>
                <td>${item.summary.alpa}</td>
                <td>${item.summary.alasan}</td>
                <td>${item.summary.ceklok}</td>
              </tr>
            `;
          });
        } else {
          tableHTML += '<tr><td colspan="7">Tidak ada data guru untuk ditampilkan.</td></tr>';
        }
        tableHTML += '</tbody></table></div>';
        container.innerHTML = tableHTML;
      }

      function getSelectedTeacher(selectId) {
          const select = document.getElementById(selectId);
          const email = select.value;
          if (!email) {
              return null;
          }
          return schoolTeachers.find(t => t.email === email);
      }

      function showCeklokPageForStaff(forceReload = false, push = true) {
        // Cek guru yang dipilih
        if (!forceReload) {
          // Jika ini BUKAN reload paksa, ambil guru dari dropdown Ceklok
          selectedTeacherForStaff = getSelectedTeacher('staff-teacher-select-ceklok');
          if (!selectedTeacherForStaff) {
            displayMessage('staff-ceklok-message', 'Silakan pilih seorang guru terlebih dahulu untuk mengisi ceklok.');
            return;
          }
        }

        // Pastikan (lagi) bahwa ada guru yang terpilih
        //    (Ini penting untuk kasus 'forceReload' dimana guru harus sudah di-set sebelumnya)
        if (!selectedTeacherForStaff) {
           displayMessage('staff-ceklok-message', 'Terjadi kesalahan, guru tidak terpilih. Silakan kembali dan pilih guru.');
           // Kembalikan ke dasbor jika terjadi error
           showDashboardBasedOnRole_(false); // (PERUBAHAN)
           return;
        }

        hideAllContainers_(); // (PERUBAHAN)
        document.getElementById("ceklok-container").style.display = "block";

        // --- TAMBAHKAN BARIS INI ---
        if (push) {
          history.pushState({ page: 'ceklok-staff' }, 'Ceklok Staff', '#ceklok-staff');
        }
        
        // Atur judul halaman Ceklok
        document.getElementById('ceklok-title').innerText = `Formulir Kehadiran - ${selectedTeacherForStaff.school}`;
        document.getElementById('ceklok-teacher-name').innerText = `Untuk: ${selectedTeacherForStaff.name}`;

        // Bersihkan pesan geo-lock (jika ada)
        const geoMessage = document.getElementById('geo-lock-message');
        if (geoMessage) {
            geoMessage.style.display = 'none';
        }

        // Muat data absensi untuk guru yang dipilih
        loadMonthData(currentDate);
      }

      function showEmisImportPageForStaff(push = true) {
          selectedTeacherForStaff = getSelectedTeacher('staff-teacher-select-emis');
          if (!selectedTeacherForStaff) {
            displayMessage('staff-emis-message', 'Silakan pilih seorang guru terlebih dahulu untuk import.');
            return;
          }

          hideAllContainers_(); // (PERUBAHAN)
          document.getElementById("emis-import-container").style.display = "block";

          // --- TAMBAHKAN BARIS INI ---
          if (push) {
            history.pushState({ page: 'emis-import-staff' }, 'Import EMIS Staff', '#emis-import-staff');
          }
          // --- AKHIR TAMBAHAN ---

          document.getElementById('emis-import-title').innerText = `Import Data Kehadiran EMIS - ${selectedTeacherForStaff.school}`;
          document.getElementById('emis-import-teacher-name').innerText = `Untuk: ${selectedTeacherForStaff.name}`;
      }

      function showEmisExportPageForStaff(push = true) {
          selectedTeacherForStaff = getSelectedTeacher('staff-teacher-select-emis');
          if (!selectedTeacherForStaff) {
            displayMessage('staff-emis-message', 'Silakan pilih seorang guru terlebih dahulu untuk eksport.');
            return;
          }

          hideAllContainers_(); // (PERUBAHAN)
          document.getElementById("emis-export-container").style.display = "block";

          // --- TAMBAHKAN BARIS INI ---
          if (push) {
            history.pushState({ page: 'emis-export-staff' }, 'Eksport EMIS Staff', '#emis-export-staff');
          }
          // --- AKHIR TAMBAHAN ---

          document.getElementById('emis-export-title').innerText = `Eksport Data Kehadiran - ${selectedTeacherForStaff.school}`;
          document.getElementById('emis-export-teacher-name').innerText = `Untuk: ${selectedTeacherForStaff.name}`;
      }

      function handleStaffDownloadAllRekap() {
          const monthInput = document.getElementById('staff-rekap-month').value;
          const button = document.getElementById('staff-download-all-rekap-button');
          if (!monthInput) {
              displayMessage('staff-rekap-all-message', 'Silakan pilih bulan dan tahun terlebih dahulu.');
              return;
          }
          button.disabled = true;
          button.querySelector('span').textContent = 'Membuat PDF...';
          displayMessage('staff-rekap-all-message', 'Sedang memproses rekap semua guru...', { isProcessing: true });
          google.script.run
              .withSuccessHandler(response => {
                  if (response.success) {
                      const link = document.createElement('a');
                      link.href = `data:application/pdf;base64,${response.pdfData}`;
                      link.download = response.fileName;
                      document.body.appendChild(link);
                      link.click();
                      document.body.removeChild(link);
                      displayMessage('staff-rekap-all-message', 'PDF berhasil dibuat dan sedang diunduh!', { isSuccess: true });
                  } else {
                      displayMessage('staff-rekap-all-message', 'Error: ' + response.error);
                  }
                  button.disabled = false;
                  button.querySelector('span').textContent = 'Unduh Rekap Semua Guru';
              })
              .withFailureHandler(error => {
                  displayMessage('staff-rekap-all-message', 'Error: ' + error.message);
                  button.disabled = false;
                  button.querySelector('span').textContent = 'Unduh Rekap Semua Guru';
              })
              .prepareSchoolRekapForPrint(currentUser.email, monthInput, selectedSchool);
      }


      // ===================================================================
      // LOGIKA UNTUK ADMIN
      // ===================================================================
      function showAdminDashboard(userData, isLogin = false) {
        if (userData) currentUser = userData;
        hideAllContainers_(); // (PERUBAHAN)
        document.getElementById("admin-container").style.display = "block";

        // --- (PERUBAHAN) Logika History ---
        if (isLogin) {
          history.replaceState({ page: 'dashboard' }, 'Dashboard', '#dashboard');
        }

        document.getElementById("admin-welcome-message").innerHTML = `Halo Admin, <strong>${currentUser.name}</strong>`;
        loadUsers();
        loadAdminSettings();
        loadSchoolDropdown();
      }

      function loadUsers() {
        document.getElementById('user-table-container').innerHTML = `
            <div class="loader-container">
              <div class="loader"><div class="ball"></div><div class="ball"></div><div class="ball"></div></div>
              <p>Memuat daftar akun...</p>
            </div>`;
        google.script.run.withSuccessHandler(renderUserTable).getUsers(currentUser.email);
      }

      function renderUserTable(users) {
        const container = document.getElementById('user-table-container');
        let tableHTML = '<table><thead><tr><th>Email</th><th>Nama</th><th>Sekolah</th><th>Peran</th><th>Aksi</th></tr></thead><tbody>';
        if (users && users.length > 0) {
          users.forEach(user => {
            const userStr = JSON.stringify(user).replace(/'/g, "&apos;").replace(/"/g, "&quot;");
            tableHTML += `<tr><td>${user.email}</td><td>${user.name}</td><td>${user.school}</td><td>${user.role}</td><td><button onclick='openUserForm(${userStr})'>Edit</button><button class="clear-btn" onclick="handleUserDelete('${user.email}')">Hapus</button></td></tr>`;
          });
        } else {
          tableHTML += `<tr><td colspan="5">Tidak ada data akun.</td></tr>`;
        }
        tableHTML += '</tbody></table>';
        container.innerHTML = tableHTML;
      }

      function openUserForm(user = null) {
        const modal = document.getElementById('user-form-modal');
        modal.querySelector('#user-form-message').innerText = "";
        modal.querySelector('#original-email').value = user ? user.email : '';
        modal.querySelector('#user-email').value = user ? user.email : '';
        modal.querySelector('#user-password').value = user ? user.password : '';
        modal.querySelector('#user-name').value = user ? user.name : '';
        modal.querySelector('#user-school').value = user ? user.school : '';
        modal.querySelector('#user-role').value = user ? user.role : 'guru';
        modal.querySelector('#form-title').innerText = user ? 'Edit Akun' : 'Tambah Akun Baru';
        modal.querySelector('#user-email').disabled = !!user;
        modal.style.display = 'block';
      }

      function closeUserForm() {
        document.getElementById('user-form-modal').style.display = 'none';
      }

      function handleUserSave() {
        const userData = {
          originalEmail: document.getElementById('original-email').value,
          email: document.getElementById('user-email').value,
          password: document.getElementById('user-password').value,
          name: document.getElementById('user-name').value,
          school: document.getElementById('user-school').value,
          role: document.getElementById('user-role').value
        };
        const apiCall = userData.originalEmail ? 'updateUser' : 'addUser';

        displayMessage('user-form-message', 'Menyimpan...', { isProcessing: true });

        google.script.run.withSuccessHandler(r => {
          if (r.status === 'success') {
            displayMessage('user-form-message', r.message, { isSuccess: true });
            setTimeout(() => {
              closeUserForm();
              loadUsers();
            }, 1500);
          } else {
            displayMessage('user-form-message', r.message);
          }
        })[apiCall](currentUser.email, userData);
      }

      function handleUserDelete(email) {
        if (confirm(`Yakin ingin menghapus akun ${email}?`)) {
          // Tampilkan loading di tabel
          document.getElementById('user-table-container').innerHTML = `
            <div class="loader-container">
              <div class="loader"><div class="ball"></div><div class="ball"></div><div class="ball"></div></div>
              <p>Menghapus akun ${email}...</p>
            </div>`;
          google.script.run.withSuccessHandler(r => {
            if (r.status === 'success') loadUsers();
            else renderUserTable([]); // Jika gagal, render ulang (meskipun mungkin akan di-load ulang)
          }).deleteUser(currentUser.email, email);
        }
      }

      /**
       * ===================================================================
       * FUNGSI loadAdminSettings DIMODIFIKASI
       * ===================================================================
       * - Memuat dan menampilkan 'opened_months'.
       */
      function loadAdminSettings() {
        displayMessage('announcements-message', 'Memuat...', { isProcessing: true });
        displayMessage('locked-months-message', 'Memuat...', { isProcessing: true });
        displayMessage('opened-months-message', 'Memuat...', { isProcessing: true }); // Pesan loading baru
        displayMessage('request-day-limit-message', 'Memuat...', { isProcessing: true });
        displayMessage('last-month-ceklok-message', 'Memuat...', { isProcessing: true });
        displayMessage('lkh-last-day-message', 'Memuat...', { isProcessing: true }); // <-- BARIS BARU
        displayMessage('holidays-message', 'Memuat...', { isProcessing: true });
        loadJamRegulerSettings();

        google.script.run.withSuccessHandler(settings => {
          document.getElementById('locked-months').value = settings.lockedMonths.join(',');
          document.getElementById('opened-months').value = settings.openedMonths.join(','); // Tampilkan opened_months
          document.getElementById('request-day-limit').value = settings.requestDayLimit || '10';
          document.getElementById('last-month-ceklok-day-limit').value = settings.lastMonthCeklokDayLimit || '5'; // <-- MUAT NILAI BARU
          document.getElementById('lkh-last-day-limit').value = settings.lkhLastDayLimit || '5'; // <-- BARIS BARU
          document.getElementById('announcement-input').value = settings.announcements || "";
          const holidaysContainer = document.getElementById('holidays-container');
          if (settings.holidays && settings.holidays.length > 0) {
            settings.holidays.forEach(h => addHolidayRow(h.date, h.description));
          }
          // Hapus pesan loading
          displayMessage('announcements-message', '');
          displayMessage('locked-months-message', '');
          displayMessage('opened-months-message', ''); // Hapus pesan loading baru
          displayMessage('request-day-limit-message', '');
          displayMessage('last-month-ceklok-message', '');
          displayMessage('lkh-last-day-message', ''); // <-- BARIS BARU
          displayMessage('holidays-message', '');
        }).getSettings(currentUser.email);
      }

      function addHolidayRow(date = '', description = '') {
        const container = document.getElementById('holidays-container');
        const newRow = document.createElement('div');
        newRow.className = 'holiday-input-row';
        newRow.innerHTML = `<div style="display:flex; gap:10px; margin-bottom:10px;"><input type="date" value="${date}" style="flex-grow:1;"><input type="text" placeholder="Keterangan" value="${description}" style="flex-grow:2;"><button class="clear-btn" onclick="this.parentElement.remove()">X</button></div>`;
        container.appendChild(newRow);
      }

      function saveLockedMonthsSettings() {
        const input = document.getElementById('locked-months').value;
        const months = input.split(',').map(s => s.trim()).filter(Boolean).filter(m => /^\d{4}-\d{2}$/.test(m)); // Validasi format
        displayMessage('locked-months-message', 'Menyimpan...', { isProcessing: true });
        google.script.run.withSuccessHandler(r => displayMessage('locked-months-message', r.message, { isSuccess: true })).saveLockedMonths(currentUser.email, months);
      }

      // --- FUNGSI BARU UNTUK ADMIN: Menyimpan opened_months ---
      function saveOpenedMonthsSettings() {
        const input = document.getElementById('opened-months').value;
        const months = input.split(',').map(s => s.trim()).filter(Boolean).filter(m => /^\d{4}-\d{2}$/.test(m)); // Validasi format YYYY-MM
        displayMessage('opened-months-message', 'Menyimpan...', { isProcessing: true });
        google.script.run.withSuccessHandler(r => {
            displayMessage('opened-months-message', r.message, { isSuccess: r.status === 'success' });
        }).saveOpenedMonths(currentUser.email, months);
      }
      // --- AKHIR FUNGSI BARU ---

      // --- FUNGSI BARU ---
      function saveRequestDayLimitSettings() {
        const dayLimit = document.getElementById('request-day-limit').value;
        displayMessage('request-day-limit-message', 'Menyimpan...', { isProcessing: true });
        google.script.run
          .withSuccessHandler(r => {
            displayMessage('request-day-limit-message', r.message, { isSuccess: r.status === 'success' });
          })
          .saveRequestDayLimit(currentUser.email, dayLimit);
      }
      // --- AKHIR FUNGSI BARU ---

      function saveHolidaysSettings() {
        const rows = document.querySelectorAll('#holidays-container .holiday-input-row');
        const holidays = [];
        rows.forEach(row => {
          const date = row.querySelector('input[type="date"]').value;
          const description = row.querySelector('input[type="text"]').value;
          if (date && description) holidays.push({ date, description });
        });
        displayMessage('holidays-message', 'Menyimpan...', { isProcessing: true });
        google.script.run.withSuccessHandler(r => displayMessage('holidays-message', r.message, { isSuccess: true })).saveHolidays(currentUser.email, holidays);
      }

      function saveAnnouncementsSettings() {
        const text = document.getElementById('announcement-input').value;
        displayMessage('announcements-message', 'Menyimpan...', { isProcessing: true });
        google.script.run.withSuccessHandler(r => displayMessage('announcements-message', r.message, { isSuccess: true })).saveAnnouncements(currentUser.email, text);
      }

      function loadJamRegulerSettings() {
        const container = document.getElementById('jam-reguler-container');
        const button = document.getElementById('save-jam-reguler-button');
        
        container.innerHTML = `
          <div class="loader-container" style="padding: 20px 0;">
            <div class="loader"><div class="ball"></div><div class="ball"></div><div class="ball"></div></div>
            <p>Memuat jam reguler...</p>
          </div>`;
        button.disabled = true;

        google.script.run
          .withSuccessHandler(settings => {
            container.innerHTML = ''; // Hapus loader
            if (settings && settings.length > 0) {
              settings.forEach(setting => {
                const row = document.createElement('div');
                row.className = 'input-group';
                row.innerHTML = `
                  <label>${setting.hari}</label>
                  <div style="display: flex; gap: 10px; flex-wrap: wrap;"> <input type="text" id="reg-masuk-${setting.hari}" placeholder="Jam Masuk (HH:MM)" value="${setting.masuk || ''}" oninput="handleTimeInput(event)" style="flex: 1 1 100px;">
                    <input type="text" id="reg-pulang-${setting.hari}" placeholder="Jam Pulang (HH:MM)" value="${setting.pulang || ''}" oninput="handleTimeInput(event)" style="flex: 1 1 100px;">
                    <input type="number" id="reg-waktu-lembur-${setting.hari}" placeholder="Grace Lembur (menit)" value="${setting.waktuLembur || '30'}" style="flex: 1 1 140px;" title="Waktu tunggu (menit) setelah jam pulang sebelum lembur dihitung.">
                    <input type="number" id="reg-maks-lembur-${setting.hari}" placeholder="Maks Lembur (menit)" value="${setting.maksimalLembur || '90'}" style="flex: 1 1 140px;" title="Batas maksimal lembur (menit) yang dihitung. Isi 0 untuk tanpa batas.">
                  </div>
                `;
                container.appendChild(row);
              });
            } else {
              container.innerHTML = `<p>Gagal memuat pengaturan jam reguler. Coba muat ulang.</p>`;
            }
            button.disabled = false;
          })
          .withFailureHandler(err => {
            container.innerHTML = `<p style="color: var(--danger-color);">Error: ${err.message}</p>`;
            button.disabled = false;
          })
          .getJamRegulerSettings(currentUser.email);
      }
      
      function handleSaveJamReguler() {
        const button = document.getElementById('save-jam-reguler-button');
        const settings = [];
        const days = ['Senin', 'Selasa', 'Rabu', 'Kamis', 'Jumat', 'Sabtu'];
        
        days.forEach(hari => {
          const masuk = document.getElementById(`reg-masuk-${hari}`).value;
          const pulang = document.getElementById(`reg-pulang-${hari}`).value;
          // Ambil nilai dari input baru
          const waktuLembur = document.getElementById(`reg-waktu-lembur-${hari}`).value;
          const maksimalLembur = document.getElementById(`reg-maks-lembur-${hari}`).value;
          
          // Kirim semua data ke server
          settings.push({ hari, masuk, pulang, waktuLembur, maksimalLembur });
        });
        
        button.disabled = true;
        displayMessage('jam-reguler-message', 'Menyimpan...', { isProcessing: true });
        
        google.script.run
          .withSuccessHandler(r => {
            displayMessage('jam-reguler-message', r.message, { isSuccess: r.status === 'success' });
            button.disabled = false;
          })
          .withFailureHandler(err => {
            displayMessage('jam-reguler-message', `Error: ${err.message}`);
            button.disabled = false;
          })
          .saveJamRegulerSettings(currentUser.email, settings);
      }      

      function loadSchoolDropdown() {
        const select = document.getElementById('rekap-school');
        select.innerHTML = '<option value="">-- Memuat Daftar Sekolah --</option>';
        google.script.run
            .withSuccessHandler(schools => {
                select.innerHTML = '<option value="">-- Pilih Sekolah --</option>';
                if (schools && schools.length > 0) {
                    schools.forEach(school => {
                        const option = document.createElement('option');
                        option.value = school;
                        option.textContent = school;
                        select.appendChild(option);
                    });
                } else {
                    select.innerHTML = '<option value="">Tidak ada data sekolah</option>';
                }
            })
            .withFailureHandler(err => {
                select.innerHTML = `<option value="">Gagal memuat sekolah</option>`;
            })
            .getSchoolList(currentUser.email);
      }

      function handleDownloadRekap() {
          const schoolInput = document.getElementById('rekap-school').value;
          const monthInput = document.getElementById('rekap-month').value;
          const button = document.getElementById('download-rekap-button');
          if (!schoolInput) {
              displayMessage('rekap-message', 'Silakan pilih sekolah terlebih dahulu.');
              return;
          }
          if (!monthInput) {
              displayMessage('rekap-message', 'Silakan pilih bulan dan tahun terlebih dahulu.');
              return;
          }
          button.disabled = true;
          button.querySelector('span').textContent = 'Membuat PDF...';
          displayMessage('rekap-message', 'Sedang memproses & membuat PDF, mohon tunggu...', { isProcessing: true });
          google.script.run
              .withSuccessHandler(response => {
                  if (response.success) {
                      const link = document.createElement('a');
                      link.href = `data:application/pdf;base64,${response.pdfData}`;
                      link.download = response.fileName;
                      document.body.appendChild(link);
                      link.click();
                      document.body.removeChild(link);
                      displayMessage('rekap-message', 'PDF berhasil dibuat dan sedang diunduh!', { isSuccess: true });
                  } else {
                      displayMessage('rekap-message', 'Error: ' + response.error);
                  }
                  button.disabled = false;
                  button.querySelector('span').textContent = 'Buat Rekap & Unduh';
              })
              .withFailureHandler(error => {
                  displayMessage('rekap-message', 'Error: ' + error.message);
                  button.disabled = false;
                  button.querySelector('span').textContent = 'Buat Rekap & Unduh';
              })
              .prepareMonthlyRekapForPrint(currentUser.email, monthInput, schoolInput);
      }

      function openTab(evt, tabName) {
        let i, tabcontent, tablinks;
        tabcontent = document.getElementsByClassName("tab-content");
        for (i = 0; i < tabcontent.length; i++) { tabcontent[i].style.display = "none"; }
        tablinks = document.getElementsByClassName("nav-tab");
        for (i = 0; i < tablinks.length; i++) { tablinks[i].className = tablinks[i].className.replace(" active", ""); }
        document.getElementById(tabName).style.display = "block";
        evt.currentTarget.className += " active";
      }

      // PERUBAHAN DIMULAI: Menyesuaikan fungsi unduh rekap guru
      function handleGuruDownloadRekap() {
          const monthInput = document.getElementById('guru-rekap-month').value;
          const button = document.getElementById('guru-download-rekap-button');
          if (!monthInput) {
              // Menargetkan ID pesan yang sudah digabung
              displayMessage('guru-rekap-message', 'Silakan pilih bulan dan tahun terlebih dahulu.');
              return;
          }
          button.disabled = true;
          button.querySelector('span').textContent = 'Membuat PDF...';
          displayMessage('guru-rekap-message', 'Sedang memproses & membuat PDF, mohon tunggu...', { isProcessing: true });
          google.script.run
              .withSuccessHandler(response => {
                  if (response.success) {
                      const link = document.createElement('a');
                      link.href = `data:application/pdf;base64,${response.pdfData}`;
                      link.download = response.fileName;
                      document.body.appendChild(link);
                      link.click();
                      document.body.removeChild(link);
                      displayMessage('guru-rekap-message', 'PDF berhasil dibuat dan sedang diunduh!', { isSuccess: true });
                  } else {
                      displayMessage('guru-rekap-message', 'Error: ' + response.error);
                  }
                  button.disabled = false;
                  button.querySelector('span').textContent = 'Buat & Unduh Rekap Saya';
              })
              .withFailureHandler(error => {
                  displayMessage('guru-rekap-message', 'Error: ' + error.message);
                  button.disabled = false;
                  button.querySelector('span').textContent = 'Buat & Unduh Rekap Saya';
              })
              .prepareMyRekapForPrint(currentUser.email, selectedSchool, monthInput);
      }

      function handleGuruDownloadAllRekap() {
          const monthInput = document.getElementById('guru-rekap-month').value;
          const button = document.getElementById('guru-download-all-rekap-button');
          if (!monthInput) {
              // Menargetkan ID pesan yang sudah digabung dan menggunakan pesan yang konsisten
              displayMessage('guru-rekap-message', 'Silakan pilih bulan dan tahun terlebih dahulu.');
              return;
          }
          if (!selectedSchool) {
              displayMessage('guru-rekap-message', 'Informasi sekolah Anda tidak ditemukan.');
              return;
          }
          button.disabled = true;
          button.querySelector('span').textContent = 'Membuat PDF...';
          displayMessage('guru-rekap-message', 'Sedang memproses rekap semua guru, ini mungkin perlu waktu lebih lama...', { isProcessing: true });
          google.script.run
              .withSuccessHandler(response => {
                  if (response.success) {
                      const link = document.createElement('a');
                      link.href = `data:application/pdf;base64,${response.pdfData}`;
                      link.download = response.fileName;
                      document.body.appendChild(link);
                      link.click();
                      document.body.removeChild(link);
                      displayMessage('guru-rekap-message', 'PDF berhasil dibuat dan sedang diunduh!', { isSuccess: true });
                  } else {
                      displayMessage('guru-rekap-message', 'Error: ' + response.error);
                  }
                  button.disabled = false;
                  button.querySelector('span').textContent = 'Unduh Rekap Semua Guru (Satu Sekolah)';
              })
              .withFailureHandler(error => {
                  displayMessage('guru-rekap-message', 'Error: ' + error.message);
                  button.disabled = false;
                  button.querySelector('span').textContent = 'Unduh Rekap Semua Guru (Satu Sekolah)';
              })
              .prepareSchoolRekapForPrint(currentUser.email, monthInput, selectedSchool);
      }
      // PERUBAHAN SELESAI

      function showLkhPage(push = true) {
        hideAllContainers_(); // (PERUBAHAN)
        document.getElementById("lkh-container").style.display = "block";

        if (push) {
          history.pushState({ page: 'lkh-page' }, 'Buat LKH', '#lkh-page');
        }
        
        const lkhMonthInput = document.getElementById('lkh-month-input');
        lkhMonthInput.value = ""; 

        forceUpdateSettings(null, 'update-settings-button');
      }

      function handleLkhMonthChange() {
        const monthInputValue = document.getElementById('lkh-month-input').value;

        // --- TAMBAHAN BARU ---
        // Bersihkan pesan lock/error lama saat bulan diganti
        const lockMessageEl = document.getElementById('lkh-lock-message');
        if (lockMessageEl) {
          lockMessageEl.innerHTML = ""; // <-- PERUBAHAN DI SINI
          lockMessageEl.className = "message";
        }
        // --- AKHIR TAMBAHAN ---

        if (monthInputValue) {
          const [year, month] = monthInputValue.split('-').map(Number);
          generateLkhForm(year, month);
        }
      }

      function generateLkhForm(year, month) {
          const container = document.getElementById('lkh-table-container');
          const saveButton = document.getElementById('save-lkh-button');

          // === AWAL PERUBAHAN ===
          const applyWeeklyButton = document.getElementById('apply-weekly-data-button');
          const clearButton = document.getElementById('clear-lkh-data-button'); // Ambil tombol baru
          const lockMessageEl = document.getElementById('lkh-lock-message'); // <-- Ambil elemen pesan

          // Reset pesan kunci (pastikan 'message' adalah kelas dasarnya)
          lockMessageEl.innerHTML = ""; // <-- PERUBAHAN DI SINI
          lockMessageEl.className = "message";

          applyWeeklyButton.disabled = true; // Pindahkan ini ke atas
          clearButton.disabled = true;     // Nonaktifkan tombol baru saat loading
          // === AKHIR PERUBAHAN ===

          // Tampilkan loading
          container.innerHTML = `
            <div class="loader-container">
              <div class="loader"><div class="ball"></div><div class="ball"></div><div class="ball"></div></div>
              <p>Memuat formulir LKH...</p>
            </div>`;
          saveButton.disabled = true;
          // applyWeeklyButton.disabled = true; (Sudah di atas)

          google.script.run
            .withSuccessHandler(response => {
              if (response.success) {
                renderLkhTable(response.workingDays, response.existingData, response.isLocked);
                
                // Nonaktifkan tombol berdasarkan status kunci
                saveButton.disabled = response.isLocked;
                applyWeeklyButton.disabled = response.isLocked; 
                // (Tombol clear akan di-handle oleh updateClearLkhButtonStatus)
                
                // --- AWAL PERBAIKAN LOGIKA TAMPILAN PESAN ---
                // Selalu tampilkan pesan jika ada (tidak kosong)
                if (response.lockMessage) { 
                  lockMessageEl.innerHTML = response.lockMessage; // <-- PERUBAHAN DI SINI
                  
                  if (response.isLocked) {
                    // Jika terkunci, beri warna merah (danger)
                    lockMessageEl.classList.add('danger-message');
                  } else {
                    // Jika tidak terkunci (berarti masih grace period), beri warna hijau (info)
                    lockMessageEl.classList.add('info-message'); 
                  }
                }
                // (Jika lockMessage kosong, CSS :empty akan menyembunyikannya)
                // --- AKHIR PERBAIKAN LOGIKA TAMPILAN PESAN ---
                
              } else {
                container.innerHTML = `<p style="color: var(--danger-color);">Gagal memuat data: ${response.error}</p>`;
                // Tampilkan error di pesan kunci juga
                lockMessageEl.innerHTML = response.error; // <-- PERUBAHAN DI SINI
                lockMessageEl.classList.add('danger-message');
              }
            })
            .withFailureHandler(err => {
              container.innerHTML = `<p style="color: var(--danger-color);">Gagal memuat: ${err.message}</p>`;
              lockMessageEl.innerHTML = err.message; // <-- PERUBAHAN DI SINI
              lockMessageEl.classList.add('danger-message');
            })
            .getLKHData(currentUser.email, selectedSchool, year, month);
      }

      // --- PERUBAHAN DI SINI: Tambahkan parameter 'isLocked' ---
      function renderLkhTable(workingDays, existingData, isLocked) {
        const container = document.getElementById('lkh-table-container');
        // Menambahkan header kolom "AKSI"
        let tableHTML = '<table><thead><tr><th>HARI / TANGGAL</th><th>URAIAN KEGIATAN</th><th>HASIL / OUTPUT</th><th>VOL</th><th>AKSI</th></tr></thead><tbody>';
        
        // --- BUAT ATRIBUT DISABLED ---
        const disabledAttr = isLocked ? 'disabled' : '';

        if (workingDays && workingDays.length > 0) {
          workingDays.forEach(day => {
            const data = existingData[day.date] || {};
            tableHTML += `
              <tr data-date="${day.date}">
                
                <td>${day.dayName},<br><strong>${day.formattedDate}</strong></td>
                
                <td><textarea rows="3" id="uraian-${day.date}" oninput="updateClearLkhButtonStatus()" ${disabledAttr}>${data.uraian || ''}</textarea></td>
                <td><textarea rows="3" id="hasil-${day.date}" oninput="updateClearLkhButtonStatus()" ${disabledAttr}>${data.hasil || ''}</textarea></td>
                <td><textarea id="vol-${day.date}" oninput="updateClearLkhButtonStatus()" ${disabledAttr}>${data.vol || ''}</textarea></td>
                <td><button class="clear-btn" onclick="handleClearLkhRow(event)" ${disabledAttr}>Hapus</button></td>

              </tr>
            `;
          });
        } else {
          // Menyesuaikan colspan karena ada 5 kolom sekarang
          tableHTML += '<tr><td colspan="5">Tidak ada hari kerja untuk bulan yang dipilih.</td></tr>';
        }
        tableHTML += '</tbody></table>';
        container.innerHTML = tableHTML;
        
        updateClearLkhButtonStatus(); // Memeriksa status tombol saat tabel pertama kali dimuat
      }

      function handleSaveLKH() {
        const button = document.getElementById('save-lkh-button');
        button.disabled = true;
        button.querySelector('span').textContent = "Menyimpan...";
        displayMessage('lkh-message', 'Menyimpan data LKH...', { isProcessing: true });

        const monthInputValue = document.getElementById('lkh-month-input').value;
        const [year, month] = monthInputValue.split('-').map(Number);
        const lkhData = {};
        const rows = document.querySelectorAll('#lkh-table-container tbody tr');

        rows.forEach(row => {
          const date = row.dataset.date;
          if (date) {
            const uraian = document.getElementById(`uraian-${date}`).value;
            const hasil = document.getElementById(`hasil-${date}`).value;
            const vol = document.getElementById(`vol-${date}`).value;
            lkhData[date] = { uraian, hasil, vol };
          }
        });

        google.script.run
          .withSuccessHandler(response => {
            if(response.status === 'success') {
              displayMessage('lkh-message', response.message, { isSuccess: true });

              // --- PERBAIKAN DIMULAI DI SINI ---
              // Kembalikan tombol ke keadaan normal SETELAH sukses
              button.disabled = false;
              button.querySelector('span').textContent = "Simpan LKH";
              // --- AKHIR PERBAIKAN ---

              // --- AWAL PERBAIKAN ---
              // Panggil fungsi yang memuat ulang data dari server.
              // Ini akan menyinkronkan klien dengan data terbaru setelah menyimpan.
              handleLkhMonthChange();
              // --- AKHIR PERBAIKAN ---

            } else {
              displayMessage('lkh-message', response.message);
              // Jika gagal, aktifkan kembali tombolnya secara manual
              button.disabled = false;
              button.querySelector('span').textContent = "Simpan LKH";
            }
          })
          .withFailureHandler(error => {
            displayMessage('lkh-message', 'Error: ' + error.message);
            button.disabled = false;
            button.querySelector('span').textContent = "Simpan LKH";
          })
          .saveLKHData(currentUser.email, selectedSchool, year, month, lkhData);
      }

      function showLkhViewPage(push = true) {
          hideAllContainers_(); // (PERUBAHAN)
          document.getElementById('lkh-view-container').style.display = 'block';

          if (push) {
            history.pushState({ page: 'lkh-view' }, 'Generate LKH', '#lkh-view');
          }

          const downloadButton = document.getElementById('download-lkh-pdf-button');
          const messageElement = document.getElementById('lkh-download-message');
          downloadButton.disabled = true;
          displayMessage('lkh-download-message', 'Memuat data pratinjau LKH...', { isProcessing: true });

          const lkhMonthInput = document.getElementById('lkh-view-month-input');
          
          if (!lkhMonthInput.value) {
              const today = new Date();
              const targetDate = new Date(); 
              
              if (today.getDate() < 6) {
                  targetDate.setMonth(targetDate.getMonth() - 1);
              }
              
              const year = targetDate.getFullYear();
              const month = String(targetDate.getMonth() + 1).padStart(2, '0');
              lkhMonthInput.value = `${year}-${month}`;
          }
          
          const selectedMonth = lkhMonthInput.value;
          const [year, month] = selectedMonth.split('-').map(Number);

          google.script.run
              .withSuccessHandler(response => {
                  if (response.success) {
                      const data = response.data;

                      document.getElementById('lkh-view-name').innerText = data.user.name || '-';
                      document.getElementById('lkh-view-nip').innerText = data.settings.nip || '-';
                      document.getElementById('lkh-view-jabatan').innerText = data.settings.jabatan || 'Guru';
                      document.getElementById('lkh-view-period').innerText = `${data.period.firstDay} - ${data.period.lastDay} (${data.lkhItems.length} Hari Kerja)`;
                      document.getElementById('lkh-view-place-date').innerText = `${data.settings.tempat || 'Butung'}, ${data.signatureDate}`;
                      document.getElementById('lkh-view-signature-name').innerText = data.user.name || '-';
                      document.getElementById('lkh-view-signature-nip').innerText = data.settings.nip || '-';
                      document.getElementById('lkh-view-headmaster-name').innerText = data.settings.namaKepala || '[Nama Kepala Madrasah]';
                      document.getElementById('lkh-view-headmaster-nip').innerText = data.settings.nipKepala || '-';

                      const tableBody = document.getElementById('lkh-view-table-body');
                      tableBody.innerHTML = '';
                      if (data.lkhItems.length > 0) {
                          data.lkhItems.forEach((item, index) => {
                              const row = `
                                  <tr>
                                      <td style="border: 1px solid black; padding: 8px; text-align: center;">${index + 1}</td>
                                      
                                      <td style="border: 1px solid black; padding: 8px;">${item.dayName},<br>${item.formattedDate}</td>
                                      <td style="border: 1px solid black; padding: 8px; white-space: pre-wrap;">${item.uraian}</td>
                                      <td style="border: 1px solid black; padding: 8px; white-space: pre-wrap;">${item.hasil}</td>
                                      <td style="border: 1px solid black; padding: 8px; text-align: center;">${item.vol}</td>
                                      <td style="border: 1px solid black; padding: 8px;"></td>
                                  </tr>
                              `;
                              tableBody.innerHTML += row;
                          });
                      } else {
                          tableBody.innerHTML = '<tr><td colspan="6" style="border: 1px solid black; padding: 8px; text-align: center;">Tidak ada data kegiatan untuk bulan ini.</td></tr>';
                      }

                      // --- AWAL PERUBAHAN LOGIKA VALIDASI ---
                      const validation = areLkhSettingsComplete(data.settings || {});

                      if (validation.complete) {
                          downloadButton.disabled = false;
                          messageElement.innerHTML = ''; // Hapus pesan <p> lama
                          displayMessage('lkh-download-message', 'Pratinjau siap. Klik untuk mengunduh.', { isSuccess: true });
                      } else {
                          downloadButton.disabled = true;
                          // --- PERUBAHAN DI SINI: Panggil formatMissingList ---
                          const missingList = formatMissingList(validation.missing);
                          
                          messageElement.innerHTML = `Tombol Unduh PDF akan aktif setelah Pengaturan Cetak dilengkapi.
                            <br>
                            <div class="missing-items-list">
                              Data yang perlu dilengkapi: ${missingList}.
                              <br>
                              <a href="#" onclick="event.preventDefault(); showSptjmSettingsPage(true);">Lengkapi Sekarang</a>
                            </div>`;
                          
                          // Hapus toast loading
                          displayMessage('lkh-download-message', 'Pratinjau dimuat, pengaturan belum lengkap.', { isSuccess: true });
                      }
                      // --- AKHIR PERUBAHAN LOGIKA VALIDASI ---

                  } else {
                      displayMessage('lkh-download-message', `Error: ${response.error}`);
                  }
              })
              .withFailureHandler(err => {
                  displayMessage('lkh-download-message', `Error: ${err.message}`);
              })
              .getLkhViewData(currentUser.email, selectedSchool, year, month);
      }

      function handleDownloadLkhPdf() {
          const button = document.getElementById('download-lkh-pdf-button');
          button.disabled = true;
          button.querySelector('span').textContent = 'Membuat PDF...';
          displayMessage('lkh-download-message', 'Sedang memproses & membuat PDF, mohon tunggu...', { isProcessing: true });

          // --- PERUBAHAN ---
          // Mengambil nilai bulan dari input di halaman LKH, bukan dari dasbor
          const monthInput = document.getElementById('lkh-view-month-input').value;
          // --- AKHIR PERUBAHAN ---

          google.script.run
              .withSuccessHandler(response => {
                  if (response.success) {
                      const link = document.createElement('a');
                      link.href = `data:application/pdf;base64,${response.pdfData}`;
                      link.download = response.fileName;
                      document.body.appendChild(link);
                      link.click();
                      document.body.removeChild(link);
                      displayMessage('lkh-download-message', 'PDF berhasil dibuat dan sedang diunduh!', { isSuccess: true });
                  } else {
                      displayMessage('lkh-download-message', 'Error: ' + response.error);
                  }
                  button.disabled = false;
                  button.querySelector('span').textContent = 'Unduh PDF';
              })
              .withFailureHandler(error => {
                  displayMessage('lkh-download-message', 'Error: ' + error.message);
                  button.disabled = false;
                  button.querySelector('span').textContent = 'Unduh PDF';
              })
              .generateLkhPdf(currentUser.email, selectedSchool, monthInput);
      }

      function handleLkhViewMonthChange() {
        showLkhViewPage();
      }

      function handleSptjmViewMonthChange() {
        showSptjmViewPage();
      }

      function handleApplyWeeklyData() {
        const button = document.getElementById('apply-weekly-data-button');

        // === AWAL PERUBAHAN ===
        const clearButton = document.getElementById('clear-lkh-data-button');
        
        button.disabled = true;
        clearButton.disabled = true; // Nonaktifkan tombol Bersihkan Data
        
        button.querySelector('span').textContent = 'Mengambil data...';
        // Ganti ID pesan ke ID yang baru
        displayMessage('lkh-action-message', 'Mengambil data mingguan...', { isProcessing: true });
        // === AKHIR PERUBAHAN ===

        google.script.run
          .withSuccessHandler(response => {
            if (response.success && response.existingData) {
              const weeklyData = response.existingData;
              const rows = document.querySelectorAll('#lkh-table-container tbody tr');
              let fieldsApplied = 0;

              rows.forEach(row => {
                const date = row.dataset.date;
                if (!date) return;

                const dayNameCell = row.querySelector('td');
                if (!dayNameCell) return;

                const dayName = dayNameCell.innerText.split(',')[0].trim();

                if (weeklyData[dayName]) {
                  const template = weeklyData[dayName];

                  const uraianTextarea = document.getElementById(`uraian-${date}`);
                  const hasilTextarea = document.getElementById(`hasil-${date}`);
                  const volTextarea = document.getElementById(`vol-${date}`);

                  if (uraianTextarea && uraianTextarea.value.trim() === '') {
                    uraianTextarea.value = template.uraian || '';
                    fieldsApplied++;
                  }
                  if (hasilTextarea && hasilTextarea.value.trim() === '') {
                    hasilTextarea.value = template.hasil || '';
                    fieldsApplied++;
                  }
                   if (volTextarea && volTextarea.value.trim() === '') {
                    volTextarea.value = template.vol || '';
                    fieldsApplied++;
                  }
                }
              });

              if (fieldsApplied > 0) {
                 // Ganti ID pesan
                 displayMessage('lkh-action-message', `Data mingguan berhasil diterapkan.`, { isSuccess: true });
              } else {
                 // Ganti ID pesan
                 displayMessage('lkh-action-message', 'Semua isian sudah terisi.', { isSuccess: true });
              }

              // === TAMBAHKAN BARIS INI ===
              updateClearLkhButtonStatus(); // Perbarui status tombol setelah data diterapkan

            } else {
              // Ganti ID pesan
              displayMessage('lkh-action-message', 'Gagal mengambil data mingguan atau tidak ada data tersimpan.');
            }
            button.disabled = false;
            button.querySelector('span').textContent = 'Ambil Data Mingguan';
            
            // === AWAL PERUBAHAN ===
            // Panggil update status untuk meng-evaluasi ulang tombol Bersihkan Data
            updateClearLkhButtonStatus(); 
            // === AKHIR PERUBAHAN ===
          })
          .withFailureHandler(error => {
            // Ganti ID pesan
            displayMessage('lkh-action-message', 'Error: ' + error.message);
            button.disabled = false;
            button.querySelector('span').textContent = 'Ambil Data Mingguan';

            // === AWAL PERUBAHAN ===
            // Panggil update status untuk meng-evaluasi ulang tombol Bersihkan Data
            updateClearLkhButtonStatus();
            // === AKHIR PERUBAHAN ===
          })
          .getLKHWeeklyData(currentUser.email);
      }

      // === AWAL FUNGSI BARU UNTUK TOMBOL BERSIHKAN LKH ===

      /**
       * (BARU) Memeriksa apakah ada data di formulir LKH dan
       * memperbarui status (gaya dan disabled) tombol 'Bersihkan Data'.
       */
      function updateClearLkhButtonStatus() {
        const clearButton = document.getElementById('clear-lkh-data-button');
        if (!clearButton) return; // Keluar jika elemen tidak ditemukan

        // --- AWAL TAMBAHAN ---
        // Periksa kunci utama. Jika tombol Simpan nonaktif (karena terkunci),
        // maka tombol Bersihkan juga harus nonaktif.
        const saveButton = document.getElementById('save-lkh-button');
        if (saveButton && saveButton.disabled) {
            clearButton.disabled = true;
            clearButton.classList.remove('warning');
    
            // Pastikan kelas 'secondary' ada jika nonaktif
            if (!clearButton.classList.contains('secondary')) {
                clearButton.classList.add('secondary');
            }
            return; // Hentikan fungsi
        }
        // --- AKHIR TAMBAHAN ---

        const rows = document.querySelectorAll('#lkh-table-container tbody tr');
        let hasData = false;
        
        // Cek apakah ada data di textarea manapun
        // Gunakan 'for...of' agar bisa 'break' lebih awal
        for (const row of rows) {
          const textareas = row.querySelectorAll('textarea');
          for (const textarea of textareas) {
            if (textarea.value.trim() !== '') {
              hasData = true;
              break; // Keluar dari loop textarea
            }
          }
          if (hasData) break; // Keluar dari loop baris
        }

        if (hasData) {
          // Ada data: Buat tombol ORANGE dan AKTIF
          clearButton.disabled = false;
          clearButton.classList.remove('secondary'); // Hapus kelas abu-abu
          clearButton.classList.add('warning');    // Tambah kelas orange
        } else {
          // Tidak ada data: Buat tombol ABU-ABU dan NONAKTIF
          clearButton.disabled = true;
          clearButton.classList.remove('warning');    // Hapus kelas orange
          clearButton.classList.add('secondary'); // Tambah kelas abu-abu
        }
      }

      /**
       * (BARU) Dijalankan saat tombol 'Bersihkan Data' diklik.
       * Membersihkan semua textarea di LKH.
       */
      function handleClearLkhData() {
        openClearLkhModal();
      }

      // === AWAL FUNGSI BARU ===

      /**
       * (BARU) Membuka modal konfirmasi 'Bersihkan LKH'.
       */
      function openClearLkhModal() {
        document.getElementById('clear-lkh-modal').style.display = 'block';
      }

      /**
       * (BARU) Menutup modal konfirmasi 'Bersihkan LKH'.
       */
      function closeClearLkhModal() {
        document.getElementById('clear-lkh-modal').style.display = 'none';
      }

      /**
       * (BARU) Logika inti yang dijalankan setelah modal dikonfirmasi "Ya".
       */
      function confirmClearLkhData() {
        closeClearLkhModal(); // 1. Tutup modalnya
        
        // 2. Jalankan logika pembersihan (kode ini dipindah dari handleClearLkhData)
        const rows = document.querySelectorAll('#lkh-table-container tbody tr');
        let fieldsCleared = 0;

        rows.forEach(row => {
          const textareas = row.querySelectorAll('textarea');
          textareas.forEach(textarea => {
            if (textarea.value !== '') {
              textarea.value = '';
              fieldsCleared++;
            }
          });
        });

        if (fieldsCleared > 0) {
          // === GANTI ID PESAN DI SINI ===
          displayMessage('lkh-action-message', 'Semua data berhasil dibersihkan.', { isSuccess: true });
        } else {
          // === GANTI ID PESAN DI SINI ===
          displayMessage('lkh-action-message', 'Formulir sudah bersih.');
        }

        // 3. Perbarui status tombol
        updateClearLkhButtonStatus();
      }
      
      // === AKHIR FUNGSI BARU ===

      function handleClearLkhRow(event) {
        // Mencegah perilaku default dari tombol
        event.preventDefault();
        // Menemukan baris (tr) terdekat dari tombol yang diklik
        const row = event.target.closest('tr');
        // Menemukan semua elemen textarea di dalam baris tersebut
        const textareas = row.querySelectorAll('textarea');
        // Mengosongkan nilai dari setiap textarea
        textareas.forEach(textarea => {
          textarea.value = '';
        });
        updateClearLkhButtonStatus();
      }

      // --- FUNGSI BARU UNTUK RELOAD RINGKASAN ---
      function handleReloadAllTeacherSummary() {
        const monthInput = document.getElementById('all-teachers-summary-month-input');
        if (!monthInput.value) {
            alert("Silakan pilih bulan terlebih dahulu.");
            return;
        }
        const [year, month] = monthInput.value.split('-').map(Number);
        const container = document.getElementById('all-teachers-summary-table-container');

        // Tampilkan loading
        container.innerHTML = `
          <div class="loader-container">
            <div class="loader">
              <div class="ball"></div><div class="ball"></div><div class="ball"></div>
            </div>
            <p>Menghapus cache dan memuat ulang data...</p>
          </div>`;

        // 1. Panggil fungsi baru untuk hapus cache di server
        google.script.run
          .withSuccessHandler(response => {
            if (response.success) {
              // 2. Jika cache berhasil dihapus, panggil fungsi load data seperti biasa
              loadAllTeacherSummaryData();
            } else {
              // Jika gagal hapus cache, tetap coba load (mungkin error di server)
              loadAllTeacherSummaryData();
            }
          })
          .withFailureHandler(err => {
            // Jika gagal, tetap panggil load data
            loadAllTeacherSummaryData();
          })
          .clearSchoolSummaryCache(currentUser.email, selectedSchool, year, month);
      }
      
      /**
       * (MODIFIKASI) Dipanggil jika geolocation BERHASIL.
       * Mengatur variabel 'isUserInLocation' (untuk kuncian) berdasarkan status GeoEnabled.
       */
      function handleGeoSuccess(position) {
        const userLat = position.coords.latitude;
        const userLon = position.coords.longitude;

        const schoolLat = currentSchoolSettings.lat;
        const schoolLon = currentSchoolSettings.lon;
        const schoolRadius = currentSchoolSettings.radius;

        const isGeoActive = currentSchoolSettings.geoEnabled === true;

        if (schoolLat == null || schoolLon == null) {
            // Pengaturan sekolah tidak lengkap
            isUserInLocation = !isGeoActive; // true jika nonaktif, false jika aktif
            updateGeoStatusUI(null, { message: "Pengaturan lokasi (Lat/Lon) untuk sekolah ini belum lengkap." });
            return;
        }

        // Hitung jarak
        const distance = calculateDistance(userLat, userLon, schoolLat, schoolLon);
        const realUserInLocation = (distance <= schoolRadius);

        // === KUNCI UNTUK KUNCIA/BUKA CEKLOK ===
        // Jika geo aktif, gunakan status lokasi asli.
        // Jika geo nonaktif, PAKSA jadi 'true' (selalu di dalam lokasi / tidak terkunci).
        isUserInLocation = isGeoActive ? realUserInLocation : true;

        // Kirim jarak asli ke UI
        updateGeoStatusUI(distance, null); 
      }
      
      /**
       * (MODIFIKASI) Dipanggil jika geolocation GAGAL.
       * Mengatur variabel 'isUserInLocation' (untuk kuncian) berdasarkan status GeoEnabled.
       */
      function handleGeoError(error) {
        const isGeoActive = currentSchoolSettings.geoEnabled === true;

        // === KUNCI UNTUK KUNCIA/BUKA CEKLOK ===
        // Jika geo aktif, status jadi 'false' (terkunci).
        // Jika geo nonaktif, PAKSA jadi 'true' (tidak terkunci).
        isUserInLocation = !isGeoActive; 

        updateGeoStatusUI(null, error); // Kirim error ke UI
      }

      /**
       * (BARU) Memperbarui kotak status lokasi di DASBOR.
       * (DIMODIFIKASI untuk menampilkan status HIJAU saat geoDisabled)
       */
      function updateGeoStatusUI(distance, error) {
          const statusBox = document.getElementById('geo-status-box');
          if (!statusBox) return; // Keluar jika elemen tidak ada

          const msgEl = document.getElementById('geo-status-message');
          const detailsEl = document.getElementById('geo-status-details');
          const refreshBtn = document.getElementById('refresh-geo-button');

          const radius = currentSchoolSettings.radius || 0;
          const isGeoActive = currentSchoolSettings.geoEnabled === true; // Ambil status dari global

          refreshBtn.style.display = 'flex'; // Selalu tampilkan tombol refresh

          if (error) {
              // Kasus 1: Gagal (GPS error, Izin ditolak, dll)
              statusBox.className = isGeoActive ? 'card-section danger' : 'card-section success'; // Merah jika aktif, Hijau jika nonaktif
              msgEl.innerText = isGeoActive ? 'Lokasi Gagal Diverifikasi' : 'Gagal Verifikasi (Nonaktif)';

              let errorMsg = "Gagal mendapatkan lokasi.";
              if (error.code) {
                  switch(error.code) {
                      case error.PERMISSION_DENIED: errorMsg = "Izin lokasi ditolak. Aktifkan di setelan browser."; break;
                      case error.POSITION_UNAVAILABLE: errorMsg = "Sinyal lokasi tidak tersedia. Coba lagi."; break;
                      case error.TIMEOUT: errorMsg = "Waktu verifikasi habis. Coba lagi."; break;
                      default: errorMsg = error.message || errorMsg;
                  }
              } else {
                  errorMsg = error.message || errorMsg; // Handle error non-GPS
              }

              detailsEl.innerText = isGeoActive ? errorMsg : `${errorMsg} Ceklok tetap dibuka.`;

          } else if (distance !== null) {
              // Kasus 2: Sukses mendapat lokasi, sekarang cek jarak
              const realUserInLocation = (distance <= radius);

              if (realUserInLocation) {
                  // 2a: Di Dalam Jangkauan (Selalu Hijau, sudah benar)
                  statusBox.className = 'card-section success';
                  msgEl.innerText = 'Anda Berada di Lokasi';
                  detailsEl.innerText = `Jarak: ${distance.toFixed(0)} m (Radius: ${radius} m) dari titik lokasi sekolah. Ceklok dibuka.`;
              } else {
                  // 2b: Di Luar Jangkauan
                  const distanceKm = (distance / 1000).toFixed(2);

                  // INI LOGIKA BARU ANDA:
                  statusBox.className = isGeoActive ? 'card-section danger' : 'card-section success'; // Merah jika aktif, HIJAU jika nonaktif
                  msgEl.innerText = isGeoActive ? 'Anda di Luar Jangkauan' : 'Anda di Luar Jangkauan (Nonaktif)';
                  detailsEl.innerText = isGeoActive ? 
                      `Jarak: ${distanceKm} km (Radius: ${radius} m) dari titik lokasi sekolah. Ceklok hari ini dikunci.` : 
                      `Jarak: ${distanceKm} km (Radius: ${radius} m) dari titik lokasi sekolah. Ceklok tetap dibuka.`; // Pesan berbeda
              }
          }

          // --- AWAL PERUBAHAN (Cooldown Tombol Refresh) ---
          // (Logika ini tidak berubah)
          setTimeout(() => {
            if(refreshBtn) {
              refreshBtn.disabled = false; 
            }
          }, 5000); // 5000ms = 5 detik
          // --- AKHIR PERUBAHAN ---
      }

      /**
       * (BARU) Rumus Haversine untuk menghitung jarak antara 2 titik lat/lon.
       * Mengembalikan jarak dalam METER.
       */
      function calculateDistance(lat1, lon1, lat2, lon2) {
          const R = 6371e3; // Radius bumi dalam meter
          const 1 = lat1 * Math.PI/180; // ,  in radians
          const 2 = lat2 * Math.PI/180;
          const  = (lat2-lat1) * Math.PI/180;
          const  = (lon2-lon1) * Math.PI/180;

          const a = Math.sin(/2) * Math.sin(/2) +
                    Math.cos(1) * Math.cos(2) *
                    Math.sin(/2) * Math.sin(/2);
          const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));

          const d = R * c; // dalam meter
          return d;
      }

      /**
       * (MODIFIKASI) Fungsi ini sekarang memanggil getDashboardStatus
       */
      function runDashboardGeoCheck() {
          if (!currentUser) return; 

          const statusBox = document.getElementById('geo-status-box');
          if (!statusBox) return; 

          statusBox.style.display = 'block';
          statusBox.className = 'card-section processing';
          document.getElementById('geo-status-message').innerText = 'Memperbarui pengaturan...';
          document.getElementById('geo-status-details').innerText = 'Mengambil setelan geo-lock terbaru...';
          document.getElementById('refresh-geo-button').disabled = true;

          google.script.run
              .withSuccessHandler(response => {
                  
                  if (response && response.error) {
                      handleGeoError({ code: -1, message: "Gagal mengambil pengaturan: " + response.error });
                      return;
                  }
                  
                  // --- AWAL PERUBAHAN: Simpan semua pengaturan ---
                  currentSchoolSettings = response.schoolSettings || {};
                  dashboardTimestamp = response.updateTimestamp || '0';
                  
                  // Simpan batas hari global dari server ke appSettings
                  // (Ini adalah perbaikan agar batas hari LKH/Ceklok tersedia sebelum halaman LKH/Ceklok dibuka)
                  appSettings.lastMonthCeklokDayLimit = response.lastMonthCeklokDayLimit;
                  appSettings.requestDayLimit = response.requestDayLimit;
                  appSettings.lkhLastDayLimit = response.lkhLastDayLimit; 
                  // --- AKHIR PERUBAHAN ---

                  runPrimaryGeoCheck(); 
              })
              .withFailureHandler(error => {
                  handleGeoError({ code: -1, message: "Error server: " + error.message });
              })
              .getDashboardStatus(currentUser.email, selectedSchool); 
      }

      // [NAMA DIGANTI & DIMODIFIKASI] Fungsi ini (sebelumnya runFallbackGeoCheck)
      // sekarang menjadi Pengecekan Prioritas 1 (High Accuracy)
      // --- PERUBAHAN BESAR: HAPUS SEMUA 'google.script.run' DARI SINI ---
      function runPrimaryGeoCheck() {
          
          // Langsung ke pengecekan GPS
          document.getElementById('geo-status-message').innerText = 'Sedang memverifikasi lokasi Anda...';
          document.getElementById('geo-status-details').innerText = 'Prioritas 1: Menggunakan GPS (Akurasi Tinggi)...';

          if ("geolocation" in navigator) {
              navigator.geolocation.getCurrentPosition(
                  handleGeoSuccess, // Sukses: Panggil handleGeoSuccess
                  runFallbackGeoCheck, // GAGAL: Panggil FALLBACK (Prioritas 2)
                  {
                      enableHighAccuracy: true, // Prioritas 1
                      timeout: 20000, // Timeout 20 detik untuk GPS
                      maximumAge: 0  
                  }
              );
          } else {
              // Kirim error buatan jika browser tidak support
              handleGeoError({ code: -1, message: "Browser tidak mendukung Geolocation." });
          }
      }

      // [FUNGSI BARU] Ini adalah Pengecekan Prioritas 2 (Low Accuracy)
      // Dipanggil HANYA JIKA runPrimaryGeoCheck gagal.
      function runFallbackGeoCheck(error) {
          // Log error dari Pri-1
          console.warn(`Pengecekan Akurasi Tinggi (GPS) gagal (${error.message}). Memulai Pengecekan Fallback (WiFi/Seluler).`);

          // Update UI untuk memberitahu user
          document.getElementById('geo-status-message').innerText = 'Verifikasi GPS Gagal...';
          document.getElementById('geo-status-details').innerText = 'Prioritas 2: Mencoba via WiFi/Seluler (Akurasi Rendah)...';

          // Panggil Geolocation lagi dengan akurasi rendah
          navigator.geolocation.getCurrentPosition(
              handleGeoSuccess, // Sukses: Panggil handleGeoSuccess
              handleGeoError,   // GAGAL: Panggil handleGeoError (Final)
              {
                  enableHighAccuracy: false, // Prioritas 2
                  timeout: 10000, // Timeout 10 detik
                  maximumAge: 0
              }
          );
      }

      /**
       * (MODIFIKASI) Polling cepat untuk memeriksa "bendera" pembaruan.
       */
      function startSettingsPolling() {
        // Hentikan polling lama jika ada
        if (settingsPollInterval) {
          clearInterval(settingsPollInterval);
          settingsPollInterval = null;
        }

        // Mulai polling baru setiap 7 detik (7000 ms)
        settingsPollInterval = setInterval(() => {
          
          const isGuruDashboard = document.getElementById('guru-dashboard-container').style.display === 'block';
          const isStaffDashboard = document.getElementById('staff-dashboard-container').style.display === 'block';
          
          if (!currentUser || !selectedSchool || (!isGuruDashboard && !isStaffDashboard)) {
            clearInterval(settingsPollInterval);
            settingsPollInterval = null;
            return;
          }

          // 2. Panggil fungsi server super ringan 'checkUpdateFlag'
          // Kirim timestamp "versi" kita saat ini
          google.script.run
            .withSuccessHandler(response => {
              if (response.updateAvailable) {
                // Server bilang ada update!
                console.log("Pembaruan terdeteksi. Menampilkan tombol refresh.");
                
                // Simpan timestamp baru (agar kita tidak bertanya lagi)
                dashboardTimestamp = response.newTimestamp; 
                
                const guruBtn = document.getElementById('refresh-dashboard-button');
                const staffBtn = document.getElementById('refresh-staff-dashboard-button');
                
                // Tampilkan tombol yang sesuai
                if (isGuruDashboard && guruBtn) guruBtn.style.display = 'flex';
                if (isStaffDashboard && staffBtn) staffBtn.style.display = 'flex';
                
                // Hentikan polling
                if (settingsPollInterval) {
                    clearInterval(settingsPollInterval);
                    settingsPollInterval = null;
                    console.log("Polling dihentikan. Menunggu refresh manual.");
                }
              }
              // Jika response.updateAvailable false, tidak terjadi apa-apa
              // Polling akan lanjut 7 detik lagi
            })
            .withFailureHandler(err => {
              // Jika polling gagal, hentikan agar tidak error terus-menerus
              console.error("Gagal polling (checkUpdateFlag): ", err.message);
              if (settingsPollInterval) {
                 clearInterval(settingsPollInterval);
                 settingsPollInterval = null;
              }
            })
            .checkUpdateFlag(dashboardTimestamp); // Kirim 'versi' kita saat ini

        }, 7000); // Poll setiap 7 detik
      }

      /**
       * (BARU) Fungsi helper untuk membandingkan dua objek pengaturan.
       * @return {boolean} true jika ada perbedaan, false jika sama.
       */
      function hasSettingsChanged(oldSettings, newSettings) {
        if (!oldSettings || !newSettings) return true; // Anggap berubah jika salah satu tidak ada

        return (
          oldSettings.geoEnabled !== newSettings.geoEnabled ||
          oldSettings.lat !== newSettings.lat ||
          oldSettings.lon !== newSettings.lon ||
          oldSettings.radius !== newSettings.radius
        );
      }

      // [MODIFIKASI] refreshGeoUI juga harus menggunakan logika 2-langkah
      function refreshGeoUI() {
          console.log("Pengaturan berubah. Menjalankan ulang pemeriksaan lokasi...");

          const statusBox = document.getElementById('geo-status-box');
          if (!statusBox || document.getElementById('guru-dashboard-container').style.display !== 'block') {
              return; // Hanya berjalan jika di dasbor guru
          }
          
          // 1. Set UI ke status loading
          statusBox.className = 'card-section processing';
          document.getElementById('geo-status-message').innerText = 'Memverifikasi ulang lokasi...';
          document.getElementById('geo-status-details').innerText = 'Prioritas 1: Menggunakan GPS (Akurasi Tinggi)...'; // Update teks
          document.getElementById('refresh-geo-button').disabled = true; // Nonaktifkan tombol refresh saat sedang refresh

          // 2. Jalankan pengecekan GPS (Prioritas 1)
          if ("geolocation" in navigator) {
              navigator.geolocation.getCurrentPosition(
                  handleGeoSuccess, // Sukses: Panggil handleGeoSuccess
                  runFallbackGeoCheck, // GAGAL: Panggil FALLBACK (Prioritas 2)
                  {
                      enableHighAccuracy: true, // Prioritas 1
                      timeout: 20000, // Timeout 20 detik
                      maximumAge: 0  
                  }
              );
          } else {
              handleGeoError({ code: -1, message: "Browser tidak mendukung Geolocation." });
          }
      }

      // --- FUNGSI BARU ---
      /**
       * (BARU) Dipanggil oleh polling HANYA jika timestamp pengumuman berubah.
       * Mengambil teks pengumuman terbaru dan me-render ulang.
       */
      function fetchLatestAnnouncements() {
        // Tampilkan toast "processing"
        displayMessage(null, "Memuat pengumuman baru...", { isProcessing: true });
        
        google.script.run
          .withSuccessHandler(newAnnouncementText => {
            
            // 1. Simpan ke cache
            cachedAnnouncements = newAnnouncementText;
            
            // 2. Render ulang di dasbor yang aktif
            const isGuruDashboard = document.getElementById('guru-dashboard-container').style.display === 'block';
            const isStaffDashboard = document.getElementById('staff-dashboard-container').style.display === 'block';
            
            if (isGuruDashboard) {
              // --- AWAL PERUBAHAN ---
              // Panggil fungsi dinamis untuk mengevaluasi ulang
              // (kirim appSettings global dan currentSummary global)
              renderDynamicAnnouncements(appSettings, currentSummary);
              // --- AKHIR PERUBAHAN ---
            } else if (isStaffDashboard) {
              const staffAnnounceP = document.getElementById('staff-announcement-text');
              staffAnnounceP.innerText = (cachedAnnouncements && cachedAnnouncements.trim() !== "") ? cachedAnnouncements : "Tidak ada pengumuman saat ini.";
            }
            
            // 3. Tampilkan toast sukses
            displayMessage(null, "Pengumuman telah diperbarui.", { isSuccess: true });
          })
          .withFailureHandler(err => {
            displayMessage(null, "Gagal memuat pengumuman baru.");
            console.error("Error fetchLatestAnnouncements:", err.message);
          })
          .getLatestAnnouncements(); // Panggil fungsi server baru
      }
      // --- AKHIR FUNGSI BARU ---

      // --- TAMBAHAN BARU: Logika Pengingat Ceklok ---
      /**
       * (MODIFIKASI) Mengatur kotak pengumuman berdasarkan prioritas:
       * 1. Pengingat Awal Bulan (Tgl 1 s/d graceLimit)
       * 2. Pengingat Ajuan (Tgl graceLimit+1 s/d requestLimit)
       * 3. Pengingat Akhir Bulan (H-7 s/d H-0)
       * 4. Pengumuman Standar
       * * @param {object} settings - Objek appSettings global
       * @param {object} summary - Objek currentSummary global
       */
      function renderDynamicAnnouncements(settings, summary) {
          const announceBox = document.getElementById('announcement-section');
          if (!announceBox) return; // Keluar jika tidak di dasbor guru
          
          const announceTitle = announceBox.querySelector('h3');
          const announceText = announceBox.querySelector('p');
          
          // --- Fungsi Helper untuk kembali ke pengumuman standar ---
          const setDefaultAnnouncement = () => {
              announceBox.className = 'announcement-info'; // Kelas CSS biru
              announceBox.style.cursor = 'default';
              announceBox.onclick = null;
              announceTitle.innerHTML = '<i class="fa-solid fa-bullhorn"></i> Pengumuman';
              announceText.innerText = (cachedAnnouncements && cachedAnnouncements.trim() !== "") ? cachedAnnouncements : "Tidak ada pengumuman saat ini.";
          };

          // --- Kumpulkan Data Tanggal & Pengaturan ---
          if (!settings) { // Fallback jika settings belum dimuat
            setDefaultAnnouncement();
            return;
          }

          const today = new Date();
          const currentDay = today.getDate();
          const lastDayOfMonth = new Date(today.getFullYear(), today.getMonth() + 1, 0).getDate();
          const remainingDays = lastDayOfMonth - currentDay; // 0 = hari terakhir

          const lastMonthDate = new Date(today);
          lastMonthDate.setMonth(today.getMonth() - 1);
          const lastMonthName = lastMonthDate.toLocaleDateString('id-ID', { month: 'long' });

          // Kode yang BENAR
          const graceLimit = settings.lastMonthCeklokDayLimit ?? 5;
          const requestLimit = settings.requestDayLimit ?? 10;

          // ==========================================================
          // LOGIKA 1: Pengingat Ceklok Awal Bulan (Tgl 1 s/d `graceLimit`)
          // ==========================================================
          if (currentDay >= 1 && currentDay <= graceLimit) {
              
              // --- AWAL PERUBAHAN ---
              // Buat objek tanggal untuk hari H batas pengisian
              const deadlineDate = new Date(today.getFullYear(), today.getMonth(), graceLimit);
              // Format menjadi "2 November 2025"
              const formattedDeadline = deadlineDate.toLocaleDateString('id-ID', {
                  day: 'numeric',
                  month: 'long',
                  year: 'numeric'
              });
              // --- AKHIR PERUBAHAN ---

              announceBox.className = 'announcement-warning'; // Kuning
              announceBox.style.cursor = 'pointer';
              announceTitle.innerHTML = '<i class="fa-solid fa-hourglass-start"></i> Pengingat Pengisian Ceklok';
              
              // --- GANTI BARIS DI BAWAH INI ---
              announceText.innerHTML = `Pengisian ceklok bulan <strong>${lastMonthName}</strong> masih dibuka sampai tanggal <strong>${formattedDeadline}</strong>. Klik di sini untuk melengkapi.`;
              // --- AKHIR PENGGANTIAN ---
              
              announceBox.onclick = () => {
                  currentDate = lastMonthDate; // Set tanggal global ke bulan lalu
                  showCeklokPage();
              };
              return; // Prioritas 1: Selesai
          }

          // ==========================================================
          // LOGIKA 2: Pengingat Pengajuan Perubahan (Tgl `graceLimit`+1 s/d `requestLimit`)
          // ==========================================================
          if (currentDay > graceLimit && currentDay <= requestLimit) {
              
              // --- AWAL PERUBAHAN (Tambahkan juga di sini agar konsisten) ---
              const requestDeadlineDate = new Date(today.getFullYear(), today.getMonth(), requestLimit);
              const formattedRequestDeadline = requestDeadlineDate.toLocaleDateString('id-ID', {
                  day: 'numeric',
                  month: 'long',
                  year: 'numeric'
              });
              // --- AKHIR PERUBAHAN ---
              
              announceBox.className = 'announcement-warning'; // Kuning
              announceBox.style.cursor = 'pointer';
              announceTitle.innerHTML = '<i class="fa-solid fa-file-circle-question"></i> Pengajuan Perubahan Data';
              
              // --- GANTI BARIS DI BAWAH INI ---
              announceText.innerHTML = `Pengisian ceklok ${lastMonthName} sudah ditutup. Mode <strong>Pengajuan Perubahan Data</strong> dibuka sampai tanggal <strong>${formattedRequestDeadline}</strong>. Klik di sini untuk mengajukan.`;
              // --- AKHIR PENGGANTIAN ---
              
              announceBox.onclick = () => {
                  currentDate = lastMonthDate; // Set tanggal global ke bulan lalu
                  showCeklokPage();
              };
              return; // Prioritas 2: Selesai
          }

          // ==========================================================
          // LOGIKA 3: Pengingat Ceklok Akhir Bulan (H-7 s/d H-0)
          // ==========================================================
          
          // Cek apakah summary yang aktif adalah untuk bulan berjalan
          const summaryMonthInput = document.getElementById('summary-month-input').value;
          if (!summaryMonthInput) { // Jika input belum siap
              setDefaultAnnouncement(); // Tampilkan default
              return;
          }
          const [summaryYear, summaryMonth] = summaryMonthInput.split('-').map(Number);
          const isSummaryForCurrentMonth = (today.getFullYear() === summaryYear && (today.getMonth() + 1) === summaryMonth);

          // Cek jika: Ini ringkasan bulan ini, H-7 s/d H-0, DAN persentase < 100%
          if (isSummaryForCurrentMonth && summary && summary.persentase < 100 && remainingDays >= 0 && remainingDays <= 7) {
              
              let statusClass = (remainingDays <= 3) ? 'announcement-danger' : 'announcement-warning'; // Merah atau Kuning
              let messageText = (remainingDays === 0) ? 'Hari Terakhir Pengisian Ceklok!' : `Sisa ${remainingDays} Hari Pengisian Ceklok`;
              
              announceBox.className = statusClass;
              announceBox.style.cursor = 'pointer';
              announceTitle.innerHTML = '<i class="fa-solid fa-triangle-exclamation"></i> Pengingat Ceklok Akhir Bulan';
              announceText.innerHTML = `<strong>${messageText}</strong> Kehadiran Anda bulan ini masih ${summary.persentase}%. Klik di sini untuk melengkapi.`;
              
              announceBox.onclick = () => {
                  currentDate = today; // Set tanggal global ke bulan ini
                  showCeklokPage();
              };
              return; // Prioritas 3: Selesai
          }

          // ==========================================================
          // LOGIKA 4: Default (Pengumuman Standar)
          // ==========================================================
          setDefaultAnnouncement();
      }

      // --- FUNGSI BARU UNTUK ADMIN: Menyimpan batas hari pengisian bulan lalu ---
      function saveLastMonthCeklokLimit() {
        const dayLimit = document.getElementById('last-month-ceklok-day-limit').value;
        displayMessage('last-month-ceklok-message', 'Menyimpan...', { isProcessing: true });
        google.script.run
          .withSuccessHandler(r => {
            displayMessage('last-month-ceklok-message', r.message, { isSuccess: r.status === 'success' });
          })
          .saveLastMonthCeklokLimit(currentUser.email, dayLimit); // <-- Panggil fungsi di Kode.gs
      }
      // --- AKHIR FUNGSI BARU ---

      // --- FUNGSI BARU UNTUK ADMIN (LKH) ---
      function saveLkhLastDayLimit() {
        const dayLimit = document.getElementById('lkh-last-day-limit').value;
        displayMessage('lkh-last-day-message', 'Menyimpan...', { isProcessing: true });
        google.script.run
          .withSuccessHandler(r => {
            displayMessage('lkh-last-day-message', r.message, { isSuccess: r.status === 'success' });
          })
          .saveLkhLastDayLimit(currentUser.email, dayLimit); // <-- Panggil fungsi di Kode.gs
      }
      // --- AKHIR FUNGSI BARU ---

      /**
       * (MODIFIKASI) Dipanggil oleh tombol "Update" (LKH) atau "Refresh" (Dasbor).
       * @param {Event} event Objek event klik (bisa null jika dipanggil dari LKH).
       * @param {string} buttonId ID tombol yang diklik.
       */
      function forceUpdateSettings(event, buttonId) {
        
        if (event) {
            event.stopPropagation();
        }

        const lkhContainer = document.getElementById('lkh-container');

        // Bagian UI Loading LKH (Tidak berubah, sudah benar)
        if (lkhContainer.style.display === 'block') {
            const lkhMonthInput = document.getElementById('lkh-month-input');
            const applyWeeklyButton = document.getElementById('apply-weekly-data-button');
            const clearButton = document.getElementById('clear-lkh-data-button');
            const saveButton = document.getElementById('save-lkh-button');
            
            if (lkhMonthInput) lkhMonthInput.disabled = true;
            if (applyWeeklyButton) applyWeeklyButton.disabled = true;
            if (clearButton) clearButton.disabled = true;
            if (saveButton) saveButton.disabled = true;
            
            const tableContainer = document.getElementById('lkh-table-container');
            if (tableContainer) {
                tableContainer.innerHTML = `
                  <div class="loader-container">
                    <div class="loader"><div class="ball"></div><div class="ball"></div><div class="ball"></div></div>
                    <p>Memperbarui pengaturan tanggal...</p>
                  </div>`;
            }
            
            displayMessage('lkh-action-message', '');
            const lockMessageEl = document.getElementById('lkh-lock-message');
            if (lockMessageEl) {
              lockMessageEl.innerText = "";
              lockMessageEl.className = "message";
            }
        }

        if (!currentUser || !selectedSchool) {
          displayMessage(null, "Gagal: Sesi pengguna tidak ditemukan.");
          return;
        }
        
        let buttonToDisable = null;
        if (buttonId) {
            buttonToDisable = document.getElementById(buttonId);
        } else {
            buttonToDisable = document.getElementById('update-settings-button'); 
        }
        
        if (buttonToDisable) {
          buttonToDisable.disabled = true; 
        }
        
        if (lkhContainer.style.display !== 'block') {
          displayMessage(null, "Memperbarui setelan & pengumuman...", { isProcessing: true });
        }
        
        // Pemanggilan clear cache (Tidak berubah, sudah benar)
        google.script.run
          .withFailureHandler(err => console.error("Gagal hapus cache global:", err.message))
          .clearGlobalSettingsCache();
          
        google.script.run
          .withFailureHandler(err => console.error("Gagal hapus cache lokasi:", err.message))
          .clearSchoolSettingsCacheManual(localStorage.getItem('ceklokAuthToken')); 

        if (lkhContainer.style.display === 'block') {
          const lkhMonthInput = document.getElementById('lkh-month-input').value;
          if (lkhMonthInput) { // Hanya hapus cache jika bulan sudah terisi
            const [year, month] = lkhMonthInput.split('-').map(Number);
            google.script.run
              .withFailureHandler(err => console.error("Gagal hapus cache LKH:", err.message))
              .clearLkhCacheForUser(currentUser.email, selectedSchool, year, month);
          }
        }

        // Ambil Data Baru (setelah cache dihapus)
        google.script.run
          .withSuccessHandler(response => {
            if (buttonToDisable) {
              buttonToDisable.disabled = false; 
            }

            if (response.success) {
              if (buttonToDisable && (buttonId === 'refresh-dashboard-button' || buttonId === 'refresh-staff-dashboard-button')) {
                  buttonToDisable.style.display = 'none'; 
              }
              
              const newGeoSettings = response.schoolSettings;
              if (hasSettingsChanged(currentSchoolSettings, newGeoSettings)) {
                currentSchoolSettings = newGeoSettings;
                if (document.getElementById('guru-dashboard-container').style.display === 'block') {
                  refreshGeoUI(); 
                }
              }
              
              // Simpan SEMUA pengaturan global terbaru ke appSettings
              appSettings.lastMonthCeklokDayLimit = response.lastMonthCeklokDayLimit;
              appSettings.lkhLastDayLimit = response.lkhLastDayLimit; // <-- PENTING: Nilai baru (cth: 0) disimpan di sini
              appSettings.requestDayLimit = response.requestDayLimit;
              
              fetchLatestAnnouncements(); 

              if (document.getElementById('guru-dashboard-container').style.display === 'block') {
                 renderDynamicAnnouncements(appSettings, currentSummary);
              }
              
              // --- AWAL PERUBAHAN UTAMA ---
              if (lkhContainer.style.display === 'block') {
                const lkhMonthInput = document.getElementById('lkh-month-input');
                if (lkhMonthInput) lkhMonthInput.disabled = false;
                
                // Cek jika input bulan KOSONG (karena kita kosongkan di showLkhPage)
                if (lkhMonthInput && !lkhMonthInput.value) {
                  
                  // --- Logika Perhitungan Tanggal Default (Dipindah ke sini) ---
                  const today = new Date();
                  const currentDay = today.getDate(); // Cth: 2
                  
                  // Ambil batas hari LKH dari appSettings yang BARU SAJA DIPERBARUI
                  const lkhLimit = parseInt(appSettings.lkhLastDayLimit, 10);
                  const gracePeriodLimit = isNaN(lkhLimit) ? 5 : lkhLimit; // cth: 0
                  
                  const targetDate = new Date();
                  
                  // Cek: (limit=0 > 0) -> false. Blok ini di-skip.
                  // Jika limit=5 dan tgl=2: (5 > 0 && 2 <= 5) -> true.
                  if (gracePeriodLimit > 0 && currentDay <= gracePeriodLimit) {
                      // Buka bulan lalu
                      targetDate.setMonth(targetDate.getMonth() - 1);
                  }
                  
                  // Jika limit=0, targetDate akan tetap bulan berjalan (November)
                  const year = targetDate.getFullYear();
                  const month = String(targetDate.getMonth() + 1).padStart(2, '0');
                  lkhMonthInput.value = `${year}-${month}`; // Input diisi '2025-11'
                  // --- Akhir Logika Perhitungan Tanggal ---
                }

                // Panggil handleLkhMonthChange. Sekarang inputnya
                // sudah diisi dengan tanggal default yang benar ('2025-11').
                handleLkhMonthChange(); 
              }
              // --- AKHIR PERUBAHAN UTAMA ---
              
              dashboardTimestamp = response.updateTimestamp || '0'; 
              startSettingsPolling(); 

            } else {
              displayMessage(null, `Gagal memperbarui: ${response.error || 'Kesalahan server'}`);
              if (buttonToDisable && (buttonId === 'refresh-dashboard-button' || buttonId === 'refresh-staff-dashboard-button')) {
                 buttonToDisable.style.display = 'flex'; 
              }
            }
          })
          .withFailureHandler(err => {
            if (buttonToDisable) {
              buttonToDisable.disabled = false;
              if (buttonId === 'refresh-dashboard-button' || buttonId === 'refresh-staff-dashboard-button') {
                 buttonToDisable.style.display = 'flex';
              }
            }
            displayMessage(null, `Gagal: ${err.message}`);
          })
          .getDashboardStatus(currentUser.email, selectedSchool);
      }

    </script>
  </body>
</html>
